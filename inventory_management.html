<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>庫存管理系統 - G茶餐酒館</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* 標題區域 */
    .header { background: #2d2320; color: #e0b873; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 1.8em; }
    .nav-buttons { display: flex; gap: 10px; }
    .nav-btn { padding: 8px 16px; background: #e0b873; color: #2d2320; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-decoration: none; }
    .nav-btn:hover { background: #d4a862; }
    
    /* 統計卡片 */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .stat-card.warning { border-left: 4px solid #f44336; }
    .stat-card.success { border-left: 4px solid #4CAF50; }
    .stat-card.info { border-left: 4px solid #2196F3; }
    .stat-value { font-size: 2em; font-weight: bold; margin: 10px 0; }
    .stat-label { color: #666; font-size: 0.9em; }
    
    /* 主要內容區域 */
    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .section h2 { margin: 0 0 15px 0; color: #2d2320; border-bottom: 2px solid #e0b873; padding-bottom: 10px; }
    
    /* 表格樣式 */
    .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .table th { background: #f8f8f8; font-weight: bold; color: #2d2320; }
    .table tr:hover { background: #f9f9f9; }
    .table tr.low-stock { background: #ffebee; }
    .table tr.out-of-stock { background: #ffcdd2; }
    
    /* 按鈕樣式 */
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 2px; }
    .btn-primary { background: #2196F3; color: white; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-warning { background: #FF9800; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn:hover { opacity: 0.8; }
    
    /* 表單樣式 */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2d2320; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    
    /* 彈出視窗 */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); animation: fadeIn 0.3s ease; }
    .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e0b873; padding-bottom: 15px; }
    .modal-header h3 { margin: 0; color: #2d2320; }
    .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease; }
    .close:hover { color: #2d2320; }
    
    /* Modal 動畫 */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* 按鈕樣式增強 */
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    
    /* 警告提醒 */
    .alert { padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    
    /* 圖表容器 */
    .chart-container { height: 300px; margin: 20px 0; }
    
    /* 響應式設計 */
    @media (max-width: 768px) {
      .main-content { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 15px; }
      .nav-buttons { flex-wrap: wrap; justify-content: center; }
    }
  </style>
</head>
<body>
  <!-- 登入區域 -->
  <div class="container" id="authContainer" style="display:none;max-width:400px;margin:100px auto;">
    <div class="section">
      <h2>庫存管理登入</h2>
      <div class="form-group">
        <input type="email" id="authEmail" placeholder="Email" />
      </div>
      <div class="form-group">
        <input type="password" id="authPassword" placeholder="密碼" />
      </div>
      <button id="authLoginBtn" class="btn btn-primary" style="width:100%;">登入</button>
      <div id="authMsg" style="color:#f44336;margin-top:15px;text-align:center;"></div>
    </div>
  </div>

  <!-- 主要內容 -->
  <div class="container" id="mainContainer" style="display:none;">
    <div class="header">
      <h1>📦 庫存管理系統</h1>
      <div class="nav-buttons">
        <a href="kitchen_orders.html" class="nav-btn">🍳 廚房看板</a>
        <a href="daily_report.html" class="nav-btn">📊 日結帳</a>
        <a href="analytics.html" class="nav-btn">📊 情報分析</a>
        <a href="system_settings.html" class="nav-btn">⚙️ 系統設定</a>
        <button class="nav-btn" onclick="logout()">登出</button>
      </div>
    </div>

    <!-- 統計卡片 -->
    <div class="stats-grid">
      <div class="stat-card warning">
        <div class="stat-value" id="lowStockCount">0</div>
        <div class="stat-label">低庫存商品</div>
      </div>
      <div class="stat-card info">
        <div class="stat-value" id="totalItems">0</div>
        <div class="stat-label">總商品數</div>
      </div>
      <div class="stat-card success">
        <div class="stat-value" id="totalValue">$0</div>
        <div class="stat-label">庫存總價值</div>
      </div>
      <div class="stat-card info">
        <div class="stat-value" id="todayUsage">0</div>
        <div class="stat-label">今日消耗</div>
      </div>
    </div>

    <!-- 警告提醒 -->
    <div id="alertsContainer"></div>

    <!-- 主要內容區域 -->
    <div class="main-content">
      <!-- 庫存列表 -->
      <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2>原料庫存</h2>
          <div>
            <button class="btn btn-success" onclick="openBatchPurchaseModal()">📦 批量進貨</button>
            <button class="btn btn-primary" onclick="openAddItemModal()" style="margin-left: 10px;">➕ 新增原料</button>
          </div>
        </div>
        <div id="inventoryList">
          <div style="text-align: center; color: #666; padding: 20px;">載入中...</div>
        </div>
      </div>

      <!-- 成本分析 -->
      <div class="section">
        <h2>成本分析</h2>
        <div class="form-group">
          <label>分析期間：</label>
          <div class="form-row">
            <input type="date" id="analysisStartDate" />
            <input type="date" id="analysisEndDate" />
          </div>
          <button class="btn btn-primary" onclick="generateCostAnalysis()" style="margin-top: 10px;">生成分析</button>
        </div>
        <div id="costAnalysisResult">
          <div style="text-align: center; color: #666; padding: 20px;">請選擇日期範圍並生成分析</div>
        </div>
      </div>
    </div>

    <!-- 補貨提醒 -->
    <div class="section" style="margin-top: 20px;">
      <h2>📋 補貨建議</h2>
      <div id="restockSuggestions">
        <div style="text-align: center; color: #666; padding: 20px;">載入中...</div>
      </div>
    </div>

    <!-- 自動扣減記錄 -->
    <div class="section" style="margin-top: 20px;">
      <h2>🔄 自動扣減記錄</h2>
      <div style="margin-bottom: 15px;">
        <button class="btn btn-primary" onclick="loadDeductionHistory()">重新整理</button>
        <button class="btn btn-success" onclick="reloadAutoDeductionSystem()" style="margin-left: 10px;">重啟自動扣減</button>
        <span id="deductionStatus" style="margin-left: 15px; color: #666;"></span>
      </div>
      <div id="deductionHistory">
        <div style="text-align: center; color: #666; padding: 20px;">載入中...</div>
      </div>
    </div>
  </div>

  <!-- 新增/編輯原料彈出視窗 -->
  <div id="itemModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">新增原料</h3>
        <span class="close" onclick="closeItemModal()">&times;</span>
      </div>
      <form id="itemForm">
        <div class="form-row">
          <div class="form-group">
            <label>原料名稱：</label>
            <input type="text" id="itemName" required />
          </div>
          <div class="form-group">
            <label>分類：</label>
            <select id="itemCategory">
              <option value="飲料原料">飲料原料</option>
              <option value="食材">食材</option>
              <option value="調料">調料</option>
              <option value="包材">包材</option>
              <option value="其他">其他</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>當前庫存：</label>
            <input type="number" id="itemStock" min="0" step="0.1" required />
          </div>
          <div class="form-group">
            <label>單位：</label>
            <select id="itemUnit">
              <option value="公斤">公斤</option>
              <option value="公升">公升</option>
              <option value="包">包</option>
              <option value="盒">盒</option>
              <option value="瓶">瓶</option>
              <option value="個">個</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>單價 (元)：</label>
            <input type="number" id="itemPrice" min="0" step="0.01" required />
          </div>
          <div class="form-group">
            <label>最低庫存警告：</label>
            <input type="number" id="itemMinStock" min="0" step="0.1" required />
          </div>
        </div>
        <div class="form-group">
          <label>供應商：</label>
          <input type="text" id="itemSupplier" />
        </div>
        <div class="form-group">
          <label>備註：</label>
          <textarea id="itemNotes" rows="3"></textarea>
        </div>
        <div style="text-align: right; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeItemModal()">取消</button>
          <button type="submit" class="btn btn-primary">儲存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 批量進貨彈出視窗 -->
  <div id="batchPurchaseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>📦 批量進貨</h3>
        <span class="close" onclick="closeBatchPurchaseModal()">&times;</span>
      </div>
      <div style="margin-bottom: 20px;">
        <div class="form-group">
          <label>供應商：</label>
          <input type="text" id="purchaseSupplier" placeholder="供應商名稱" />
        </div>
        <div class="form-group">
          <label>進貨日期：</label>
          <input type="date" id="purchaseDate" />
        </div>
        <div class="form-group">
          <label>備註：</label>
          <textarea id="purchaseNotes" rows="2" placeholder="進貨單號、發票號碼等..."></textarea>
        </div>
      </div>
      <div style="margin-bottom: 15px;">
        <button class="btn btn-success" onclick="addPurchaseItem()">➕ 新增進貨項目</button>
      </div>
      <div id="purchaseItemsList"></div>
      <div class="form-group" style="margin-top: 20px;">
        <div style="text-align: right; font-size: 1.2em; font-weight: bold;">
          總進貨金額：$<span id="totalPurchaseAmount">0.00</span>
        </div>
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeBatchPurchaseModal()">取消</button>
        <button type="button" class="btn btn-success" onclick="saveBatchPurchase()">確認進貨</button>
      </div>
    </div>
  </div>

  <!-- 庫存調整彈出視窗 -->
  <div id="adjustModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>庫存調整</h3>
        <span class="close" onclick="closeAdjustModal()">&times;</span>
      </div>
      <div id="adjustItemInfo"></div>
      <form id="adjustForm">
        <div class="form-group">
          <label>調整類型：</label>
          <select id="adjustType">
            <option value="in">入庫</option>
            <option value="out">出庫</option>
            <option value="loss">損耗</option>
            <option value="adjust">盤點調整</option>
          </select>
        </div>
        <div class="form-group">
          <label>調整數量：</label>
          <input type="number" id="adjustQuantity" min="0" step="0.1" required />
        </div>
        <div class="form-group">
          <label>調整原因：</label>
          <textarea id="adjustReason" rows="3" placeholder="請說明調整原因..."></textarea>
        </div>
        <div style="text-align: right; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeAdjustModal()">取消</button>
          <button type="submit" class="btn btn-primary">確認調整</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 確認彈出視窗 -->
  <div id="confirmModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="confirmTitle">確認</h3>
        <span class="close" onclick="closeConfirmModal()">&times;</span>
      </div>
      <div id="confirmMessage" style="margin: 20px 0; line-height: 1.6;"></div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">取消</button>
        <button type="button" class="btn btn-primary" id="confirmBtn">確認</button>
      </div>
    </div>
  </div>

  <!-- 訊息彈出視窗 -->
  <div id="messageModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="messageTitle">訊息</h3>
        <span class="close" onclick="closeMessageModal()">&times;</span>
      </div>
      <div id="messageContent" style="margin: 20px 0; line-height: 1.6;"></div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-primary" onclick="closeMessageModal()">確定</button>
      </div>
    </div>
  </div>

  <!-- 輸入彈出視窗 -->
  <div id="inputModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="inputTitle">輸入</h3>
        <span class="close" onclick="closeInputModal()">&times;</span>
      </div>
      <div id="inputMessage" style="margin: 20px 0; line-height: 1.6;"></div>
      <div class="form-group">
        <input type="text" id="inputField" style="width: 100%;" />
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeInputModal()">取消</button>
        <button type="button" class="btn btn-primary" id="inputBtn">確認</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSKEpN_xclOhuWOQA7HiMSjsz0lNIHRb4",
      authDomain: "gukediancan.firebaseapp.com",
      projectId: "gukediancan",
      storageBucket: "gukediancan.firebasestorage.app",
      messagingSenderId: "864103354539",
      appId: "1:864103354539:web:26aabd0cc698d7a032e7ee",
      measurementId: "G-EZYMQQ5FGQ"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let inventoryData = [];
    let currentEditingItem = null;
    let currentAdjustingItem = null;
    let currentConfirmCallback = null;
    let currentInputCallback = null;
    
    // 自動庫存扣減系統
    let autoDeductionSystem = null;

    // 初始化日期為今天
    function initializeDates() {
      const today = new Date();
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      document.getElementById('analysisStartDate').value = weekAgo.toISOString().split('T')[0];
      document.getElementById('analysisEndDate').value = today.toISOString().split('T')[0];
    }

    // 載入庫存資料
    async function loadInventory() {
      try {
        const snapshot = await getDocs(collection(db, "inventory"));
        inventoryData = [];
        
        snapshot.forEach(doc => {
          inventoryData.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderInventoryList();
        updateStats();
        generateRestockSuggestions();
        showLowStockAlerts();
      } catch (error) {
        console.error('載入庫存資料失敗:', error);
      }
    }

    // 渲染庫存列表
    function renderInventoryList() {
      const container = document.getElementById('inventoryList');
      
      if (inventoryData.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">尚無庫存資料</div>';
        return;
      }

      let html = '<table class="table"><thead><tr><th>原料名稱</th><th>分類</th><th>庫存</th><th>單價</th><th>總價值</th><th>狀態</th><th>操作</th></tr></thead><tbody>';
      
      inventoryData.forEach(item => {
        const totalValue = (item.stock * item.price).toFixed(2);
        const isLowStock = item.stock <= item.minStock;
        const isOutOfStock = item.stock <= 0;
        
        let statusClass = '';
        let statusText = '正常';
        
        if (isOutOfStock) {
          statusClass = 'out-of-stock';
          statusText = '缺貨';
        } else if (isLowStock) {
          statusClass = 'low-stock';
          statusText = '低庫存';
        }
        
        html += `
          <tr class="${statusClass}">
            <td><strong>${item.name}</strong></td>
            <td>${item.category}</td>
            <td>${item.stock} ${item.unit}</td>
            <td>$${item.price}</td>
            <td>$${totalValue}</td>
            <td><span style="color: ${isOutOfStock ? '#f44336' : (isLowStock ? '#FF9800' : '#4CAF50')}">${statusText}</span></td>
            <td>
              <button class="btn btn-success" onclick="quickPurchase('${item.id}')" style="font-size:0.9em;">進貨</button>
              <button class="btn btn-warning" onclick="openAdjustModal('${item.id}')">調整</button>
              <button class="btn btn-primary" onclick="editItem('${item.id}')">編輯</button>
              <button class="btn btn-danger" onclick="deleteItem('${item.id}')">刪除</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // 更新統計資料
    function updateStats() {
      const lowStockCount = inventoryData.filter(item => item.stock <= item.minStock).length;
      const totalItems = inventoryData.length;
      const totalValue = inventoryData.reduce((sum, item) => sum + (item.stock * item.price), 0);
      
      document.getElementById('lowStockCount').textContent = lowStockCount;
      document.getElementById('totalItems').textContent = totalItems;
      document.getElementById('totalValue').textContent = '$' + totalValue.toFixed(2);
      
      // 計算今日消耗（這裡可以根據實際訂單計算）
      calculateTodayUsage();
    }

    // 計算今日消耗
    async function calculateTodayUsage() {
      try {
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
        
        const q = query(
          collection(db, "orders"),
          where("timestamp", ">=", startOfDay),
          where("timestamp", "<", endOfDay)
        );
        
        const snapshot = await getDocs(q);
        let totalUsage = 0;
        
        snapshot.forEach(doc => {
          const order = doc.data();
          if (order.items) {
            totalUsage += order.items.reduce((sum, item) => sum + item.quantity, 0);
          }
        });
        
        document.getElementById('todayUsage').textContent = totalUsage;
      } catch (error) {
        console.error('計算今日消耗失敗:', error);
        document.getElementById('todayUsage').textContent = '0';
      }
    }

    // 顯示低庫存警告
    function showLowStockAlerts() {
      const container = document.getElementById('alertsContainer');
      const lowStockItems = inventoryData.filter(item => item.stock <= item.minStock);
      const outOfStockItems = inventoryData.filter(item => item.stock <= 0);
      
      let html = '';
      
      if (outOfStockItems.length > 0) {
        html += '<div class="alert alert-danger"><strong>⚠️ 缺貨警告：</strong>';
        outOfStockItems.forEach(item => {
          html += `<span style="margin-right: 15px;">${item.name}</span>`;
        });
        html += '</div>';
      }
      
      if (lowStockItems.length > 0 && outOfStockItems.length === 0) {
        html += '<div class="alert alert-warning"><strong>📦 低庫存提醒：</strong>';
        lowStockItems.forEach(item => {
          html += `<span style="margin-right: 15px;">${item.name} (剩餘: ${item.stock}${item.unit})</span>`;
        });
        html += '</div>';
      }
      
      container.innerHTML = html;
    }

    // 生成補貨建議
    function generateRestockSuggestions() {
      const container = document.getElementById('restockSuggestions');
      const needRestockItems = inventoryData.filter(item => item.stock <= item.minStock * 1.5);
      
      if (needRestockItems.length === 0) {
        container.innerHTML = '<div class="alert alert-success">✅ 目前所有原料庫存充足</div>';
        return;
      }
      
      let html = '<table class="table"><thead><tr><th>原料名稱</th><th>目前庫存</th><th>建議補貨量</th><th>預估成本</th><th>供應商</th><th>操作</th></tr></thead><tbody>';
      
      needRestockItems.forEach(item => {
        const suggestedQuantity = Math.max(item.minStock * 3 - item.stock, 0);
        const estimatedCost = (suggestedQuantity * item.price).toFixed(2);
        
        html += `
          <tr>
            <td><strong>${item.name}</strong></td>
            <td>${item.stock} ${item.unit}</td>
            <td>${suggestedQuantity.toFixed(1)} ${item.unit}</td>
            <td>$${estimatedCost}</td>
            <td>${item.supplier || '未設定'}</td>
            <td>
              <button class="btn btn-success" onclick="quickRestock('${item.id}', ${suggestedQuantity})">快速補貨</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // 新增原料
    async function addItem(itemData) {
      try {
        await addDoc(collection(db, "inventory"), {
          ...itemData,
          createdAt: Timestamp.now(),
          updatedAt: Timestamp.now()
        });
        
        await loadInventory();
        closeItemModal();
        showSuccessModal('新增成功', '原料已成功新增');
      } catch (error) {
        console.error('新增原料失敗:', error);
        showErrorModal('新增失敗', '新增原料時發生錯誤，請重試');
      }
    }

    // 更新原料
    async function updateItem(itemId, itemData) {
      try {
        await updateDoc(doc(db, "inventory", itemId), {
          ...itemData,
          updatedAt: Timestamp.now()
        });
        
        await loadInventory();
        closeItemModal();
        showSuccessModal('更新成功', '原料資訊已成功更新');
      } catch (error) {
        console.error('更新原料失敗:', error);
        showErrorModal('更新失敗', '更新原料時發生錯誤，請重試');
      }
    }

    // 刪除原料
    async function deleteItem(itemId) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      openConfirmModal(
        '確認刪除',
        `確定要刪除原料「${item.name}」嗎？此操作無法復原。`,
        async () => {
          try {
            await deleteDoc(doc(db, "inventory", itemId));
            await loadInventory();
            showSuccessModal('刪除成功', '原料已成功刪除');
          } catch (error) {
            console.error('刪除原料失敗:', error);
            showErrorModal('刪除失敗', '刪除原料時發生錯誤，請重試');
          }
        }
      );
    }

    // 庫存調整
    async function adjustStock(itemId, adjustData) {
      try {
        const item = inventoryData.find(i => i.id === itemId);
        if (!item) return;
        
        let newStock = item.stock;
        
        switch (adjustData.type) {
          case 'in':
            newStock += adjustData.quantity;
            break;
          case 'out':
            newStock -= adjustData.quantity;
            break;
          case 'loss':
            newStock -= adjustData.quantity;
            break;
          case 'adjust':
            newStock = adjustData.quantity;
            break;
        }
        
        // 記錄調整歷史
        await addDoc(collection(db, "stock_adjustments"), {
          itemId: itemId,
          itemName: item.name,
          type: adjustData.type,
          quantity: adjustData.quantity,
          oldStock: item.stock,
          newStock: newStock,
          reason: adjustData.reason,
          timestamp: Timestamp.now()
        });
        
        // 更新庫存
        await updateDoc(doc(db, "inventory", itemId), {
          stock: Math.max(0, newStock),
          updatedAt: Timestamp.now()
        });
        
        await loadInventory();
        closeAdjustModal();
        showSuccessModal('調整成功', '庫存已成功調整');
      } catch (error) {
        console.error('庫存調整失敗:', error);
        showErrorModal('調整失敗', '庫存調整時發生錯誤，請重試');
      }
    }

    // 快速補貨
    async function quickRestock(itemId, quantity) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      openConfirmModal(
        '確認補貨',
        `確定要為「${item.name}」補貨 ${quantity} ${item.unit}嗎？`,
        async () => {
          await adjustStock(itemId, {
            type: 'in',
            quantity: quantity,
            reason: '系統建議補貨'
          });
        }
      );
    }

    // 快速進貨
    async function quickPurchase(itemId) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      openInputModal(
        '快速進貨',
        `進貨 ${item.name}\n請輸入進貨數量（${item.unit}）：`,
        (quantity) => {
          if (!quantity || isNaN(quantity) || quantity <= 0) {
            showErrorModal('輸入錯誤', '請輸入有效的進貨數量');
            return;
          }
          
          openInputModal(
            '供應商資訊',
            '供應商名稱（可選）：',
            (supplier) => {
              const supplierName = supplier || '未指定';
              
              openConfirmModal(
                '確認進貨',
                `確定進貨 ${item.name} ${quantity} ${item.unit} 嗎？\n供應商：${supplierName}`,
                async () => {
                  await adjustStock(itemId, {
                    type: 'in',
                    quantity: parseFloat(quantity),
                    reason: `進貨 - 供應商: ${supplierName}`
                  });
                }
              );
            },
            '輸入供應商名稱'
          );
        },
        '輸入數量'
      );
    }

    // 批量進貨功能
    let purchaseItems = [];

    function openBatchPurchaseModal() {
      // 初始化日期為今天
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('purchaseDate').value = today;
      
      // 清空表單
      document.getElementById('purchaseSupplier').value = '';
      document.getElementById('purchaseNotes').value = '';
      purchaseItems = [];
      
      renderPurchaseItems();
      document.getElementById('batchPurchaseModal').style.display = 'block';
    }

    function closeBatchPurchaseModal() {
      document.getElementById('batchPurchaseModal').style.display = 'none';
      purchaseItems = [];
    }

    function addPurchaseItem() {
      purchaseItems.push({
        itemId: '',
        itemName: '',
        quantity: 0,
        unitPrice: 0,
        totalPrice: 0,
        unit: ''
      });
      renderPurchaseItems();
    }

    function removePurchaseItem(index) {
      purchaseItems.splice(index, 1);
      renderPurchaseItems();
      updateTotalPurchaseAmount();
    }

    function renderPurchaseItems() {
      const container = document.getElementById('purchaseItemsList');
      
      if (purchaseItems.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">尚未新增進貨項目</div>';
        updateTotalPurchaseAmount();
        return;
      }
      
      let html = '<table class="table"><thead><tr><th>原料</th><th>數量</th><th>單價</th><th>小計</th><th>操作</th></tr></thead><tbody>';
      
      purchaseItems.forEach((item, index) => {
        html += `
          <tr>
            <td>
              <select onchange="updatePurchaseItem(${index}, 'itemId', this.value)" style="width: 100%;">
                <option value="">選擇原料</option>
                ${inventoryData.map(inv => 
                  `<option value="${inv.id}" ${item.itemId === inv.id ? 'selected' : ''}>
                    ${inv.name} (${inv.unit})
                  </option>`
                ).join('')}
              </select>
            </td>
            <td>
              <input type="number" value="${item.quantity}" 
                     onchange="updatePurchaseItem(${index}, 'quantity', this.value)"
                     style="width: 80px;" min="0" step="0.1" />
              <span style="margin-left: 5px;">${item.unit}</span>
            </td>
            <td>
              <input type="number" value="${item.unitPrice}" 
                     onchange="updatePurchaseItem(${index}, 'unitPrice', this.value)"
                     style="width: 80px;" min="0" step="0.01" />
            </td>
            <td>$${item.totalPrice.toFixed(2)}</td>
            <td>
              <button class="btn btn-danger" onclick="removePurchaseItem(${index})" style="font-size: 0.9em;">移除</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      updateTotalPurchaseAmount();
    }

    function updatePurchaseItem(index, field, value) {
      if (field === 'itemId') {
        const selectedItem = inventoryData.find(i => i.id === value);
        if (selectedItem) {
          purchaseItems[index].itemId = value;
          purchaseItems[index].itemName = selectedItem.name;
          purchaseItems[index].unit = selectedItem.unit;
          purchaseItems[index].unitPrice = selectedItem.price; // 預設為庫存中的單價
        }
      } else if (field === 'quantity') {
        purchaseItems[index].quantity = parseFloat(value) || 0;
      } else if (field === 'unitPrice') {
        purchaseItems[index].unitPrice = parseFloat(value) || 0;
      }
      
      // 計算小計
      purchaseItems[index].totalPrice = purchaseItems[index].quantity * purchaseItems[index].unitPrice;
      
      renderPurchaseItems();
    }

    function updateTotalPurchaseAmount() {
      const total = purchaseItems.reduce((sum, item) => sum + item.totalPrice, 0);
      document.getElementById('totalPurchaseAmount').textContent = total.toFixed(2);
    }

    async function saveBatchPurchase() {
      const supplier = document.getElementById('purchaseSupplier').value.trim();
      const purchaseDate = document.getElementById('purchaseDate').value;
      const notes = document.getElementById('purchaseNotes').value.trim();
      
      if (purchaseItems.length === 0) {
        showErrorModal('進貨項目不足', '請新增至少一個進貨項目');
        return;
      }
      
      if (!supplier) {
        showErrorModal('供應商資訊缺失', '請輸入供應商名稱');
        return;
      }
      
      // 驗證所有項目都已選擇原料和數量
      for (const item of purchaseItems) {
        if (!item.itemId || item.quantity <= 0) {
          showErrorModal('進貨項目不完整', '請確認所有進貨項目都已選擇原料並輸入數量');
          return;
        }
      }
      
      openConfirmModal(
        '確認批量進貨',
        '確定要執行批量進貨嗎？',
        async () => {
          try {
            const totalAmount = purchaseItems.reduce((sum, item) => sum + item.totalPrice, 0);
            
            // 記錄進貨單
            const purchaseRecord = await addDoc(collection(db, "purchase_records"), {
              supplier: supplier,
              purchaseDate: new Date(purchaseDate),
              notes: notes,
              items: purchaseItems,
              totalAmount: totalAmount,
              createdAt: Timestamp.now()
            });
            
            // 逐一更新庫存
            for (const item of purchaseItems) {
              await adjustStock(item.itemId, {
                type: 'in',
                quantity: item.quantity,
                reason: `批量進貨 - 供應商: ${supplier} (進貨單: ${purchaseRecord.id})`
              });
            }
            
            closeBatchPurchaseModal();
            showSuccessModal('進貨完成', '批量進貨已成功完成');
            
          } catch (error) {
            console.error('批量進貨失敗:', error);
            showErrorModal('進貨失敗', '批量進貨時發生錯誤，請重試');
          }
        }
      );
    }

    // 生成成本分析
    async function generateCostAnalysis() {
      const startDate = document.getElementById('analysisStartDate').value;
      const endDate = document.getElementById('analysisEndDate').value;
      
      if (!startDate || !endDate) {
        showErrorModal('日期未選擇', '請選擇分析期間');
        return;
      }
      
      try {
        const start = new Date(startDate);
        const end = new Date(endDate + 'T23:59:59');
        
        // 查詢期間內的庫存調整記錄
        const adjustmentsQuery = query(
          collection(db, "stock_adjustments"),
          where("timestamp", ">=", start),
          where("timestamp", "<=", end),
          orderBy("timestamp", "desc")
        );
        
        const adjustmentsSnapshot = await getDocs(adjustmentsQuery);
        const adjustments = [];
        
        adjustmentsSnapshot.forEach(doc => {
          adjustments.push(doc.data());
        });
        
        // 計算成本分析
        const analysis = calculateCostAnalysis(adjustments);
        renderCostAnalysis(analysis);
        
      } catch (error) {
        console.error('生成成本分析失敗:', error);
        showErrorModal('分析失敗', '生成成本分析時發生錯誤，請重試');
      }
    }

    // 計算成本分析
    function calculateCostAnalysis(adjustments) {
      const analysis = {
        totalInCost: 0,
        totalOutCost: 0,
        totalLossCost: 0,
        categoryAnalysis: {},
        topCostItems: []
      };
      
      const itemCosts = {};
      
      adjustments.forEach(adj => {
        const item = inventoryData.find(i => i.id === adj.itemId);
        if (!item) return;
        
        const cost = adj.quantity * item.price;
        
        switch (adj.type) {
          case 'in':
            analysis.totalInCost += cost;
            break;
          case 'out':
          case 'loss':
            analysis.totalOutCost += cost;
            if (adj.type === 'loss') {
              analysis.totalLossCost += cost;
            }
            break;
        }
        
        // 分類分析
        if (!analysis.categoryAnalysis[item.category]) {
          analysis.categoryAnalysis[item.category] = 0;
        }
        if (adj.type === 'out' || adj.type === 'loss') {
          analysis.categoryAnalysis[item.category] += cost;
        }
        
        // 商品成本統計
        if (!itemCosts[item.name]) {
          itemCosts[item.name] = 0;
        }
        if (adj.type === 'out' || adj.type === 'loss') {
          itemCosts[item.name] += cost;
        }
      });
      
      // 取得成本最高的前5項
      analysis.topCostItems = Object.entries(itemCosts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, cost]) => ({ name, cost }));
      
      return analysis;
    }

    // 渲染成本分析結果
    function renderCostAnalysis(analysis) {
      const container = document.getElementById('costAnalysisResult');
      
      let html = `
        <div class="stats-grid" style="margin-bottom: 20px;">
          <div class="stat-card info">
            <div class="stat-value">$${analysis.totalInCost.toFixed(2)}</div>
            <div class="stat-label">進貨成本</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-value">$${analysis.totalOutCost.toFixed(2)}</div>
            <div class="stat-label">消耗成本</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #f44336;">
            <div class="stat-value">$${analysis.totalLossCost.toFixed(2)}</div>
            <div class="stat-label">損耗成本</div>
          </div>
        </div>
      `;
      
      if (analysis.topCostItems.length > 0) {
        html += '<h4>成本最高商品 TOP5</h4>';
        html += '<table class="table"><thead><tr><th>商品名稱</th><th>成本</th></tr></thead><tbody>';
        
        analysis.topCostItems.forEach(item => {
          html += `<tr><td>${item.name}</td><td>$${item.cost.toFixed(2)}</td></tr>`;
        });
        
        html += '</tbody></table>';
      }
      
      if (Object.keys(analysis.categoryAnalysis).length > 0) {
        html += '<h4>分類成本分析</h4>';
        html += '<table class="table"><thead><tr><th>分類</th><th>成本</th></tr></thead><tbody>';
        
        Object.entries(analysis.categoryAnalysis)
          .sort((a, b) => b[1] - a[1])
          .forEach(([category, cost]) => {
            html += `<tr><td>${category}</td><td>$${cost.toFixed(2)}</td></tr>`;
          });
        
        html += '</tbody></table>';
      }
      
      container.innerHTML = html;
    }

    // 彈出視窗控制
    function openAddItemModal() {
      document.getElementById('modalTitle').textContent = '新增原料';
      document.getElementById('itemForm').reset();
      currentEditingItem = null;
      document.getElementById('itemModal').style.display = 'block';
    }

    function editItem(itemId) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      document.getElementById('modalTitle').textContent = '編輯原料';
      document.getElementById('itemName').value = item.name;
      document.getElementById('itemCategory').value = item.category;
      document.getElementById('itemStock').value = item.stock;
      document.getElementById('itemUnit').value = item.unit;
      document.getElementById('itemPrice').value = item.price;
      document.getElementById('itemMinStock').value = item.minStock;
      document.getElementById('itemSupplier').value = item.supplier || '';
      document.getElementById('itemNotes').value = item.notes || '';
      
      currentEditingItem = itemId;
      document.getElementById('itemModal').style.display = 'block';
    }

    function closeItemModal() {
      document.getElementById('itemModal').style.display = 'none';
      currentEditingItem = null;
    }

    function openAdjustModal(itemId) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      document.getElementById('adjustItemInfo').innerHTML = `
        <div class="alert alert-info">
          <strong>${item.name}</strong><br>
          目前庫存: ${item.stock} ${item.unit}<br>
          單價: $${item.price}
        </div>
      `;
      
      document.getElementById('adjustForm').reset();
      currentAdjustingItem = itemId;
      document.getElementById('adjustModal').style.display = 'block';
    }

    function closeAdjustModal() {
      document.getElementById('adjustModal').style.display = 'none';
      currentAdjustingItem = null;
    }

    // 通用 Modal 函數
    function openConfirmModal(title, message, callback) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
      currentConfirmCallback = callback;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
      currentConfirmCallback = null;
    }

    function showSuccessModal(title, message) {
      document.getElementById('messageTitle').textContent = title;
      document.getElementById('messageContent').innerHTML = message.replace(/\n/g, '<br>');
      document.getElementById('messageModal').style.display = 'block';
    }

    function showErrorModal(title, message) {
      document.getElementById('messageTitle').textContent = title;
      document.getElementById('messageContent').innerHTML = message.replace(/\n/g, '<br>');
      document.getElementById('messageModal').style.display = 'block';
    }

    function closeMessageModal() {
      document.getElementById('messageModal').style.display = 'none';
    }

    function openInputModal(title, message, callback, placeholder = '') {
      document.getElementById('inputTitle').textContent = title;
      document.getElementById('inputMessage').innerHTML = message.replace(/\n/g, '<br>');
      document.getElementById('inputField').placeholder = placeholder;
      document.getElementById('inputField').value = '';
      currentInputCallback = callback;
      document.getElementById('inputModal').style.display = 'block';
      document.getElementById('inputField').focus();
      
      // 支援 Enter 鍵確認
      document.getElementById('inputField').onkeypress = function(e) {
        if (e.key === 'Enter') {
          document.getElementById('inputBtn').click();
        }
      };
    }

    function closeInputModal() {
      document.getElementById('inputModal').style.display = 'none';
      currentInputCallback = null;
    }

    // 自動庫存扣減系統類別
    class AutoInventoryDeduction {
      constructor() {
        this.processedOrders = new Set();
        this.menuData = new Map();
        this.inventoryDataMap = new Map();
        this.isInitialized = false;
        this.orderListener = null;
      }

      // 初始化系統
      async initialize() {
        try {
          console.log('初始化自動庫存扣減系統...');
          
          // 載入菜單資料
          await this.loadMenuData();
          
          // 載入庫存資料
          await this.loadInventoryDataMap();
          
          // 載入已處理的訂單
          await this.loadProcessedOrders();
          
          // 開始監聽新訂單
          this.startOrderListener();
          
          this.isInitialized = true;
          console.log('自動庫存扣減系統初始化完成');
          
          // 更新頁面狀態顯示
          this.updateStatusDisplay();
        } catch (error) {
          console.error('初始化自動庫存扣減系統失敗:', error);
        }
      }

      // 載入菜單資料
      async loadMenuData() {
        const snapshot = await getDocs(collection(db, "menu"));
        this.menuData.clear();
        
        snapshot.forEach(doc => {
          const data = doc.data();
          this.menuData.set(data.name, data);
        });
        
        console.log(`載入了 ${this.menuData.size} 個菜單項目`);
      }

      // 載入庫存資料
      async loadInventoryDataMap() {
        const snapshot = await getDocs(collection(db, "inventory"));
        this.inventoryDataMap.clear();
        
        snapshot.forEach(doc => {
          const data = doc.data();
          this.inventoryDataMap.set(doc.id, data);
        });
        
        console.log(`載入了 ${this.inventoryDataMap.size} 個庫存項目`);
      }

      // 載入已處理的訂單
      async loadProcessedOrders() {
        try {
          // 載入過去24小時的訂單ID，避免重複處理
          const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);
          const q = query(
            collection(db, "orders"),
            where("timestamp", ">=", yesterday)
          );
          
          const snapshot = await getDocs(q);
          snapshot.forEach(doc => {
            this.processedOrders.add(doc.id);
          });
          
          console.log(`載入了 ${this.processedOrders.size} 個已處理訂單`);
        } catch (error) {
          console.error('載入已處理訂單失敗:', error);
        }
      }

      // 開始監聽新訂單
      startOrderListener() {
        this.orderListener = onSnapshot(collection(db, "orders"), (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
              const orderId = change.doc.id;
              const orderData = change.doc.data();
              
              // 檢查是否為新訂單（未處理過的）
              if (!this.processedOrders.has(orderId)) {
                console.log('🔄 發現新訂單:', orderId);
                this.processOrder(orderId, orderData);
                this.processedOrders.add(orderId);
              }
            }
          });
        });
      }

      // 處理訂單，扣減庫存
      async processOrder(orderId, orderData) {
        try {
          console.log(`開始處理訂單 ${orderId} 的庫存扣減`);
          
          if (!orderData.items || !Array.isArray(orderData.items)) {
            console.log('訂單沒有商品項目，跳過處理');
            return;
          }

          const deductionLog = [];
          
          // 處理每個訂單項目
          for (const orderItem of orderData.items) {
            const menuItem = this.menuData.get(orderItem.name);
            
            if (!menuItem || !menuItem.recipe || !Array.isArray(menuItem.recipe)) {
              console.log(`商品 ${orderItem.name} 沒有設定配方，跳過庫存扣減`);
              continue;
            }

            console.log(`處理商品 ${orderItem.name}，數量: ${orderItem.quantity}`);
            
            // 處理配方中的每個原料
            for (const recipeItem of menuItem.recipe) {
              if (!recipeItem.ingredientId || !recipeItem.quantity) {
                continue;
              }

              const totalDeduction = recipeItem.quantity * orderItem.quantity;
              const success = await this.deductInventory(
                recipeItem.ingredientId, 
                totalDeduction, 
                orderId, 
                orderItem.name
              );

              if (success) {
                deductionLog.push({
                  ingredientId: recipeItem.ingredientId,
                  ingredientName: recipeItem.ingredientName,
                  quantity: totalDeduction,
                  unit: recipeItem.unit
                });
              }
            }
          }

          // 記錄扣減歷史
          if (deductionLog.length > 0) {
            await this.logDeduction(orderId, orderData, deductionLog);
          }

          console.log(`✅ 訂單 ${orderId} 庫存扣減完成`);
          
          // 重新載入庫存顯示
          await loadInventory();
          
        } catch (error) {
          console.error(`處理訂單 ${orderId} 庫存扣減失敗:`, error);
        }
      }

      // 扣減庫存
      async deductInventory(ingredientId, quantity, orderId, itemName) {
        try {
          const inventory = this.inventoryDataMap.get(ingredientId);
          
          if (!inventory) {
            console.warn(`找不到原料 ${ingredientId}，無法扣減庫存`);
            return false;
          }

          const newStock = Math.max(0, inventory.stock - quantity);
          
          // 更新Firebase中的庫存
          await updateDoc(doc(db, "inventory", ingredientId), {
            stock: newStock,
            updatedAt: Timestamp.now()
          });

          // 更新本地快取
          this.inventoryDataMap.set(ingredientId, {
            ...inventory,
            stock: newStock
          });

          // 記錄庫存調整
          await addDoc(collection(db, "stock_adjustments"), {
            itemId: ingredientId,
            itemName: inventory.name,
            type: 'auto_deduction',
            quantity: quantity,
            oldStock: inventory.stock,
            newStock: newStock,
            reason: `訂單 ${orderId} - 商品: ${itemName}`,
            orderId: orderId,
            timestamp: Timestamp.now()
          });

          console.log(`📦 成功扣減 ${inventory.name}: ${quantity} ${inventory.unit}，剩餘: ${newStock}`);
          
          // 檢查低庫存警告
          if (newStock <= inventory.minStock) {
            console.warn(`⚠️ ${inventory.name} 庫存不足！目前: ${newStock}，最低: ${inventory.minStock}`);
            await this.sendLowStockAlert(inventory, newStock);
          }

          return true;
        } catch (error) {
          console.error(`扣減庫存失敗 (${ingredientId}):`, error);
          return false;
        }
      }

      // 發送低庫存警告
      async sendLowStockAlert(inventory, currentStock) {
        try {
          await addDoc(collection(db, "alerts"), {
            type: 'low_stock',
            itemId: inventory.id,
            itemName: inventory.name,
            currentStock: currentStock,
            minStock: inventory.minStock,
            message: `${inventory.name} 庫存不足，目前剩餘 ${currentStock} ${inventory.unit}`,
            timestamp: Timestamp.now(),
            resolved: false
          });
        } catch (error) {
          console.error('發送低庫存警告失敗:', error);
        }
      }

      // 記錄扣減歷史
      async logDeduction(orderId, orderData, deductionLog) {
        try {
          await addDoc(collection(db, "inventory_deductions"), {
            orderId: orderId,
            orderType: orderData.dineType,
            tableNumber: orderData.tableNumber,
            takeoutNumber: orderData.takeoutNumber,
            totalAmount: orderData.totalAmount,
            deductions: deductionLog,
            timestamp: orderData.timestamp || Timestamp.now()
          });
        } catch (error) {
          console.error('記錄扣減歷史失敗:', error);
        }
      }

      // 更新狀態顯示
      updateStatusDisplay() {
        const statusElement = document.getElementById('deductionStatus');
        if (statusElement) {
          statusElement.textContent = `自動扣減系統：${this.isInitialized ? '✅ 運行中' : '❌ 未啟動'}`;
          statusElement.style.color = this.isInitialized ? '#4CAF50' : '#f44336';
        }
      }

      // 手動重新載入資料
      async reload() {
        await this.loadMenuData();
        await this.loadInventoryDataMap();
        console.log('庫存扣減系統資料已重新載入');
      }

      // 獲取系統狀態
      getStatus() {
        return {
          isInitialized: this.isInitialized,
          menuItemsCount: this.menuData.size,
          inventoryItemsCount: this.inventoryDataMap.size,
          processedOrdersCount: this.processedOrders.size
        };
      }

      // 停止監聽
      stop() {
        if (this.orderListener) {
          this.orderListener();
          this.orderListener = null;
        }
        this.isInitialized = false;
        this.updateStatusDisplay();
      }
    }

    // 表單提交處理
    document.getElementById('itemForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const itemData = {
        name: document.getElementById('itemName').value,
        category: document.getElementById('itemCategory').value,
        stock: parseFloat(document.getElementById('itemStock').value),
        unit: document.getElementById('itemUnit').value,
        price: parseFloat(document.getElementById('itemPrice').value),
        minStock: parseFloat(document.getElementById('itemMinStock').value),
        supplier: document.getElementById('itemSupplier').value,
        notes: document.getElementById('itemNotes').value
      };
      
      if (currentEditingItem) {
        await updateItem(currentEditingItem, itemData);
      } else {
        await addItem(itemData);
      }
    });

    document.getElementById('adjustForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const adjustData = {
        type: document.getElementById('adjustType').value,
        quantity: parseFloat(document.getElementById('adjustQuantity').value),
        reason: document.getElementById('adjustReason').value
      };
      
      if (currentAdjustingItem) {
        await adjustStock(currentAdjustingItem, adjustData);
      }
    });

    // 重啟自動扣減系統
    async function reloadAutoDeductionSystem() {
      try {
        if (autoDeductionSystem) {
          autoDeductionSystem.stop();
          await autoDeductionSystem.reload();
          await autoDeductionSystem.initialize();
          showSuccessModal('系統重啟', '自動庫存扣減系統已重新啟動');
        } else {
          autoDeductionSystem = new AutoInventoryDeduction();
          await autoDeductionSystem.initialize();
          showSuccessModal('系統啟動', '自動庫存扣減系統已啟動');
        }
      } catch (error) {
        console.error('重啟自動扣減系統失敗:', error);
        showErrorModal('系統錯誤', '重啟自動庫存扣減系統失敗');
      }
    }

    // 載入自動扣減記錄
    async function loadDeductionHistory() {
      try {
        const container = document.getElementById('deductionHistory');
        const statusSpan = document.getElementById('deductionStatus');
        
        statusSpan.textContent = '載入中...';
        
        // 查詢最近7天的扣減記錄
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const q = query(
          collection(db, "inventory_deductions"),
          where("timestamp", ">=", weekAgo),
          orderBy("timestamp", "desc")
        );
        
        const snapshot = await getDocs(q);
        const deductions = [];
        
        snapshot.forEach(doc => {
          deductions.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        if (deductions.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">最近7天沒有自動扣減記錄</div>';
          statusSpan.textContent = '';
          return;
        }
        
        let html = '<table class="table"><thead><tr><th>時間</th><th>訂單編號</th><th>用餐方式</th><th>扣減原料</th><th>訂單金額</th></tr></thead><tbody>';
        
        deductions.forEach(deduction => {
          const time = deduction.timestamp ? deduction.timestamp.toDate().toLocaleString('zh-TW') : '-';
          const deductionDetails = deduction.deductions.map(d => 
            `${d.ingredientName}: ${d.quantity}${d.unit}`
          ).join('<br>');
          
          html += `
            <tr>
              <td>${time}</td>
              <td>${deduction.orderId}</td>
              <td>${deduction.orderType || '-'}</td>
              <td>${deductionDetails}</td>
              <td>$${deduction.totalAmount || 0}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        statusSpan.textContent = `共 ${deductions.length} 筆記錄`;
        
      } catch (error) {
        console.error('載入自動扣減記錄失敗:', error);
        document.getElementById('deductionHistory').innerHTML = 
          '<div style="text-align: center; color: #f44336; padding: 20px;">載入失敗，請重試</div>';
        document.getElementById('deductionStatus').textContent = '';
      }
    }

    // 全域函數
    window.openAddItemModal = openAddItemModal;
    window.editItem = editItem;
    window.closeItemModal = closeItemModal;
    window.deleteItem = deleteItem;
    window.openAdjustModal = openAdjustModal;
    window.closeAdjustModal = closeAdjustModal;
    window.quickRestock = quickRestock;
    window.generateCostAnalysis = generateCostAnalysis;
    window.loadDeductionHistory = loadDeductionHistory;
    window.openBatchPurchaseModal = openBatchPurchaseModal;
    window.closeBatchPurchaseModal = closeBatchPurchaseModal;
    window.addPurchaseItem = addPurchaseItem;
    window.removePurchaseItem = removePurchaseItem;
    window.updatePurchaseItem = updatePurchaseItem;
    window.saveBatchPurchase = saveBatchPurchase;
    window.quickPurchase = quickPurchase;
    window.openConfirmModal = openConfirmModal;
    window.closeConfirmModal = closeConfirmModal;
    window.showSuccessModal = showSuccessModal;
    window.showErrorModal = showErrorModal;
    window.closeMessageModal = closeMessageModal;
    window.openInputModal = openInputModal;
    window.closeInputModal = closeInputModal;
    window.reloadAutoDeductionSystem = reloadAutoDeductionSystem;

    // 登出函數
    window.logout = function() {
      signOut(auth);
    };

    // Firebase Auth
    const authContainer = document.getElementById('authContainer');
    const mainContainer = document.getElementById('mainContainer');
    const authMsg = document.getElementById('authMsg');

    document.getElementById('authLoginBtn').onclick = async function() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      authMsg.innerText = '';
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        authMsg.innerText = '登入失敗：' + (e.message || '請檢查帳號密碼');
      }
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        authContainer.style.display = 'none';
        mainContainer.style.display = 'block';
        initializeDates();
        loadInventory();
        loadDeductionHistory();
        
        // 初始化自動庫存扣減系統
        if (!autoDeductionSystem) {
          autoDeductionSystem = new AutoInventoryDeduction();
          autoDeductionSystem.initialize();
        }
      } else {
        mainContainer.style.display = 'none';
        authContainer.style.display = 'block';
        
        // 停止自動庫存扣減系統
        if (autoDeductionSystem) {
          autoDeductionSystem.stop();
          autoDeductionSystem = null;
        }
      }
    });

    // Modal 按鈕事件處理
    document.getElementById('confirmBtn').onclick = function() {
      if (currentConfirmCallback) {
        currentConfirmCallback();
        closeConfirmModal();
      }
    };

    document.getElementById('inputBtn').onclick = function() {
      if (currentInputCallback) {
        const value = document.getElementById('inputField').value.trim();
        currentInputCallback(value);
        closeInputModal();
      }
    };

    // 點擊外部關閉彈出視窗
    window.onclick = function(event) {
      const itemModal = document.getElementById('itemModal');
      const adjustModal = document.getElementById('adjustModal');
      const confirmModal = document.getElementById('confirmModal');
      const messageModal = document.getElementById('messageModal');
      const inputModal = document.getElementById('inputModal');
      const batchPurchaseModal = document.getElementById('batchPurchaseModal');
      
      if (event.target === itemModal) {
        closeItemModal();
      }
      if (event.target === adjustModal) {
        closeAdjustModal();
      }
      if (event.target === confirmModal) {
        closeConfirmModal();
      }
      if (event.target === messageModal) {
        closeMessageModal();
      }
      if (event.target === inputModal) {
        closeInputModal();
      }
      if (event.target === batchPurchaseModal) {
        closeBatchPurchaseModal();
      }
    };
  </script>
</body>
</html> 