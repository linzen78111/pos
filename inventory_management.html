<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>åº«å­˜ç®¡ç†ç³»çµ± - GèŒ¶é¤é…’é¤¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* æ¨™é¡Œå€åŸŸ */
    .header { background: #2d2320; color: #e0b873; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 1.8em; }
    .nav-buttons { display: flex; gap: 10px; }
    .nav-btn { padding: 8px 16px; background: #e0b873; color: #2d2320; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-decoration: none; }
    .nav-btn:hover { background: #d4a862; }
    
    /* çµ±è¨ˆå¡ç‰‡ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .stat-card.warning { border-left: 4px solid #f44336; }
    .stat-card.success { border-left: 4px solid #4CAF50; }
    .stat-card.info { border-left: 4px solid #2196F3; }
    .stat-value { font-size: 2em; font-weight: bold; margin: 10px 0; }
    .stat-label { color: #666; font-size: 0.9em; }
    
    /* ä¸»è¦å…§å®¹å€åŸŸ */
    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .section h2 { margin: 0 0 15px 0; color: #2d2320; border-bottom: 2px solid #e0b873; padding-bottom: 10px; }
    
    /* è¡¨æ ¼æ¨£å¼ */
    .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .table th { background: #f8f8f8; font-weight: bold; color: #2d2320; }
    .table tr:hover { background: #f9f9f9; }
    .table tr.low-stock { background: #ffebee; }
    .table tr.out-of-stock { background: #ffcdd2; }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 2px; }
    .btn-primary { background: #2196F3; color: white; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-warning { background: #FF9800; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn:hover { opacity: 0.8; }
    
    /* è¡¨å–®æ¨£å¼ */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2d2320; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    
    /* å½ˆå‡ºè¦–çª— */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); animation: fadeIn 0.3s ease; }
    .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e0b873; padding-bottom: 15px; }
    .modal-header h3 { margin: 0; color: #2d2320; }
    .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease; }
    .close:hover { color: #2d2320; }
    
    /* Modal å‹•ç•« */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* æŒ‰éˆ•æ¨£å¼å¢å¼· */
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    
    /* è­¦å‘Šæé†’ */
    .alert { padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    
    /* åœ–è¡¨å®¹å™¨ */
    .chart-container { height: 300px; margin: 20px 0; }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .main-content { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 15px; }
      .nav-buttons { flex-wrap: wrap; justify-content: center; }
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥å€åŸŸ -->
  <div class="container" id="authContainer" style="display:none;max-width:400px;margin:100px auto;">
    <div class="section">
      <h2>åº«å­˜ç®¡ç†ç™»å…¥</h2>
      <div class="form-group">
        <input type="email" id="authEmail" placeholder="Email" />
      </div>
      <div class="form-group">
        <input type="password" id="authPassword" placeholder="å¯†ç¢¼" />
      </div>
      <button id="authLoginBtn" class="btn btn-primary" style="width:100%;">ç™»å…¥</button>
      <div id="authMsg" style="color:#f44336;margin-top:15px;text-align:center;"></div>
    </div>
  </div>

  <!-- ä¸»è¦å…§å®¹ -->
  <div class="container" id="mainContainer" style="display:none;">
    <div class="header">
      <h1>ğŸ“¦ åº«å­˜ç®¡ç†ç³»çµ±</h1>
      <div class="nav-buttons">
        <a href="kitchen_orders.html" class="nav-btn">ğŸ³ å»šæˆ¿çœ‹æ¿</a>
        <a href="daily_report.html" class="nav-btn">ğŸ“Š æ—¥çµå¸³</a>
        <a href="analytics.html" class="nav-btn">ğŸ“Š æƒ…å ±åˆ†æ</a>
        <a href="system_settings.html" class="nav-btn">âš™ï¸ ç³»çµ±è¨­å®š</a>
        <button class="nav-btn" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card warning">
        <div class="stat-value" id="lowStockCount">0</div>
        <div class="stat-label">ä½åº«å­˜å•†å“</div>
      </div>
      <div class="stat-card info">
        <div class="stat-value" id="totalItems">0</div>
        <div class="stat-label">ç¸½å•†å“æ•¸</div>
      </div>
      <div class="stat-card success">
        <div class="stat-value" id="totalValue">$0</div>
        <div class="stat-label">åº«å­˜ç¸½åƒ¹å€¼</div>
      </div>
      <div class="stat-card info">
        <div class="stat-value" id="todayUsage">0</div>
        <div class="stat-label">ä»Šæ—¥æ¶ˆè€—</div>
      </div>
    </div>

    <!-- è­¦å‘Šæé†’ -->
    <div id="alertsContainer"></div>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="main-content">
      <!-- åº«å­˜åˆ—è¡¨ -->
      <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2>åŸæ–™åº«å­˜</h2>
          <div>
            <button class="btn btn-success" onclick="openBatchPurchaseModal()">ğŸ“¦ æ‰¹é‡é€²è²¨</button>
            <button class="btn btn-primary" onclick="openAddItemModal()" style="margin-left: 10px;">â• æ–°å¢åŸæ–™</button>
          </div>
        </div>
        <div id="inventoryList">
          <div style="text-align: center; color: #666; padding: 20px;">è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- æˆæœ¬åˆ†æ -->
      <div class="section">
        <h2>æˆæœ¬åˆ†æ</h2>
        <div class="form-group">
          <label>åˆ†ææœŸé–“ï¼š</label>
          <div class="form-row">
            <input type="date" id="analysisStartDate" />
            <input type="date" id="analysisEndDate" />
          </div>
          <button class="btn btn-primary" onclick="generateCostAnalysis()" style="margin-top: 10px;">ç”Ÿæˆåˆ†æ</button>
        </div>
        <div id="costAnalysisResult">
          <div style="text-align: center; color: #666; padding: 20px;">è«‹é¸æ“‡æ—¥æœŸç¯„åœä¸¦ç”Ÿæˆåˆ†æ</div>
        </div>
      </div>
    </div>

    <!-- è£œè²¨æé†’ -->
    <div class="section" style="margin-top: 20px;">
      <h2>ğŸ“‹ è£œè²¨å»ºè­°</h2>
      <div id="restockSuggestions">
        <div style="text-align: center; color: #666; padding: 20px;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>

    <!-- è‡ªå‹•æ‰£æ¸›è¨˜éŒ„ -->
    <div class="section" style="margin-top: 20px;">
      <h2>ğŸ”„ è‡ªå‹•æ‰£æ¸›è¨˜éŒ„</h2>
      <div style="margin-bottom: 15px;">
        <button class="btn btn-primary" onclick="loadDeductionHistory()">é‡æ–°æ•´ç†</button>
        <button class="btn btn-success" onclick="reloadAutoDeductionSystem()" style="margin-left: 10px;">é‡å•Ÿè‡ªå‹•æ‰£æ¸›</button>
        <span id="deductionStatus" style="margin-left: 15px; color: #666;"></span>
      </div>
      <div id="deductionHistory">
        <div style="text-align: center; color: #666; padding: 20px;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç·¨è¼¯åŸæ–™å½ˆå‡ºè¦–çª— -->
  <div id="itemModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">æ–°å¢åŸæ–™</h3>
        <span class="close" onclick="closeItemModal()">&times;</span>
      </div>
      <form id="itemForm">
        <div class="form-row">
          <div class="form-group">
            <label>åŸæ–™åç¨±ï¼š</label>
            <input type="text" id="itemName" required />
          </div>
          <div class="form-group">
            <label>åˆ†é¡ï¼š</label>
            <select id="itemCategory">
              <option value="é£²æ–™åŸæ–™">é£²æ–™åŸæ–™</option>
              <option value="é£Ÿæ">é£Ÿæ</option>
              <option value="èª¿æ–™">èª¿æ–™</option>
              <option value="åŒ…æ">åŒ…æ</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ç•¶å‰åº«å­˜ï¼š</label>
            <input type="number" id="itemStock" min="0" step="0.1" required />
          </div>
          <div class="form-group">
            <label>å–®ä½ï¼š</label>
            <select id="itemUnit">
              <option value="å…¬æ–¤">å…¬æ–¤</option>
              <option value="å…¬å‡">å…¬å‡</option>
              <option value="åŒ…">åŒ…</option>
              <option value="ç›’">ç›’</option>
              <option value="ç“¶">ç“¶</option>
              <option value="å€‹">å€‹</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>å–®åƒ¹ (å…ƒ)ï¼š</label>
            <input type="number" id="itemPrice" min="0" step="0.01" required />
          </div>
          <div class="form-group">
            <label>æœ€ä½åº«å­˜è­¦å‘Šï¼š</label>
            <input type="number" id="itemMinStock" min="0" step="0.1" required />
          </div>
        </div>
        <div class="form-group">
          <label>ä¾›æ‡‰å•†ï¼š</label>
          <input type="text" id="itemSupplier" />
        </div>
        <div class="form-group">
          <label>å‚™è¨»ï¼š</label>
          <textarea id="itemNotes" rows="3"></textarea>
        </div>
        <div style="text-align: right; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeItemModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ‰¹é‡é€²è²¨å½ˆå‡ºè¦–çª— -->
  <div id="batchPurchaseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ“¦ æ‰¹é‡é€²è²¨</h3>
        <span class="close" onclick="closeBatchPurchaseModal()">&times;</span>
      </div>
      <div style="margin-bottom: 20px;">
        <div class="form-group">
          <label>ä¾›æ‡‰å•†ï¼š</label>
          <input type="text" id="purchaseSupplier" placeholder="ä¾›æ‡‰å•†åç¨±" />
        </div>
        <div class="form-group">
          <label>é€²è²¨æ—¥æœŸï¼š</label>
          <input type="date" id="purchaseDate" />
        </div>
        <div class="form-group">
          <label>å‚™è¨»ï¼š</label>
          <textarea id="purchaseNotes" rows="2" placeholder="é€²è²¨å–®è™Ÿã€ç™¼ç¥¨è™Ÿç¢¼ç­‰..."></textarea>
        </div>
      </div>
      <div style="margin-bottom: 15px;">
        <button class="btn btn-success" onclick="addPurchaseItem()">â• æ–°å¢é€²è²¨é …ç›®</button>
      </div>
      <div id="purchaseItemsList"></div>
      <div class="form-group" style="margin-top: 20px;">
        <div style="text-align: right; font-size: 1.2em; font-weight: bold;">
          ç¸½é€²è²¨é‡‘é¡ï¼š$<span id="totalPurchaseAmount">0.00</span>
        </div>
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeBatchPurchaseModal()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-success" onclick="saveBatchPurchase()">ç¢ºèªé€²è²¨</button>
      </div>
    </div>
  </div>

  <!-- åº«å­˜èª¿æ•´å½ˆå‡ºè¦–çª— -->
  <div id="adjustModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>åº«å­˜èª¿æ•´</h3>
        <span class="close" onclick="closeAdjustModal()">&times;</span>
      </div>
      <div id="adjustItemInfo"></div>
      <form id="adjustForm">
        <div class="form-group">
          <label>èª¿æ•´é¡å‹ï¼š</label>
          <select id="adjustType">
            <option value="in">å…¥åº«</option>
            <option value="out">å‡ºåº«</option>
            <option value="loss">æè€—</option>
            <option value="adjust">ç›¤é»èª¿æ•´</option>
          </select>
        </div>
        <div class="form-group">
          <label>èª¿æ•´æ•¸é‡ï¼š</label>
          <input type="number" id="adjustQuantity" min="0" step="0.1" required />
        </div>
        <div class="form-group">
          <label>èª¿æ•´åŸå› ï¼š</label>
          <textarea id="adjustReason" rows="3" placeholder="è«‹èªªæ˜èª¿æ•´åŸå› ..."></textarea>
        </div>
        <div style="text-align: right; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeAdjustModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ç¢ºèªèª¿æ•´</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ç¢ºèªå½ˆå‡ºè¦–çª— -->
  <div id="confirmModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="confirmTitle">ç¢ºèª</h3>
        <span class="close" onclick="closeConfirmModal()">&times;</span>
      </div>
      <div id="confirmMessage" style="margin: 20px 0; line-height: 1.6;"></div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="confirmBtn">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <!-- è¨Šæ¯å½ˆå‡ºè¦–çª— -->
  <div id="messageModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="messageTitle">è¨Šæ¯</h3>
        <span class="close" onclick="closeMessageModal()">&times;</span>
      </div>
      <div id="messageContent" style="margin: 20px 0; line-height: 1.6;"></div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-primary" onclick="closeMessageModal()">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- è¼¸å…¥å½ˆå‡ºè¦–çª— -->
  <div id="inputModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="inputTitle">è¼¸å…¥</h3>
        <span class="close" onclick="closeInputModal()">&times;</span>
      </div>
      <div id="inputMessage" style="margin: 20px 0; line-height: 1.6;"></div>
      <div class="form-group">
        <input type="text" id="inputField" style="width: 100%;" />
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeInputModal()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="inputBtn">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSKEpN_xclOhuWOQA7HiMSjsz0lNIHRb4",
      authDomain: "gukediancan.firebaseapp.com",
      projectId: "gukediancan",
      storageBucket: "gukediancan.firebasestorage.app",
      messagingSenderId: "864103354539",
      appId: "1:864103354539:web:26aabd0cc698d7a032e7ee",
      measurementId: "G-EZYMQQ5FGQ"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let inventoryData = [];
    let currentEditingItem = null;
    let currentAdjustingItem = null;
    let currentConfirmCallback = null;
    let currentInputCallback = null;
    
    // è‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±
    let autoDeductionSystem = null;

    // åˆå§‹åŒ–æ—¥æœŸç‚ºä»Šå¤©
    function initializeDates() {
      const today = new Date();
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      document.getElementById('analysisStartDate').value = weekAgo.toISOString().split('T')[0];
      document.getElementById('analysisEndDate').value = today.toISOString().split('T')[0];
    }

    // è¼‰å…¥åº«å­˜è³‡æ–™
    async function loadInventory() {
      try {
        const snapshot = await getDocs(collection(db, "inventory"));
        inventoryData = [];
        
        snapshot.forEach(doc => {
          inventoryData.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderInventoryList();
        updateStats();
        generateRestockSuggestions();
        showLowStockAlerts();
      } catch (error) {
        console.error('è¼‰å…¥åº«å­˜è³‡æ–™å¤±æ•—:', error);
      }
    }

    // æ¸²æŸ“åº«å­˜åˆ—è¡¨
    function renderInventoryList() {
      const container = document.getElementById('inventoryList');
      
      if (inventoryData.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">å°šç„¡åº«å­˜è³‡æ–™</div>';
        return;
      }

      let html = '<table class="table"><thead><tr><th>åŸæ–™åç¨±</th><th>åˆ†é¡</th><th>åº«å­˜</th><th>å–®åƒ¹</th><th>ç¸½åƒ¹å€¼</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody>';
      
      inventoryData.forEach(item => {
        const totalValue = (item.stock * item.price).toFixed(2);
        const isLowStock = item.stock <= item.minStock;
        const isOutOfStock = item.stock <= 0;
        
        let statusClass = '';
        let statusText = 'æ­£å¸¸';
        
        if (isOutOfStock) {
          statusClass = 'out-of-stock';
          statusText = 'ç¼ºè²¨';
        } else if (isLowStock) {
          statusClass = 'low-stock';
          statusText = 'ä½åº«å­˜';
        }
        
        html += `
          <tr class="${statusClass}">
            <td><strong>${item.name}</strong></td>
            <td>${item.category}</td>
            <td>${item.stock} ${item.unit}</td>
            <td>$${item.price}</td>
            <td>$${totalValue}</td>
            <td><span style="color: ${isOutOfStock ? '#f44336' : (isLowStock ? '#FF9800' : '#4CAF50')}">${statusText}</span></td>
            <td>
              <button class="btn btn-success" onclick="quickPurchase('${item.id}')" style="font-size:0.9em;">é€²è²¨</button>
              <button class="btn btn-warning" onclick="openAdjustModal('${item.id}')">èª¿æ•´</button>
              <button class="btn btn-primary" onclick="editItem('${item.id}')">ç·¨è¼¯</button>
              <button class="btn btn-danger" onclick="deleteItem('${item.id}')">åˆªé™¤</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // æ›´æ–°çµ±è¨ˆè³‡æ–™
    function updateStats() {
      const lowStockCount = inventoryData.filter(item => item.stock <= item.minStock).length;
      const totalItems = inventoryData.length;
      const totalValue = inventoryData.reduce((sum, item) => sum + (item.stock * item.price), 0);
      
      document.getElementById('lowStockCount').textContent = lowStockCount;
      document.getElementById('totalItems').textContent = totalItems;
      document.getElementById('totalValue').textContent = '$' + totalValue.toFixed(2);
      
      // è¨ˆç®—ä»Šæ—¥æ¶ˆè€—ï¼ˆé€™è£¡å¯ä»¥æ ¹æ“šå¯¦éš›è¨‚å–®è¨ˆç®—ï¼‰
      calculateTodayUsage();
    }

    // è¨ˆç®—ä»Šæ—¥æ¶ˆè€—
    async function calculateTodayUsage() {
      try {
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
        
        const q = query(
          collection(db, "orders"),
          where("timestamp", ">=", startOfDay),
          where("timestamp", "<", endOfDay)
        );
        
        const snapshot = await getDocs(q);
        let totalUsage = 0;
        
        snapshot.forEach(doc => {
          const order = doc.data();
          if (order.items) {
            totalUsage += order.items.reduce((sum, item) => sum + item.quantity, 0);
          }
        });
        
        document.getElementById('todayUsage').textContent = totalUsage;
      } catch (error) {
        console.error('è¨ˆç®—ä»Šæ—¥æ¶ˆè€—å¤±æ•—:', error);
        document.getElementById('todayUsage').textContent = '0';
      }
    }

    // é¡¯ç¤ºä½åº«å­˜è­¦å‘Š
    function showLowStockAlerts() {
      const container = document.getElementById('alertsContainer');
      const lowStockItems = inventoryData.filter(item => item.stock <= item.minStock);
      const outOfStockItems = inventoryData.filter(item => item.stock <= 0);
      
      let html = '';
      
      if (outOfStockItems.length > 0) {
        html += '<div class="alert alert-danger"><strong>âš ï¸ ç¼ºè²¨è­¦å‘Šï¼š</strong>';
        outOfStockItems.forEach(item => {
          html += `<span style="margin-right: 15px;">${item.name}</span>`;
        });
        html += '</div>';
      }
      
      if (lowStockItems.length > 0 && outOfStockItems.length === 0) {
        html += '<div class="alert alert-warning"><strong>ğŸ“¦ ä½åº«å­˜æé†’ï¼š</strong>';
        lowStockItems.forEach(item => {
          html += `<span style="margin-right: 15px;">${item.name} (å‰©é¤˜: ${item.stock}${item.unit})</span>`;
        });
        html += '</div>';
      }
      
      container.innerHTML = html;
    }

    // ç”Ÿæˆè£œè²¨å»ºè­°
    function generateRestockSuggestions() {
      const container = document.getElementById('restockSuggestions');
      const needRestockItems = inventoryData.filter(item => item.stock <= item.minStock * 1.5);
      
      if (needRestockItems.length === 0) {
        container.innerHTML = '<div class="alert alert-success">âœ… ç›®å‰æ‰€æœ‰åŸæ–™åº«å­˜å……è¶³</div>';
        return;
      }
      
      let html = '<table class="table"><thead><tr><th>åŸæ–™åç¨±</th><th>ç›®å‰åº«å­˜</th><th>å»ºè­°è£œè²¨é‡</th><th>é ä¼°æˆæœ¬</th><th>ä¾›æ‡‰å•†</th><th>æ“ä½œ</th></tr></thead><tbody>';
      
      needRestockItems.forEach(item => {
        const suggestedQuantity = Math.max(item.minStock * 3 - item.stock, 0);
        const estimatedCost = (suggestedQuantity * item.price).toFixed(2);
        
        html += `
          <tr>
            <td><strong>${item.name}</strong></td>
            <td>${item.stock} ${item.unit}</td>
            <td>${suggestedQuantity.toFixed(1)} ${item.unit}</td>
            <td>$${estimatedCost}</td>
            <td>${item.supplier || 'æœªè¨­å®š'}</td>
            <td>
              <button class="btn btn-success" onclick="quickRestock('${item.id}', ${suggestedQuantity})">å¿«é€Ÿè£œè²¨</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // æ–°å¢åŸæ–™
    async function addItem(itemData) {
      try {
        await addDoc(collection(db, "inventory"), {
          ...itemData,
          createdAt: Timestamp.now(),
          updatedAt: Timestamp.now()
        });
        
        await loadInventory();
        closeItemModal();
        showSuccessModal('æ–°å¢æˆåŠŸ', 'åŸæ–™å·²æˆåŠŸæ–°å¢');
      } catch (error) {
        console.error('æ–°å¢åŸæ–™å¤±æ•—:', error);
        showErrorModal('æ–°å¢å¤±æ•—', 'æ–°å¢åŸæ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
      }
    }

    // æ›´æ–°åŸæ–™
    async function updateItem(itemId, itemData) {
      try {
        await updateDoc(doc(db, "inventory", itemId), {
          ...itemData,
          updatedAt: Timestamp.now()
        });
        
        await loadInventory();
        closeItemModal();
        showSuccessModal('æ›´æ–°æˆåŠŸ', 'åŸæ–™è³‡è¨Šå·²æˆåŠŸæ›´æ–°');
      } catch (error) {
        console.error('æ›´æ–°åŸæ–™å¤±æ•—:', error);
        showErrorModal('æ›´æ–°å¤±æ•—', 'æ›´æ–°åŸæ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
      }
    }

    // åˆªé™¤åŸæ–™
    async function deleteItem(itemId) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      openConfirmModal(
        'ç¢ºèªåˆªé™¤',
        `ç¢ºå®šè¦åˆªé™¤åŸæ–™ã€Œ${item.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,
        async () => {
          try {
            await deleteDoc(doc(db, "inventory", itemId));
            await loadInventory();
            showSuccessModal('åˆªé™¤æˆåŠŸ', 'åŸæ–™å·²æˆåŠŸåˆªé™¤');
          } catch (error) {
            console.error('åˆªé™¤åŸæ–™å¤±æ•—:', error);
            showErrorModal('åˆªé™¤å¤±æ•—', 'åˆªé™¤åŸæ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
          }
        }
      );
    }

    // åº«å­˜èª¿æ•´
    async function adjustStock(itemId, adjustData) {
      try {
        const item = inventoryData.find(i => i.id === itemId);
        if (!item) return;
        
        let newStock = item.stock;
        
        switch (adjustData.type) {
          case 'in':
            newStock += adjustData.quantity;
            break;
          case 'out':
            newStock -= adjustData.quantity;
            break;
          case 'loss':
            newStock -= adjustData.quantity;
            break;
          case 'adjust':
            newStock = adjustData.quantity;
            break;
        }
        
        // è¨˜éŒ„èª¿æ•´æ­·å²
        await addDoc(collection(db, "stock_adjustments"), {
          itemId: itemId,
          itemName: item.name,
          type: adjustData.type,
          quantity: adjustData.quantity,
          oldStock: item.stock,
          newStock: newStock,
          reason: adjustData.reason,
          timestamp: Timestamp.now()
        });
        
        // æ›´æ–°åº«å­˜
        await updateDoc(doc(db, "inventory", itemId), {
          stock: Math.max(0, newStock),
          updatedAt: Timestamp.now()
        });
        
        await loadInventory();
        closeAdjustModal();
        showSuccessModal('èª¿æ•´æˆåŠŸ', 'åº«å­˜å·²æˆåŠŸèª¿æ•´');
      } catch (error) {
        console.error('åº«å­˜èª¿æ•´å¤±æ•—:', error);
        showErrorModal('èª¿æ•´å¤±æ•—', 'åº«å­˜èª¿æ•´æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
      }
    }

    // å¿«é€Ÿè£œè²¨
    async function quickRestock(itemId, quantity) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      openConfirmModal(
        'ç¢ºèªè£œè²¨',
        `ç¢ºå®šè¦ç‚ºã€Œ${item.name}ã€è£œè²¨ ${quantity} ${item.unit}å—ï¼Ÿ`,
        async () => {
          await adjustStock(itemId, {
            type: 'in',
            quantity: quantity,
            reason: 'ç³»çµ±å»ºè­°è£œè²¨'
          });
        }
      );
    }

    // å¿«é€Ÿé€²è²¨
    async function quickPurchase(itemId) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      openInputModal(
        'å¿«é€Ÿé€²è²¨',
        `é€²è²¨ ${item.name}\nè«‹è¼¸å…¥é€²è²¨æ•¸é‡ï¼ˆ${item.unit}ï¼‰ï¼š`,
        (quantity) => {
          if (!quantity || isNaN(quantity) || quantity <= 0) {
            showErrorModal('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é€²è²¨æ•¸é‡');
            return;
          }
          
          openInputModal(
            'ä¾›æ‡‰å•†è³‡è¨Š',
            'ä¾›æ‡‰å•†åç¨±ï¼ˆå¯é¸ï¼‰ï¼š',
            (supplier) => {
              const supplierName = supplier || 'æœªæŒ‡å®š';
              
              openConfirmModal(
                'ç¢ºèªé€²è²¨',
                `ç¢ºå®šé€²è²¨ ${item.name} ${quantity} ${item.unit} å—ï¼Ÿ\nä¾›æ‡‰å•†ï¼š${supplierName}`,
                async () => {
                  await adjustStock(itemId, {
                    type: 'in',
                    quantity: parseFloat(quantity),
                    reason: `é€²è²¨ - ä¾›æ‡‰å•†: ${supplierName}`
                  });
                }
              );
            },
            'è¼¸å…¥ä¾›æ‡‰å•†åç¨±'
          );
        },
        'è¼¸å…¥æ•¸é‡'
      );
    }

    // æ‰¹é‡é€²è²¨åŠŸèƒ½
    let purchaseItems = [];

    function openBatchPurchaseModal() {
      // åˆå§‹åŒ–æ—¥æœŸç‚ºä»Šå¤©
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('purchaseDate').value = today;
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById('purchaseSupplier').value = '';
      document.getElementById('purchaseNotes').value = '';
      purchaseItems = [];
      
      renderPurchaseItems();
      document.getElementById('batchPurchaseModal').style.display = 'block';
    }

    function closeBatchPurchaseModal() {
      document.getElementById('batchPurchaseModal').style.display = 'none';
      purchaseItems = [];
    }

    function addPurchaseItem() {
      purchaseItems.push({
        itemId: '',
        itemName: '',
        quantity: 0,
        unitPrice: 0,
        totalPrice: 0,
        unit: ''
      });
      renderPurchaseItems();
    }

    function removePurchaseItem(index) {
      purchaseItems.splice(index, 1);
      renderPurchaseItems();
      updateTotalPurchaseAmount();
    }

    function renderPurchaseItems() {
      const container = document.getElementById('purchaseItemsList');
      
      if (purchaseItems.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">å°šæœªæ–°å¢é€²è²¨é …ç›®</div>';
        updateTotalPurchaseAmount();
        return;
      }
      
      let html = '<table class="table"><thead><tr><th>åŸæ–™</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>å°è¨ˆ</th><th>æ“ä½œ</th></tr></thead><tbody>';
      
      purchaseItems.forEach((item, index) => {
        html += `
          <tr>
            <td>
              <select onchange="updatePurchaseItem(${index}, 'itemId', this.value)" style="width: 100%;">
                <option value="">é¸æ“‡åŸæ–™</option>
                ${inventoryData.map(inv => 
                  `<option value="${inv.id}" ${item.itemId === inv.id ? 'selected' : ''}>
                    ${inv.name} (${inv.unit})
                  </option>`
                ).join('')}
              </select>
            </td>
            <td>
              <input type="number" value="${item.quantity}" 
                     onchange="updatePurchaseItem(${index}, 'quantity', this.value)"
                     style="width: 80px;" min="0" step="0.1" />
              <span style="margin-left: 5px;">${item.unit}</span>
            </td>
            <td>
              <input type="number" value="${item.unitPrice}" 
                     onchange="updatePurchaseItem(${index}, 'unitPrice', this.value)"
                     style="width: 80px;" min="0" step="0.01" />
            </td>
            <td>$${item.totalPrice.toFixed(2)}</td>
            <td>
              <button class="btn btn-danger" onclick="removePurchaseItem(${index})" style="font-size: 0.9em;">ç§»é™¤</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      updateTotalPurchaseAmount();
    }

    function updatePurchaseItem(index, field, value) {
      if (field === 'itemId') {
        const selectedItem = inventoryData.find(i => i.id === value);
        if (selectedItem) {
          purchaseItems[index].itemId = value;
          purchaseItems[index].itemName = selectedItem.name;
          purchaseItems[index].unit = selectedItem.unit;
          purchaseItems[index].unitPrice = selectedItem.price; // é è¨­ç‚ºåº«å­˜ä¸­çš„å–®åƒ¹
        }
      } else if (field === 'quantity') {
        purchaseItems[index].quantity = parseFloat(value) || 0;
      } else if (field === 'unitPrice') {
        purchaseItems[index].unitPrice = parseFloat(value) || 0;
      }
      
      // è¨ˆç®—å°è¨ˆ
      purchaseItems[index].totalPrice = purchaseItems[index].quantity * purchaseItems[index].unitPrice;
      
      renderPurchaseItems();
    }

    function updateTotalPurchaseAmount() {
      const total = purchaseItems.reduce((sum, item) => sum + item.totalPrice, 0);
      document.getElementById('totalPurchaseAmount').textContent = total.toFixed(2);
    }

    async function saveBatchPurchase() {
      const supplier = document.getElementById('purchaseSupplier').value.trim();
      const purchaseDate = document.getElementById('purchaseDate').value;
      const notes = document.getElementById('purchaseNotes').value.trim();
      
      if (purchaseItems.length === 0) {
        showErrorModal('é€²è²¨é …ç›®ä¸è¶³', 'è«‹æ–°å¢è‡³å°‘ä¸€å€‹é€²è²¨é …ç›®');
        return;
      }
      
      if (!supplier) {
        showErrorModal('ä¾›æ‡‰å•†è³‡è¨Šç¼ºå¤±', 'è«‹è¼¸å…¥ä¾›æ‡‰å•†åç¨±');
        return;
      }
      
      // é©—è­‰æ‰€æœ‰é …ç›®éƒ½å·²é¸æ“‡åŸæ–™å’Œæ•¸é‡
      for (const item of purchaseItems) {
        if (!item.itemId || item.quantity <= 0) {
          showErrorModal('é€²è²¨é …ç›®ä¸å®Œæ•´', 'è«‹ç¢ºèªæ‰€æœ‰é€²è²¨é …ç›®éƒ½å·²é¸æ“‡åŸæ–™ä¸¦è¼¸å…¥æ•¸é‡');
          return;
        }
      }
      
      openConfirmModal(
        'ç¢ºèªæ‰¹é‡é€²è²¨',
        'ç¢ºå®šè¦åŸ·è¡Œæ‰¹é‡é€²è²¨å—ï¼Ÿ',
        async () => {
          try {
            const totalAmount = purchaseItems.reduce((sum, item) => sum + item.totalPrice, 0);
            
            // è¨˜éŒ„é€²è²¨å–®
            const purchaseRecord = await addDoc(collection(db, "purchase_records"), {
              supplier: supplier,
              purchaseDate: new Date(purchaseDate),
              notes: notes,
              items: purchaseItems,
              totalAmount: totalAmount,
              createdAt: Timestamp.now()
            });
            
            // é€ä¸€æ›´æ–°åº«å­˜
            for (const item of purchaseItems) {
              await adjustStock(item.itemId, {
                type: 'in',
                quantity: item.quantity,
                reason: `æ‰¹é‡é€²è²¨ - ä¾›æ‡‰å•†: ${supplier} (é€²è²¨å–®: ${purchaseRecord.id})`
              });
            }
            
            closeBatchPurchaseModal();
            showSuccessModal('é€²è²¨å®Œæˆ', 'æ‰¹é‡é€²è²¨å·²æˆåŠŸå®Œæˆ');
            
          } catch (error) {
            console.error('æ‰¹é‡é€²è²¨å¤±æ•—:', error);
            showErrorModal('é€²è²¨å¤±æ•—', 'æ‰¹é‡é€²è²¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
          }
        }
      );
    }

    // ç”Ÿæˆæˆæœ¬åˆ†æ
    async function generateCostAnalysis() {
      const startDate = document.getElementById('analysisStartDate').value;
      const endDate = document.getElementById('analysisEndDate').value;
      
      if (!startDate || !endDate) {
        showErrorModal('æ—¥æœŸæœªé¸æ“‡', 'è«‹é¸æ“‡åˆ†ææœŸé–“');
        return;
      }
      
      try {
        const start = new Date(startDate);
        const end = new Date(endDate + 'T23:59:59');
        
        // æŸ¥è©¢æœŸé–“å…§çš„åº«å­˜èª¿æ•´è¨˜éŒ„
        const adjustmentsQuery = query(
          collection(db, "stock_adjustments"),
          where("timestamp", ">=", start),
          where("timestamp", "<=", end),
          orderBy("timestamp", "desc")
        );
        
        const adjustmentsSnapshot = await getDocs(adjustmentsQuery);
        const adjustments = [];
        
        adjustmentsSnapshot.forEach(doc => {
          adjustments.push(doc.data());
        });
        
        // è¨ˆç®—æˆæœ¬åˆ†æ
        const analysis = calculateCostAnalysis(adjustments);
        renderCostAnalysis(analysis);
        
      } catch (error) {
        console.error('ç”Ÿæˆæˆæœ¬åˆ†æå¤±æ•—:', error);
        showErrorModal('åˆ†æå¤±æ•—', 'ç”Ÿæˆæˆæœ¬åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
      }
    }

    // è¨ˆç®—æˆæœ¬åˆ†æ
    function calculateCostAnalysis(adjustments) {
      const analysis = {
        totalInCost: 0,
        totalOutCost: 0,
        totalLossCost: 0,
        categoryAnalysis: {},
        topCostItems: []
      };
      
      const itemCosts = {};
      
      adjustments.forEach(adj => {
        const item = inventoryData.find(i => i.id === adj.itemId);
        if (!item) return;
        
        const cost = adj.quantity * item.price;
        
        switch (adj.type) {
          case 'in':
            analysis.totalInCost += cost;
            break;
          case 'out':
          case 'loss':
            analysis.totalOutCost += cost;
            if (adj.type === 'loss') {
              analysis.totalLossCost += cost;
            }
            break;
        }
        
        // åˆ†é¡åˆ†æ
        if (!analysis.categoryAnalysis[item.category]) {
          analysis.categoryAnalysis[item.category] = 0;
        }
        if (adj.type === 'out' || adj.type === 'loss') {
          analysis.categoryAnalysis[item.category] += cost;
        }
        
        // å•†å“æˆæœ¬çµ±è¨ˆ
        if (!itemCosts[item.name]) {
          itemCosts[item.name] = 0;
        }
        if (adj.type === 'out' || adj.type === 'loss') {
          itemCosts[item.name] += cost;
        }
      });
      
      // å–å¾—æˆæœ¬æœ€é«˜çš„å‰5é …
      analysis.topCostItems = Object.entries(itemCosts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, cost]) => ({ name, cost }));
      
      return analysis;
    }

    // æ¸²æŸ“æˆæœ¬åˆ†æçµæœ
    function renderCostAnalysis(analysis) {
      const container = document.getElementById('costAnalysisResult');
      
      let html = `
        <div class="stats-grid" style="margin-bottom: 20px;">
          <div class="stat-card info">
            <div class="stat-value">$${analysis.totalInCost.toFixed(2)}</div>
            <div class="stat-label">é€²è²¨æˆæœ¬</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-value">$${analysis.totalOutCost.toFixed(2)}</div>
            <div class="stat-label">æ¶ˆè€—æˆæœ¬</div>
          </div>
          <div class="stat-card" style="border-left: 4px solid #f44336;">
            <div class="stat-value">$${analysis.totalLossCost.toFixed(2)}</div>
            <div class="stat-label">æè€—æˆæœ¬</div>
          </div>
        </div>
      `;
      
      if (analysis.topCostItems.length > 0) {
        html += '<h4>æˆæœ¬æœ€é«˜å•†å“ TOP5</h4>';
        html += '<table class="table"><thead><tr><th>å•†å“åç¨±</th><th>æˆæœ¬</th></tr></thead><tbody>';
        
        analysis.topCostItems.forEach(item => {
          html += `<tr><td>${item.name}</td><td>$${item.cost.toFixed(2)}</td></tr>`;
        });
        
        html += '</tbody></table>';
      }
      
      if (Object.keys(analysis.categoryAnalysis).length > 0) {
        html += '<h4>åˆ†é¡æˆæœ¬åˆ†æ</h4>';
        html += '<table class="table"><thead><tr><th>åˆ†é¡</th><th>æˆæœ¬</th></tr></thead><tbody>';
        
        Object.entries(analysis.categoryAnalysis)
          .sort((a, b) => b[1] - a[1])
          .forEach(([category, cost]) => {
            html += `<tr><td>${category}</td><td>$${cost.toFixed(2)}</td></tr>`;
          });
        
        html += '</tbody></table>';
      }
      
      container.innerHTML = html;
    }

    // å½ˆå‡ºè¦–çª—æ§åˆ¶
    function openAddItemModal() {
      document.getElementById('modalTitle').textContent = 'æ–°å¢åŸæ–™';
      document.getElementById('itemForm').reset();
      currentEditingItem = null;
      document.getElementById('itemModal').style.display = 'block';
    }

    function editItem(itemId) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      document.getElementById('modalTitle').textContent = 'ç·¨è¼¯åŸæ–™';
      document.getElementById('itemName').value = item.name;
      document.getElementById('itemCategory').value = item.category;
      document.getElementById('itemStock').value = item.stock;
      document.getElementById('itemUnit').value = item.unit;
      document.getElementById('itemPrice').value = item.price;
      document.getElementById('itemMinStock').value = item.minStock;
      document.getElementById('itemSupplier').value = item.supplier || '';
      document.getElementById('itemNotes').value = item.notes || '';
      
      currentEditingItem = itemId;
      document.getElementById('itemModal').style.display = 'block';
    }

    function closeItemModal() {
      document.getElementById('itemModal').style.display = 'none';
      currentEditingItem = null;
    }

    function openAdjustModal(itemId) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;
      
      document.getElementById('adjustItemInfo').innerHTML = `
        <div class="alert alert-info">
          <strong>${item.name}</strong><br>
          ç›®å‰åº«å­˜: ${item.stock} ${item.unit}<br>
          å–®åƒ¹: $${item.price}
        </div>
      `;
      
      document.getElementById('adjustForm').reset();
      currentAdjustingItem = itemId;
      document.getElementById('adjustModal').style.display = 'block';
    }

    function closeAdjustModal() {
      document.getElementById('adjustModal').style.display = 'none';
      currentAdjustingItem = null;
    }

    // é€šç”¨ Modal å‡½æ•¸
    function openConfirmModal(title, message, callback) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
      currentConfirmCallback = callback;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
      currentConfirmCallback = null;
    }

    function showSuccessModal(title, message) {
      document.getElementById('messageTitle').textContent = title;
      document.getElementById('messageContent').innerHTML = message.replace(/\n/g, '<br>');
      document.getElementById('messageModal').style.display = 'block';
    }

    function showErrorModal(title, message) {
      document.getElementById('messageTitle').textContent = title;
      document.getElementById('messageContent').innerHTML = message.replace(/\n/g, '<br>');
      document.getElementById('messageModal').style.display = 'block';
    }

    function closeMessageModal() {
      document.getElementById('messageModal').style.display = 'none';
    }

    function openInputModal(title, message, callback, placeholder = '') {
      document.getElementById('inputTitle').textContent = title;
      document.getElementById('inputMessage').innerHTML = message.replace(/\n/g, '<br>');
      document.getElementById('inputField').placeholder = placeholder;
      document.getElementById('inputField').value = '';
      currentInputCallback = callback;
      document.getElementById('inputModal').style.display = 'block';
      document.getElementById('inputField').focus();
      
      // æ”¯æ´ Enter éµç¢ºèª
      document.getElementById('inputField').onkeypress = function(e) {
        if (e.key === 'Enter') {
          document.getElementById('inputBtn').click();
        }
      };
    }

    function closeInputModal() {
      document.getElementById('inputModal').style.display = 'none';
      currentInputCallback = null;
    }

    // è‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±é¡åˆ¥
    class AutoInventoryDeduction {
      constructor() {
        this.processedOrders = new Set();
        this.menuData = new Map();
        this.inventoryDataMap = new Map();
        this.isInitialized = false;
        this.orderListener = null;
      }

      // åˆå§‹åŒ–ç³»çµ±
      async initialize() {
        try {
          console.log('åˆå§‹åŒ–è‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±...');
          
          // è¼‰å…¥èœå–®è³‡æ–™
          await this.loadMenuData();
          
          // è¼‰å…¥åº«å­˜è³‡æ–™
          await this.loadInventoryDataMap();
          
          // è¼‰å…¥å·²è™•ç†çš„è¨‚å–®
          await this.loadProcessedOrders();
          
          // é–‹å§‹ç›£è½æ–°è¨‚å–®
          this.startOrderListener();
          
          this.isInitialized = true;
          console.log('è‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
          
          // æ›´æ–°é é¢ç‹€æ…‹é¡¯ç¤º
          this.updateStatusDisplay();
        } catch (error) {
          console.error('åˆå§‹åŒ–è‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±å¤±æ•—:', error);
        }
      }

      // è¼‰å…¥èœå–®è³‡æ–™
      async loadMenuData() {
        const snapshot = await getDocs(collection(db, "menu"));
        this.menuData.clear();
        
        snapshot.forEach(doc => {
          const data = doc.data();
          this.menuData.set(data.name, data);
        });
        
        console.log(`è¼‰å…¥äº† ${this.menuData.size} å€‹èœå–®é …ç›®`);
      }

      // è¼‰å…¥åº«å­˜è³‡æ–™
      async loadInventoryDataMap() {
        const snapshot = await getDocs(collection(db, "inventory"));
        this.inventoryDataMap.clear();
        
        snapshot.forEach(doc => {
          const data = doc.data();
          this.inventoryDataMap.set(doc.id, data);
        });
        
        console.log(`è¼‰å…¥äº† ${this.inventoryDataMap.size} å€‹åº«å­˜é …ç›®`);
      }

      // è¼‰å…¥å·²è™•ç†çš„è¨‚å–®
      async loadProcessedOrders() {
        try {
          // è¼‰å…¥éå»24å°æ™‚çš„è¨‚å–®IDï¼Œé¿å…é‡è¤‡è™•ç†
          const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);
          const q = query(
            collection(db, "orders"),
            where("timestamp", ">=", yesterday)
          );
          
          const snapshot = await getDocs(q);
          snapshot.forEach(doc => {
            this.processedOrders.add(doc.id);
          });
          
          console.log(`è¼‰å…¥äº† ${this.processedOrders.size} å€‹å·²è™•ç†è¨‚å–®`);
        } catch (error) {
          console.error('è¼‰å…¥å·²è™•ç†è¨‚å–®å¤±æ•—:', error);
        }
      }

      // é–‹å§‹ç›£è½æ–°è¨‚å–®
      startOrderListener() {
        this.orderListener = onSnapshot(collection(db, "orders"), (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
              const orderId = change.doc.id;
              const orderData = change.doc.data();
              
              // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°è¨‚å–®ï¼ˆæœªè™•ç†éçš„ï¼‰
              if (!this.processedOrders.has(orderId)) {
                console.log('ğŸ”„ ç™¼ç¾æ–°è¨‚å–®:', orderId);
                this.processOrder(orderId, orderData);
                this.processedOrders.add(orderId);
              }
            }
          });
        });
      }

      // è™•ç†è¨‚å–®ï¼Œæ‰£æ¸›åº«å­˜
      async processOrder(orderId, orderData) {
        try {
          console.log(`é–‹å§‹è™•ç†è¨‚å–® ${orderId} çš„åº«å­˜æ‰£æ¸›`);
          
          if (!orderData.items || !Array.isArray(orderData.items)) {
            console.log('è¨‚å–®æ²’æœ‰å•†å“é …ç›®ï¼Œè·³éè™•ç†');
            return;
          }

          const deductionLog = [];
          
          // è™•ç†æ¯å€‹è¨‚å–®é …ç›®
          for (const orderItem of orderData.items) {
            const menuItem = this.menuData.get(orderItem.name);
            
            if (!menuItem || !menuItem.recipe || !Array.isArray(menuItem.recipe)) {
              console.log(`å•†å“ ${orderItem.name} æ²’æœ‰è¨­å®šé…æ–¹ï¼Œè·³éåº«å­˜æ‰£æ¸›`);
              continue;
            }

            console.log(`è™•ç†å•†å“ ${orderItem.name}ï¼Œæ•¸é‡: ${orderItem.quantity}`);
            
            // è™•ç†é…æ–¹ä¸­çš„æ¯å€‹åŸæ–™
            for (const recipeItem of menuItem.recipe) {
              if (!recipeItem.ingredientId || !recipeItem.quantity) {
                continue;
              }

              const totalDeduction = recipeItem.quantity * orderItem.quantity;
              const success = await this.deductInventory(
                recipeItem.ingredientId, 
                totalDeduction, 
                orderId, 
                orderItem.name
              );

              if (success) {
                deductionLog.push({
                  ingredientId: recipeItem.ingredientId,
                  ingredientName: recipeItem.ingredientName,
                  quantity: totalDeduction,
                  unit: recipeItem.unit
                });
              }
            }
          }

          // è¨˜éŒ„æ‰£æ¸›æ­·å²
          if (deductionLog.length > 0) {
            await this.logDeduction(orderId, orderData, deductionLog);
          }

          console.log(`âœ… è¨‚å–® ${orderId} åº«å­˜æ‰£æ¸›å®Œæˆ`);
          
          // é‡æ–°è¼‰å…¥åº«å­˜é¡¯ç¤º
          await loadInventory();
          
        } catch (error) {
          console.error(`è™•ç†è¨‚å–® ${orderId} åº«å­˜æ‰£æ¸›å¤±æ•—:`, error);
        }
      }

      // æ‰£æ¸›åº«å­˜
      async deductInventory(ingredientId, quantity, orderId, itemName) {
        try {
          const inventory = this.inventoryDataMap.get(ingredientId);
          
          if (!inventory) {
            console.warn(`æ‰¾ä¸åˆ°åŸæ–™ ${ingredientId}ï¼Œç„¡æ³•æ‰£æ¸›åº«å­˜`);
            return false;
          }

          const newStock = Math.max(0, inventory.stock - quantity);
          
          // æ›´æ–°Firebaseä¸­çš„åº«å­˜
          await updateDoc(doc(db, "inventory", ingredientId), {
            stock: newStock,
            updatedAt: Timestamp.now()
          });

          // æ›´æ–°æœ¬åœ°å¿«å–
          this.inventoryDataMap.set(ingredientId, {
            ...inventory,
            stock: newStock
          });

          // è¨˜éŒ„åº«å­˜èª¿æ•´
          await addDoc(collection(db, "stock_adjustments"), {
            itemId: ingredientId,
            itemName: inventory.name,
            type: 'auto_deduction',
            quantity: quantity,
            oldStock: inventory.stock,
            newStock: newStock,
            reason: `è¨‚å–® ${orderId} - å•†å“: ${itemName}`,
            orderId: orderId,
            timestamp: Timestamp.now()
          });

          console.log(`ğŸ“¦ æˆåŠŸæ‰£æ¸› ${inventory.name}: ${quantity} ${inventory.unit}ï¼Œå‰©é¤˜: ${newStock}`);
          
          // æª¢æŸ¥ä½åº«å­˜è­¦å‘Š
          if (newStock <= inventory.minStock) {
            console.warn(`âš ï¸ ${inventory.name} åº«å­˜ä¸è¶³ï¼ç›®å‰: ${newStock}ï¼Œæœ€ä½: ${inventory.minStock}`);
            await this.sendLowStockAlert(inventory, newStock);
          }

          return true;
        } catch (error) {
          console.error(`æ‰£æ¸›åº«å­˜å¤±æ•— (${ingredientId}):`, error);
          return false;
        }
      }

      // ç™¼é€ä½åº«å­˜è­¦å‘Š
      async sendLowStockAlert(inventory, currentStock) {
        try {
          await addDoc(collection(db, "alerts"), {
            type: 'low_stock',
            itemId: inventory.id,
            itemName: inventory.name,
            currentStock: currentStock,
            minStock: inventory.minStock,
            message: `${inventory.name} åº«å­˜ä¸è¶³ï¼Œç›®å‰å‰©é¤˜ ${currentStock} ${inventory.unit}`,
            timestamp: Timestamp.now(),
            resolved: false
          });
        } catch (error) {
          console.error('ç™¼é€ä½åº«å­˜è­¦å‘Šå¤±æ•—:', error);
        }
      }

      // è¨˜éŒ„æ‰£æ¸›æ­·å²
      async logDeduction(orderId, orderData, deductionLog) {
        try {
          await addDoc(collection(db, "inventory_deductions"), {
            orderId: orderId,
            orderType: orderData.dineType,
            tableNumber: orderData.tableNumber,
            takeoutNumber: orderData.takeoutNumber,
            totalAmount: orderData.totalAmount,
            deductions: deductionLog,
            timestamp: orderData.timestamp || Timestamp.now()
          });
        } catch (error) {
          console.error('è¨˜éŒ„æ‰£æ¸›æ­·å²å¤±æ•—:', error);
        }
      }

      // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
      updateStatusDisplay() {
        const statusElement = document.getElementById('deductionStatus');
        if (statusElement) {
          statusElement.textContent = `è‡ªå‹•æ‰£æ¸›ç³»çµ±ï¼š${this.isInitialized ? 'âœ… é‹è¡Œä¸­' : 'âŒ æœªå•Ÿå‹•'}`;
          statusElement.style.color = this.isInitialized ? '#4CAF50' : '#f44336';
        }
      }

      // æ‰‹å‹•é‡æ–°è¼‰å…¥è³‡æ–™
      async reload() {
        await this.loadMenuData();
        await this.loadInventoryDataMap();
        console.log('åº«å­˜æ‰£æ¸›ç³»çµ±è³‡æ–™å·²é‡æ–°è¼‰å…¥');
      }

      // ç²å–ç³»çµ±ç‹€æ…‹
      getStatus() {
        return {
          isInitialized: this.isInitialized,
          menuItemsCount: this.menuData.size,
          inventoryItemsCount: this.inventoryDataMap.size,
          processedOrdersCount: this.processedOrders.size
        };
      }

      // åœæ­¢ç›£è½
      stop() {
        if (this.orderListener) {
          this.orderListener();
          this.orderListener = null;
        }
        this.isInitialized = false;
        this.updateStatusDisplay();
      }
    }

    // è¡¨å–®æäº¤è™•ç†
    document.getElementById('itemForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const itemData = {
        name: document.getElementById('itemName').value,
        category: document.getElementById('itemCategory').value,
        stock: parseFloat(document.getElementById('itemStock').value),
        unit: document.getElementById('itemUnit').value,
        price: parseFloat(document.getElementById('itemPrice').value),
        minStock: parseFloat(document.getElementById('itemMinStock').value),
        supplier: document.getElementById('itemSupplier').value,
        notes: document.getElementById('itemNotes').value
      };
      
      if (currentEditingItem) {
        await updateItem(currentEditingItem, itemData);
      } else {
        await addItem(itemData);
      }
    });

    document.getElementById('adjustForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const adjustData = {
        type: document.getElementById('adjustType').value,
        quantity: parseFloat(document.getElementById('adjustQuantity').value),
        reason: document.getElementById('adjustReason').value
      };
      
      if (currentAdjustingItem) {
        await adjustStock(currentAdjustingItem, adjustData);
      }
    });

    // é‡å•Ÿè‡ªå‹•æ‰£æ¸›ç³»çµ±
    async function reloadAutoDeductionSystem() {
      try {
        if (autoDeductionSystem) {
          autoDeductionSystem.stop();
          await autoDeductionSystem.reload();
          await autoDeductionSystem.initialize();
          showSuccessModal('ç³»çµ±é‡å•Ÿ', 'è‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±å·²é‡æ–°å•Ÿå‹•');
        } else {
          autoDeductionSystem = new AutoInventoryDeduction();
          await autoDeductionSystem.initialize();
          showSuccessModal('ç³»çµ±å•Ÿå‹•', 'è‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±å·²å•Ÿå‹•');
        }
      } catch (error) {
        console.error('é‡å•Ÿè‡ªå‹•æ‰£æ¸›ç³»çµ±å¤±æ•—:', error);
        showErrorModal('ç³»çµ±éŒ¯èª¤', 'é‡å•Ÿè‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±å¤±æ•—');
      }
    }

    // è¼‰å…¥è‡ªå‹•æ‰£æ¸›è¨˜éŒ„
    async function loadDeductionHistory() {
      try {
        const container = document.getElementById('deductionHistory');
        const statusSpan = document.getElementById('deductionStatus');
        
        statusSpan.textContent = 'è¼‰å…¥ä¸­...';
        
        // æŸ¥è©¢æœ€è¿‘7å¤©çš„æ‰£æ¸›è¨˜éŒ„
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const q = query(
          collection(db, "inventory_deductions"),
          where("timestamp", ">=", weekAgo),
          orderBy("timestamp", "desc")
        );
        
        const snapshot = await getDocs(q);
        const deductions = [];
        
        snapshot.forEach(doc => {
          deductions.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        if (deductions.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æœ€è¿‘7å¤©æ²’æœ‰è‡ªå‹•æ‰£æ¸›è¨˜éŒ„</div>';
          statusSpan.textContent = '';
          return;
        }
        
        let html = '<table class="table"><thead><tr><th>æ™‚é–“</th><th>è¨‚å–®ç·¨è™Ÿ</th><th>ç”¨é¤æ–¹å¼</th><th>æ‰£æ¸›åŸæ–™</th><th>è¨‚å–®é‡‘é¡</th></tr></thead><tbody>';
        
        deductions.forEach(deduction => {
          const time = deduction.timestamp ? deduction.timestamp.toDate().toLocaleString('zh-TW') : '-';
          const deductionDetails = deduction.deductions.map(d => 
            `${d.ingredientName}: ${d.quantity}${d.unit}`
          ).join('<br>');
          
          html += `
            <tr>
              <td>${time}</td>
              <td>${deduction.orderId}</td>
              <td>${deduction.orderType || '-'}</td>
              <td>${deductionDetails}</td>
              <td>$${deduction.totalAmount || 0}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        statusSpan.textContent = `å…± ${deductions.length} ç­†è¨˜éŒ„`;
        
      } catch (error) {
        console.error('è¼‰å…¥è‡ªå‹•æ‰£æ¸›è¨˜éŒ„å¤±æ•—:', error);
        document.getElementById('deductionHistory').innerHTML = 
          '<div style="text-align: center; color: #f44336; padding: 20px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</div>';
        document.getElementById('deductionStatus').textContent = '';
      }
    }

    // å…¨åŸŸå‡½æ•¸
    window.openAddItemModal = openAddItemModal;
    window.editItem = editItem;
    window.closeItemModal = closeItemModal;
    window.deleteItem = deleteItem;
    window.openAdjustModal = openAdjustModal;
    window.closeAdjustModal = closeAdjustModal;
    window.quickRestock = quickRestock;
    window.generateCostAnalysis = generateCostAnalysis;
    window.loadDeductionHistory = loadDeductionHistory;
    window.openBatchPurchaseModal = openBatchPurchaseModal;
    window.closeBatchPurchaseModal = closeBatchPurchaseModal;
    window.addPurchaseItem = addPurchaseItem;
    window.removePurchaseItem = removePurchaseItem;
    window.updatePurchaseItem = updatePurchaseItem;
    window.saveBatchPurchase = saveBatchPurchase;
    window.quickPurchase = quickPurchase;
    window.openConfirmModal = openConfirmModal;
    window.closeConfirmModal = closeConfirmModal;
    window.showSuccessModal = showSuccessModal;
    window.showErrorModal = showErrorModal;
    window.closeMessageModal = closeMessageModal;
    window.openInputModal = openInputModal;
    window.closeInputModal = closeInputModal;
    window.reloadAutoDeductionSystem = reloadAutoDeductionSystem;

    // ç™»å‡ºå‡½æ•¸
    window.logout = function() {
      signOut(auth);
    };

    // Firebase Auth
    const authContainer = document.getElementById('authContainer');
    const mainContainer = document.getElementById('mainContainer');
    const authMsg = document.getElementById('authMsg');

    document.getElementById('authLoginBtn').onclick = async function() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      authMsg.innerText = '';
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        authMsg.innerText = 'ç™»å…¥å¤±æ•—ï¼š' + (e.message || 'è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
      }
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        authContainer.style.display = 'none';
        mainContainer.style.display = 'block';
        initializeDates();
        loadInventory();
        loadDeductionHistory();
        
        // åˆå§‹åŒ–è‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±
        if (!autoDeductionSystem) {
          autoDeductionSystem = new AutoInventoryDeduction();
          autoDeductionSystem.initialize();
        }
      } else {
        mainContainer.style.display = 'none';
        authContainer.style.display = 'block';
        
        // åœæ­¢è‡ªå‹•åº«å­˜æ‰£æ¸›ç³»çµ±
        if (autoDeductionSystem) {
          autoDeductionSystem.stop();
          autoDeductionSystem = null;
        }
      }
    });

    // Modal æŒ‰éˆ•äº‹ä»¶è™•ç†
    document.getElementById('confirmBtn').onclick = function() {
      if (currentConfirmCallback) {
        currentConfirmCallback();
        closeConfirmModal();
      }
    };

    document.getElementById('inputBtn').onclick = function() {
      if (currentInputCallback) {
        const value = document.getElementById('inputField').value.trim();
        currentInputCallback(value);
        closeInputModal();
      }
    };

    // é»æ“Šå¤–éƒ¨é—œé–‰å½ˆå‡ºè¦–çª—
    window.onclick = function(event) {
      const itemModal = document.getElementById('itemModal');
      const adjustModal = document.getElementById('adjustModal');
      const confirmModal = document.getElementById('confirmModal');
      const messageModal = document.getElementById('messageModal');
      const inputModal = document.getElementById('inputModal');
      const batchPurchaseModal = document.getElementById('batchPurchaseModal');
      
      if (event.target === itemModal) {
        closeItemModal();
      }
      if (event.target === adjustModal) {
        closeAdjustModal();
      }
      if (event.target === confirmModal) {
        closeConfirmModal();
      }
      if (event.target === messageModal) {
        closeMessageModal();
      }
      if (event.target === inputModal) {
        closeInputModal();
      }
      if (event.target === batchPurchaseModal) {
        closeBatchPurchaseModal();
      }
    };
  </script>
</body>
</html> 