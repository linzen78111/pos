<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æƒ…å ±åˆ†æç³»çµ± - GèŒ¶é¤é…’é¤¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* æ¨™é¡Œå€åŸŸ */
    .header { background: #2d2320; color: #e0b873; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 1.8em; }
    .nav-buttons { display: flex; gap: 10px; }
    .nav-btn { padding: 8px 16px; background: #e0b873; color: #2d2320; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-decoration: none; }
    .nav-btn:hover { background: #d4a862; }
    
    /* æ§åˆ¶é¢æ¿ */
    .control-panel { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .control-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .control-group { display: flex; flex-direction: column; }
    .control-group label { margin-bottom: 5px; font-weight: bold; color: #2d2320; }
    .control-group input, .control-group select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    
    /* çµ±è¨ˆå¡ç‰‡ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .stat-card.revenue { border-left: 4px solid #4CAF50; }
    .stat-card.orders { border-left: 4px solid #2196F3; }
    .stat-card.items { border-left: 4px solid #FF9800; }
    .stat-card.avg { border-left: 4px solid #9C27B0; }
    .stat-value { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
    .stat-label { color: #666; font-size: 0.9em; }
    .stat-change { margin-top: 10px; font-size: 0.8em; }
    .stat-change.positive { color: #4CAF50; }
    .stat-change.negative { color: #f44336; }
    
    /* åœ–è¡¨å€åŸŸ */
    .chart-section { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .chart-header h3 { margin: 0; color: #2d2320; }
    .chart-container { height: 400px; margin: 20px 0; }
    .chart-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .chart-tab { padding: 8px 16px; background: #f5f5f5; border: none; border-radius: 6px; cursor: pointer; }
    .chart-tab.active { background: #e0b873; color: #2d2320; font-weight: bold; }
    
    /* è¡¨æ ¼æ¨£å¼ */
    .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .table th { background: #f8f8f8; font-weight: bold; color: #2d2320; }
    .table tr:hover { background: #f9f9f9; }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 2px; }
    .btn-primary { background: #2196F3; color: white; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-warning { background: #FF9800; color: white; }
    .btn:hover { opacity: 0.8; }
    
    /* æ™‚æ®µåˆ†æ */
    .time-slot-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
    .time-slot-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid transparent; }
    .time-slot-card.peak { border-color: #e74c3c; background: #ffeaa7; }
    .time-slot-card.high { border-color: #f39c12; background: #fab1a0; }
    .time-slot-card.normal { border-color: #74b9ff; background: #81ecec; }
    .time-slot-card.low { border-color: #a29bfe; background: #fd79a8; }
    .time-slot-title { font-weight: bold; margin-bottom: 5px; }
    .time-slot-value { font-size: 1.2em; color: #2d2320; }
    
    /* å•†å“æ’è¡Œ */
    .product-ranking { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .ranking-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
    .ranking-item:last-child { border-bottom: none; }
    .ranking-position { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
    .ranking-position.gold { background: #f39c12; }
    .ranking-position.silver { background: #95a5a6; }
    .ranking-position.bronze { background: #cd7f32; }
    .ranking-position.normal { background: #74b9ff; }
    .ranking-info { flex: 1; margin-left: 15px; }
    .ranking-name { font-weight: bold; }
    .ranking-details { font-size: 0.9em; color: #666; }
    .ranking-value { font-weight: bold; color: #2d2320; }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .control-row { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .product-ranking { grid-template-columns: 1fr; }
      .time-slot-grid { grid-template-columns: repeat(2, 1fr); }
      .header { flex-direction: column; gap: 15px; }
      .nav-buttons { flex-wrap: wrap; justify-content: center; }
      .chart-header { flex-direction: column; gap: 10px; }
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥å€åŸŸ -->
  <div class="container" id="authContainer" style="display:none;max-width:400px;margin:100px auto;">
    <div class="control-panel">
      <h2>æƒ…å ±åˆ†æç™»å…¥</h2>
      <div class="control-group">
        <input type="email" id="authEmail" placeholder="Email" />
      </div>
      <div class="control-group">
        <input type="password" id="authPassword" placeholder="å¯†ç¢¼" />
      </div>
      <button id="authLoginBtn" class="btn btn-primary" style="width:100%;">ç™»å…¥</button>
      <div id="authMsg" style="color:#f44336;margin-top:15px;text-align:center;"></div>
    </div>
  </div>

  <!-- ä¸»è¦å…§å®¹ -->
  <div class="container" id="mainContainer" style="display:none;">
    <div class="header">
      <h1>ğŸ“Š æƒ…å ±åˆ†æç³»çµ±</h1>
      <div class="nav-buttons">
        <a href="kitchen_orders.html" class="nav-btn">ğŸ³ å»šæˆ¿çœ‹æ¿</a>
        <a href="menu_admin.html" class="nav-btn">ğŸ½ï¸ èœå–®ç®¡ç†</a>
        <a href="daily_report.html" class="nav-btn">ğŸ“‹ æ—¥çµå¸³</a>
        <a href="inventory_management.html" class="nav-btn">ğŸ“¦ åº«å­˜ç®¡ç†</a>
        <a href="system_settings.html" class="nav-btn">âš™ï¸ ç³»çµ±è¨­å®š</a>
        <button class="nav-btn" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
      <h3>ğŸ“… åˆ†ææ¢ä»¶è¨­å®š</h3>
      <div class="control-row">
        <div class="control-group">
          <label>é–‹å§‹æ—¥æœŸï¼š</label>
          <input type="date" id="startDate" />
        </div>
        <div class="control-group">
          <label>çµæŸæ—¥æœŸï¼š</label>
          <input type="date" id="endDate" />
        </div>
        <div class="control-group">
          <label>æ¯”è¼ƒæœŸé–“ï¼š</label>
          <select id="compareType">
            <option value="none">ä¸æ¯”è¼ƒ</option>
            <option value="previous">å‰ä¸€æœŸé–“</option>
            <option value="lastYear">å»å¹´åŒæœŸ</option>
          </select>
        </div>
        <div class="control-group">
          <label>ç”¨é¤æ–¹å¼ï¼š</label>
          <select id="dineTypeFilter">
            <option value="all">å…¨éƒ¨</option>
            <option value="å…§ç”¨">å…§ç”¨</option>
            <option value="å¤–å¸¶">å¤–å¸¶</option>
          </select>
        </div>
      </div>
      <div style="text-align: center; margin-top: 15px;">
        <button class="btn btn-primary" onclick="generateAnalysis()">ğŸ” ç”Ÿæˆåˆ†æå ±å‘Š</button>
        <button class="btn btn-success" onclick="exportReport()">ğŸ“¤ åŒ¯å‡ºå ±å‘Š</button>
      </div>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card revenue">
        <div class="stat-value" id="totalRevenue">$0</div>
        <div class="stat-label">ç¸½ç‡Ÿæ¥­é¡</div>
        <div class="stat-change" id="revenueChange"></div>
      </div>
      <div class="stat-card orders">
        <div class="stat-value" id="totalOrders">0</div>
        <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
        <div class="stat-change" id="ordersChange"></div>
      </div>
      <div class="stat-card items">
        <div class="stat-value" id="totalItems">0</div>
        <div class="stat-label">ç¸½å•†å“æ•¸</div>
        <div class="stat-change" id="itemsChange"></div>
      </div>
      <div class="stat-card avg">
        <div class="stat-value" id="avgOrder">$0</div>
        <div class="stat-label">å¹³å‡å®¢å–®åƒ¹</div>
        <div class="stat-change" id="avgChange"></div>
      </div>
    </div>

    <!-- æ™‚æ®µåˆ†æ -->
    <div class="chart-section">
      <div class="chart-header">
        <h3>â° æ™‚æ®µéŠ·å”®åˆ†æ</h3>
        <div class="chart-tabs">
          <button class="chart-tab active" onclick="switchTimeChart('hourly')">æ¯å°æ™‚</button>
          <button class="chart-tab" onclick="switchTimeChart('daily')">æ¯æ—¥</button>
          <button class="chart-tab" onclick="switchTimeChart('weekly')">æ¯é€±</button>
        </div>
      </div>
      <div class="time-slot-grid" id="timeSlotGrid">
        <!-- æ™‚æ®µæ•¸æ“šå°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
      </div>
      <div class="chart-container" id="timeChart">
        <canvas id="timeChartCanvas"></canvas>
      </div>
    </div>

    <!-- å•†å“éŠ·å”®åˆ†æ -->
    <div class="chart-section">
      <div class="chart-header">
        <h3>ğŸ›ï¸ å•†å“éŠ·å”®åˆ†æ</h3>
        <div class="chart-tabs">
          <button class="chart-tab active" onclick="switchProductChart('ranking')">éŠ·å”®æ’è¡Œ</button>
          <button class="chart-tab" onclick="switchProductChart('revenue')">ç‡Ÿæ”¶æ’è¡Œ</button>
          <button class="chart-tab" onclick="switchProductChart('category')">åˆ†é¡åˆ†æ</button>
        </div>
      </div>
      <div class="product-ranking" id="productRanking">
        <!-- å•†å“æ’è¡Œå°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
      </div>
      <div class="chart-container" id="productChart">
        <canvas id="productChartCanvas"></canvas>
      </div>
    </div>

    <!-- è©³ç´°æ•¸æ“šè¡¨ -->
    <div class="chart-section">
      <div class="chart-header">
        <h3>ğŸ“‹ è©³ç´°æ•¸æ“šè¡¨</h3>
      </div>
      <div id="detailTable">
        <!-- è©³ç´°æ•¸æ“šè¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSKEpN_xclOhuWOQA7HiMSjsz0lNIHRb4",
      authDomain: "gukediancan.firebaseapp.com",
      projectId: "gukediancan",
      storageBucket: "gukediancan.firebasestorage.app",
      messagingSenderId: "864103354539",
      appId: "1:864103354539:web:26aabd0cc698d7a032e7ee",
      measurementId: "G-EZYMQQ5FGQ"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentAnalysisData = null;
    let currentTimeChart = 'hourly';
    let currentProductChart = 'ranking';

    // åˆå§‹åŒ–æ—¥æœŸ
    function initializeDates() {
      const today = new Date();
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
      document.getElementById('endDate').value = today.toISOString().split('T')[0];
    }

    // ç”Ÿæˆåˆ†æå ±å‘Š
    async function generateAnalysis() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const compareType = document.getElementById('compareType').value;
      const dineTypeFilter = document.getElementById('dineTypeFilter').value;
      
      if (!startDate || !endDate) {
        alert('è«‹é¸æ“‡åˆ†ææ—¥æœŸç¯„åœ');
        return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
        alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
        return;
      }
      
      try {
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        showLoadingState();
        
        // è¼‰å…¥è¨‚å–®æ•¸æ“š
        const ordersData = await loadOrdersData(startDate, endDate, dineTypeFilter);
        
        // è¼‰å…¥æ¯”è¼ƒæ•¸æ“š
        let compareData = null;
        if (compareType !== 'none') {
          compareData = await loadCompareData(startDate, endDate, compareType, dineTypeFilter);
        }
        
        // åˆ†ææ•¸æ“š
        currentAnalysisData = analyzeData(ordersData, compareData);
        
        // æ¸²æŸ“çµæœ
        renderAnalysisResults();
        
      } catch (error) {
        console.error('ç”Ÿæˆåˆ†æå ±å‘Šå¤±æ•—:', error);
        alert('ç”Ÿæˆåˆ†æå ±å‘Šå¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }

    // è¼‰å…¥è¨‚å–®æ•¸æ“š
    async function loadOrdersData(startDate, endDate, dineTypeFilter) {
      const start = new Date(startDate);
      const end = new Date(endDate + 'T23:59:59');
      
      let q = query(
        collection(db, "orders"),
        where("timestamp", ">=", start),
        where("timestamp", "<=", end),
        orderBy("timestamp", "desc")
      );
      
      const snapshot = await getDocs(q);
      const orders = [];
      
      snapshot.forEach(doc => {
        const data = doc.data();
        if (dineTypeFilter === 'all' || data.dineType === dineTypeFilter) {
          orders.push({
            id: doc.id,
            ...data,
            timestamp: data.timestamp.toDate()
          });
        }
      });
      
      return orders;
    }

    // è¼‰å…¥æ¯”è¼ƒæ•¸æ“š
    async function loadCompareData(startDate, endDate, compareType, dineTypeFilter) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
      
      let compareStart, compareEnd;
      
      if (compareType === 'previous') {
        compareEnd = new Date(start.getTime() - 24 * 60 * 60 * 1000);
        compareStart = new Date(compareEnd.getTime() - daysDiff * 24 * 60 * 60 * 1000);
      } else if (compareType === 'lastYear') {
        compareStart = new Date(start.getFullYear() - 1, start.getMonth(), start.getDate());
        compareEnd = new Date(end.getFullYear() - 1, end.getMonth(), end.getDate());
      }
      
      return await loadOrdersData(
        compareStart.toISOString().split('T')[0],
        compareEnd.toISOString().split('T')[0],
        dineTypeFilter
      );
    }

    // åˆ†ææ•¸æ“š
    function analyzeData(orders, compareOrders = null) {
      const analysis = {
        basic: calculateBasicStats(orders),
        timeSlots: analyzeTimeSlots(orders),
        products: analyzeProducts(orders),
        categories: analyzeCategories(orders),
        trends: analyzeTrends(orders),
        compare: compareOrders ? calculateBasicStats(compareOrders) : null
      };
      
      return analysis;
    }

    // è¨ˆç®—åŸºæœ¬çµ±è¨ˆ
    function calculateBasicStats(orders) {
      const totalRevenue = orders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const totalOrders = orders.length;
      const totalItems = orders.reduce((sum, order) => {
        return sum + (order.items ? order.items.reduce((itemSum, item) => itemSum + item.quantity, 0) : 0);
      }, 0);
      const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
      
      return {
        totalRevenue,
        totalOrders,
        totalItems,
        avgOrderValue
      };
    }

    // åˆ†ææ™‚æ®µ
    function analyzeTimeSlots(orders) {
      const hourlyData = {};
      const dailyData = {};
      const weeklyData = {};
      
      orders.forEach(order => {
        const date = order.timestamp;
        const hour = date.getHours();
        const day = date.getDay(); // 0=Sunday, 1=Monday, ...
        const dateStr = date.toISOString().split('T')[0];
        
        // æ¯å°æ™‚çµ±è¨ˆ
        if (!hourlyData[hour]) {
          hourlyData[hour] = { revenue: 0, orders: 0, items: 0 };
        }
        hourlyData[hour].revenue += order.totalAmount || 0;
        hourlyData[hour].orders += 1;
        hourlyData[hour].items += order.items ? order.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
        
        // æ¯æ—¥çµ±è¨ˆ
        if (!dailyData[dateStr]) {
          dailyData[dateStr] = { revenue: 0, orders: 0, items: 0 };
        }
        dailyData[dateStr].revenue += order.totalAmount || 0;
        dailyData[dateStr].orders += 1;
        dailyData[dateStr].items += order.items ? order.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
        
        // æ¯é€±çµ±è¨ˆ
        const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
        const weekDay = weekDays[day];
        if (!weeklyData[weekDay]) {
          weeklyData[weekDay] = { revenue: 0, orders: 0, items: 0 };
        }
        weeklyData[weekDay].revenue += order.totalAmount || 0;
        weeklyData[weekDay].orders += 1;
        weeklyData[weekDay].items += order.items ? order.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
      });
      
      return { hourlyData, dailyData, weeklyData };
    }

    // åˆ†æå•†å“
    function analyzeProducts(orders) {
      const productStats = {};
      
      orders.forEach(order => {
        if (order.items) {
          order.items.forEach(item => {
            if (!productStats[item.name]) {
              productStats[item.name] = {
                name: item.name,
                quantity: 0,
                revenue: 0,
                orders: 0
              };
            }
            productStats[item.name].quantity += item.quantity;
            productStats[item.name].revenue += item.subtotal || (item.price * item.quantity);
          });
        }
      });
      
      return Object.values(productStats);
    }

    // åˆ†æåˆ†é¡
    function analyzeCategories(orders) {
      // é€™è£¡éœ€è¦è¼‰å…¥èœå–®æ•¸æ“šä¾†å–å¾—åˆ†é¡è³‡è¨Š
      // ç°¡åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥è¿”å›åŸºæœ¬çµ±è¨ˆ
      return {};
    }

    // åˆ†æè¶¨å‹¢
    function analyzeTrends(orders) {
      // åˆ†æéŠ·å”®è¶¨å‹¢
      const dailyTrends = {};
      
      orders.forEach(order => {
        const dateStr = order.timestamp.toISOString().split('T')[0];
        if (!dailyTrends[dateStr]) {
          dailyTrends[dateStr] = { revenue: 0, orders: 0 };
        }
        dailyTrends[dateStr].revenue += order.totalAmount || 0;
        dailyTrends[dateStr].orders += 1;
      });
      
      return dailyTrends;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    function showLoadingState() {
      document.getElementById('totalRevenue').textContent = 'è¼‰å…¥ä¸­...';
      document.getElementById('totalOrders').textContent = 'è¼‰å…¥ä¸­...';
      document.getElementById('totalItems').textContent = 'è¼‰å…¥ä¸­...';
      document.getElementById('avgOrder').textContent = 'è¼‰å…¥ä¸­...';
    }

    // æ¸²æŸ“åˆ†æçµæœ
    function renderAnalysisResults() {
      if (!currentAnalysisData) return;
      
      renderBasicStats();
      renderTimeSlots();
      renderProductRanking();
      renderDetailTable();
    }

    // æ¸²æŸ“åŸºæœ¬çµ±è¨ˆ
    function renderBasicStats() {
      const { basic, compare } = currentAnalysisData;
      
      document.getElementById('totalRevenue').textContent = `$${basic.totalRevenue.toFixed(0)}`;
      document.getElementById('totalOrders').textContent = basic.totalOrders;
      document.getElementById('totalItems').textContent = basic.totalItems;
      document.getElementById('avgOrder').textContent = `$${basic.avgOrderValue.toFixed(0)}`;
      
      // é¡¯ç¤ºæ¯”è¼ƒæ•¸æ“š
      if (compare) {
        const revenueChange = ((basic.totalRevenue - compare.totalRevenue) / compare.totalRevenue * 100).toFixed(1);
        const ordersChange = ((basic.totalOrders - compare.totalOrders) / compare.totalOrders * 100).toFixed(1);
        const itemsChange = ((basic.totalItems - compare.totalItems) / compare.totalItems * 100).toFixed(1);
        const avgChange = ((basic.avgOrderValue - compare.avgOrderValue) / compare.avgOrderValue * 100).toFixed(1);
        
        document.getElementById('revenueChange').textContent = `${revenueChange > 0 ? '+' : ''}${revenueChange}%`;
        document.getElementById('ordersChange').textContent = `${ordersChange > 0 ? '+' : ''}${ordersChange}%`;
        document.getElementById('itemsChange').textContent = `${itemsChange > 0 ? '+' : ''}${itemsChange}%`;
        document.getElementById('avgChange').textContent = `${avgChange > 0 ? '+' : ''}${avgChange}%`;
        
        document.getElementById('revenueChange').className = `stat-change ${revenueChange >= 0 ? 'positive' : 'negative'}`;
        document.getElementById('ordersChange').className = `stat-change ${ordersChange >= 0 ? 'positive' : 'negative'}`;
        document.getElementById('itemsChange').className = `stat-change ${itemsChange >= 0 ? 'positive' : 'negative'}`;
        document.getElementById('avgChange').className = `stat-change ${avgChange >= 0 ? 'positive' : 'negative'}`;
      }
    }

    // æ¸²æŸ“æ™‚æ®µåˆ†æ
    function renderTimeSlots() {
      const { timeSlots } = currentAnalysisData;
      const container = document.getElementById('timeSlotGrid');
      
      let data, title;
      if (currentTimeChart === 'hourly') {
        data = timeSlots.hourlyData;
        title = 'å°æ™‚';
      } else if (currentTimeChart === 'daily') {
        data = timeSlots.dailyData;
        title = 'æ—¥æœŸ';
      } else {
        data = timeSlots.weeklyData;
        title = 'æ˜ŸæœŸ';
      }
      
      const maxRevenue = Math.max(...Object.values(data).map(d => d.revenue));
      
      let html = '';
      Object.entries(data).forEach(([key, value]) => {
        const percentage = maxRevenue > 0 ? (value.revenue / maxRevenue) : 0;
        let level = 'low';
        if (percentage > 0.8) level = 'peak';
        else if (percentage > 0.6) level = 'high';
        else if (percentage > 0.3) level = 'normal';
        
        const displayKey = currentTimeChart === 'hourly' ? `${key}:00` : key;
        
        html += `
          <div class="time-slot-card ${level}">
            <div class="time-slot-title">${displayKey}</div>
            <div class="time-slot-value">$${value.revenue.toFixed(0)}</div>
            <div style="font-size: 0.8em; color: #666;">${value.orders} å–®</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // æ¸²æŸ“å•†å“æ’è¡Œ
    function renderProductRanking() {
      const { products } = currentAnalysisData;
      const container = document.getElementById('productRanking');
      
      let sortedProducts;
      if (currentProductChart === 'ranking') {
        sortedProducts = products.sort((a, b) => b.quantity - a.quantity);
      } else {
        sortedProducts = products.sort((a, b) => b.revenue - a.revenue);
      }
      
      const topProducts = sortedProducts.slice(0, 10);
      const bottomProducts = sortedProducts.slice(-10).reverse();
      
      let html = `
        <div class="ranking-card">
          <h4>ğŸ† TOP 10 ${currentProductChart === 'ranking' ? 'éŠ·é‡' : 'ç‡Ÿæ”¶'}æ’è¡Œ</h4>
          ${topProducts.map((product, index) => {
            let positionClass = 'normal';
            if (index === 0) positionClass = 'gold';
            else if (index === 1) positionClass = 'silver';
            else if (index === 2) positionClass = 'bronze';
            
            return `
              <div class="ranking-item">
                <div class="ranking-position ${positionClass}">${index + 1}</div>
                <div class="ranking-info">
                  <div class="ranking-name">${product.name}</div>
                  <div class="ranking-details">
                    éŠ·é‡: ${product.quantity} | ç‡Ÿæ”¶: $${product.revenue.toFixed(0)}
                  </div>
                </div>
                <div class="ranking-value">
                  ${currentProductChart === 'ranking' ? product.quantity : `$${product.revenue.toFixed(0)}`}
                </div>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="ranking-card">
          <h4>ğŸ“‰ å¾…æ”¹å–„å•†å“</h4>
          ${bottomProducts.map((product, index) => `
            <div class="ranking-item">
              <div class="ranking-position normal">${sortedProducts.length - bottomProducts.length + index + 1}</div>
              <div class="ranking-info">
                <div class="ranking-name">${product.name}</div>
                <div class="ranking-details">
                  éŠ·é‡: ${product.quantity} | ç‡Ÿæ”¶: $${product.revenue.toFixed(0)}
                </div>
              </div>
              <div class="ranking-value">
                ${currentProductChart === 'ranking' ? product.quantity : `$${product.revenue.toFixed(0)}`}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      container.innerHTML = html;
    }

    // æ¸²æŸ“è©³ç´°æ•¸æ“šè¡¨
    function renderDetailTable() {
      const { products } = currentAnalysisData;
      const container = document.getElementById('detailTable');
      
      let html = `
        <table class="table">
          <thead>
            <tr>
              <th>å•†å“åç¨±</th>
              <th>éŠ·å”®æ•¸é‡</th>
              <th>éŠ·å”®é‡‘é¡</th>
              <th>å¹³å‡å–®åƒ¹</th>
              <th>å¸‚å ´ä½”æœ‰ç‡</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      const totalRevenue = products.reduce((sum, p) => sum + p.revenue, 0);
      const totalQuantity = products.reduce((sum, p) => sum + p.quantity, 0);
      
      products.sort((a, b) => b.revenue - a.revenue).forEach(product => {
        const avgPrice = product.quantity > 0 ? product.revenue / product.quantity : 0;
        const marketShare = totalRevenue > 0 ? (product.revenue / totalRevenue * 100).toFixed(1) : 0;
        
        html += `
          <tr>
            <td>${product.name}</td>
            <td>${product.quantity}</td>
            <td>$${product.revenue.toFixed(0)}</td>
            <td>$${avgPrice.toFixed(0)}</td>
            <td>${marketShare}%</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
    }

    // åˆ‡æ›æ™‚æ®µåœ–è¡¨
    function switchTimeChart(type) {
      currentTimeChart = type;
      document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      if (currentAnalysisData) {
        renderTimeSlots();
      }
    }

    // åˆ‡æ›å•†å“åœ–è¡¨
    function switchProductChart(type) {
      currentProductChart = type;
      document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      if (currentAnalysisData) {
        renderProductRanking();
      }
    }

    // åŒ¯å‡ºå ±å‘Š
    function exportReport() {
      if (!currentAnalysisData) {
        alert('è«‹å…ˆç”Ÿæˆåˆ†æå ±å‘Š');
        return;
      }
      
      // ç°¡åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥ä¸‹è¼‰JSON
      const dataStr = JSON.stringify(currentAnalysisData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `analytics_report_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    // å…¨åŸŸå‡½æ•¸
    window.generateAnalysis = generateAnalysis;
    window.exportReport = exportReport;
    window.switchTimeChart = switchTimeChart;
    window.switchProductChart = switchProductChart;
    window.logout = function() {
      signOut(auth);
    };

    // Firebase Auth
    const authContainer = document.getElementById('authContainer');
    const mainContainer = document.getElementById('mainContainer');
    const authMsg = document.getElementById('authMsg');

    document.getElementById('authLoginBtn').onclick = async function() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      authMsg.innerText = '';
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        authMsg.innerText = 'ç™»å…¥å¤±æ•—ï¼š' + (e.message || 'è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
      }
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        authContainer.style.display = 'none';
        mainContainer.style.display = 'block';
        initializeDates();
      } else {
        mainContainer.style.display = 'none';
        authContainer.style.display = 'block';
      }
    });
  </script>
</body>
</html> 