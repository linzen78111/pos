<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ—¥çµå¸³å ±è¡¨ - GèŒ¶é¤é…’é¤¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: #2d2320; color: #e0b873; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 1.8em; }
    .date-selector { display: flex; gap: 10px; align-items: center; }
    .date-selector input { padding: 8px; border: 1px solid #e0b873; border-radius: 6px; background: #3e2f28; color: #e0b873; }
    .date-selector button { padding: 8px 16px; background: #e0b873; color: #2d2320; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .stat-card h3 { margin: 0 0 10px 0; color: #2d2320; font-size: 1.1em; }
    .stat-value { font-size: 2em; font-weight: bold; color: #e0b873; margin: 10px 0; }
    .stat-label { color: #666; font-size: 0.9em; }
    
    .section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .section h2 { margin: 0 0 15px 0; color: #2d2320; border-bottom: 2px solid #e0b873; padding-bottom: 10px; }
    
    .order-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .order-table th, .order-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    .order-table th { background: #f8f8f8; font-weight: bold; color: #2d2320; }
    .order-table tr:hover { background: #f9f9f9; }
    
    .summary-row { background: #e0b873; color: #2d2320; font-weight: bold; }
    .summary-row td { border-bottom: none; }
    
    .loading { text-align: center; color: #666; padding: 20px; }
    .no-data { text-align: center; color: #999; padding: 40px; }
    
    .print-btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; margin-top: 15px; }
    .print-btn:hover { background: #45a049; }
    
    .logout-btn { background: #f44336; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
    .logout-btn:hover { background: #da190b; }
    
    .chart-container { height: 300px; margin: 20px 0; }
    
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 15px; }
      .date-selector { flex-direction: column; }
      .order-table { font-size: 0.9em; }
      .order-table th, .order-table td { padding: 8px 4px; }
    }
    
    @media print {
      body { background: white !important; margin: 0 !important; padding: 0 !important; }
      .header, .print-btn, .logout-btn, .date-selector { display: none !important; }
      .container { max-width: 80mm !important; width: 100% !important; margin: 0 auto !important; padding: 2mm !important; }
      .section { box-shadow: none !important; border: none !important; margin: 0 !important; padding: 2mm 0 !important; }
      .section h2 { font-size: 14px !important; margin: 2mm 0 !important; text-align: center !important; border-bottom: 1px solid #000 !important; padding-bottom: 1mm !important; }
      .stats-grid { display: block !important; }
      .stat-card { background: none !important; box-shadow: none !important; padding: 1mm !important; margin: 1mm 0 !important; border: 1px solid #000 !important; }
      .stat-card h3 { font-size: 10px !important; margin: 0 !important; }
      .stat-value { font-size: 12px !important; margin: 1mm 0 !important; }
      .stat-label { font-size: 8px !important; }
      .order-table { font-size: 8px !important; width: 100% !important; }
      .order-table th, .order-table td { padding: 0.5mm !important; border: 1px solid #000 !important; }
      .order-table th { background: #f0f0f0 !important; font-weight: bold !important; }
      .summary-row { background: #000 !important; color: white !important; }
      .no-data { font-size: 8px !important; padding: 2mm !important; }
      .loading { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="container" id="authContainer" style="display:none;max-width:400px;margin:100px auto;">
    <div class="section">
      <h2>ç®¡ç†å“¡ç™»å…¥</h2>
      <input type="email" id="authEmail" placeholder="Email" style="width:100%;font-size:1.1em;padding:10px;margin-bottom:15px;border:1px solid #ddd;border-radius:6px;" />
      <input type="password" id="authPassword" placeholder="å¯†ç¢¼" style="width:100%;font-size:1.1em;padding:10px;margin-bottom:20px;border:1px solid #ddd;border-radius:6px;" />
      <button id="authLoginBtn" style="width:100%;padding:12px 0;font-size:1.1em;background:#e0b873;color:#2d2320;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">ç™»å…¥</button>
      <div id="authMsg" style="color:#f44336;margin-top:15px;text-align:center;"></div>
    </div>
  </div>

  <div class="container" id="mainContainer" style="display:none;">
    <div class="header">
      <h1>ğŸ“Š æ—¥çµå¸³å ±è¡¨</h1>
      <div class="date-selector">
        <a href="kitchen_orders.html" style="background:#3bb4c1;color:white;text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:bold;margin-right:10px;">ğŸ³ å»šæˆ¿çœ‹æ¿</a>
        <a href="inventory_management.html" style="background:#9C27B0;color:white;text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:bold;margin-right:10px;">ğŸ“¦ åº«å­˜ç®¡ç†</a>
        <a href="analytics.html" style="background:#2196F3;color:white;text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:bold;margin-right:10px;">ğŸ“Š æƒ…å ±åˆ†æ</a>
        <a href="system_settings.html" style="background:#795548;color:white;text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:bold;margin-right:10px;">âš™ï¸ ç³»çµ±è¨­å®š</a>
        <input type="date" id="selectedDate" />
        <button onclick="loadDailyReport()">æŸ¥è©¢</button>
        <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>ğŸ“ˆ ç¸½ç‡Ÿæ¥­é¡</h3>
        <div class="stat-value" id="totalRevenue">$0</div>
        <div class="stat-label">ä»Šæ—¥ç¸½æ”¶å…¥</div>
      </div>
      <div class="stat-card">
        <h3>ğŸ›’ è¨‚å–®æ•¸é‡</h3>
        <div class="stat-value" id="totalOrders">0</div>
        <div class="stat-label">å®Œæˆè¨‚å–®</div>
      </div>
      <div class="stat-card">
        <h3>ğŸ½ï¸ å…§ç”¨ç‡Ÿæ”¶</h3>
        <div class="stat-value" id="dineInRevenue">$0</div>
        <div class="stat-label" id="dineInCount">0 ç­†è¨‚å–®</div>
      </div>
      <div class="stat-card">
        <h3>ğŸ¥¡ å¤–å¸¶ç‡Ÿæ”¶</h3>
        <div class="stat-value" id="takeOutRevenue">$0</div>
        <div class="stat-label" id="takeOutCount">0 ç­†è¨‚å–®</div>
      </div>
    </div>

    <div class="section">
      <h2>ğŸ”¥ ç†±éŠ·å•†å“æ’è¡Œ</h2>
      <div id="hotItemsChart">
        <div class="loading">è¼‰å…¥ä¸­...</div>
      </div>
    </div>

    <div class="section">
      <h2>ğŸ“‹ è¨‚å–®æ˜ç´°</h2>
      <button class="print-btn" onclick="printReport()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨</button>
      <button class="print-btn" onclick="printThermalReport()" style="background:#FF9800;margin-left:10px;">ğŸ§¾ å‡ºå–®æ©Ÿåˆ—å°</button>
      <div id="orderDetails">
        <div class="loading">è¼‰å…¥ä¸­...</div>
      </div>
    </div>

    <div class="section">
      <h2>ğŸ’° æ”¶å…¥çµ±è¨ˆ</h2>
      <div id="revenueBreakdown">
        <div class="loading">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSKEpN_xclOhuWOQA7HiMSjsz0lNIHRb4",
      authDomain: "gukediancan.firebaseapp.com",
      projectId: "gukediancan",
      storageBucket: "gukediancan.firebasestorage.app",
      messagingSenderId: "864103354539",
      appId: "1:864103354539:web:26aabd0cc698d7a032e7ee",
      measurementId: "G-EZYMQQ5FGQ"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentDateOrders = [];

    // åˆå§‹åŒ–æ—¥æœŸç‚ºä»Šå¤©
    function initializeDate() {
      const today = new Date();
      const dateStr = today.getFullYear() + '-' + 
                     (today.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                     today.getDate().toString().padStart(2, '0');
      document.getElementById('selectedDate').value = dateStr;
    }

    // è¼‰å…¥æ—¥çµå ±è¡¨
    async function loadDailyReport() {
      const selectedDate = document.getElementById('selectedDate').value;
      if (!selectedDate) {
        alert('è«‹é¸æ“‡æ—¥æœŸ');
        return;
      }

      try {
        // è¨­å®šæŸ¥è©¢æ—¥æœŸç¯„åœ
        const startDate = new Date(selectedDate + 'T00:00:00');
        const endDate = new Date(selectedDate + 'T23:59:59');
        
        // æŸ¥è©¢ç•¶æ—¥è¨‚å–®
        const q = query(
          collection(db, "orders"),
          where("timestamp", ">=", startDate),
          where("timestamp", "<=", endDate),
          orderBy("timestamp", "desc")
        );
        
        const snapshot = await getDocs(q);
        currentDateOrders = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          currentDateOrders.push({
            id: doc.id,
            ...data,
            timestamp: data.timestamp?.toDate() || new Date()
          });
        });

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        updateStatistics();
        updateHotItems();
        updateOrderDetails();
        updateRevenueBreakdown();
        
      } catch (error) {
        console.error('è¼‰å…¥å ±è¡¨å¤±æ•—:', error);
        alert('è¼‰å…¥å ±è¡¨å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }

    // æ›´æ–°çµ±è¨ˆè³‡æ–™
    function updateStatistics() {
      let totalRevenue = 0;
      let dineInRevenue = 0;
      let takeOutRevenue = 0;
      let dineInCount = 0;
      let takeOutCount = 0;

      currentDateOrders.forEach(order => {
        const amount = order.totalAmount || 0;
        totalRevenue += amount;
        
        if (order.dineType === 'å…§ç”¨') {
          dineInRevenue += amount;
          dineInCount++;
        } else if (order.dineType === 'å¤–å¸¶') {
          takeOutRevenue += amount;
          takeOutCount++;
        }
      });

      document.getElementById('totalRevenue').textContent = `$${totalRevenue}`;
      document.getElementById('totalOrders').textContent = currentDateOrders.length;
      document.getElementById('dineInRevenue').textContent = `$${dineInRevenue}`;
      document.getElementById('dineInCount').textContent = `${dineInCount} ç­†è¨‚å–®`;
      document.getElementById('takeOutRevenue').textContent = `$${takeOutRevenue}`;
      document.getElementById('takeOutCount').textContent = `${takeOutCount} ç­†è¨‚å–®`;
    }

    // æ›´æ–°ç†±éŠ·å•†å“
    function updateHotItems() {
      const itemCounts = {};
      const itemRevenue = {};
      
      currentDateOrders.forEach(order => {
        if (order.items) {
          order.items.forEach(item => {
            const name = item.name;
            itemCounts[name] = (itemCounts[name] || 0) + item.quantity;
            itemRevenue[name] = (itemRevenue[name] || 0) + (item.subtotal || item.price * item.quantity);
          });
        }
      });

      const sortedItems = Object.entries(itemCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      let html = '<table class="order-table">';
      html += '<tr><th>æ’å</th><th>å•†å“åç¨±</th><th>éŠ·å”®æ•¸é‡</th><th>ç‡Ÿæ”¶é‡‘é¡</th></tr>';
      
      if (sortedItems.length === 0) {
        html += '<tr><td colspan="4" class="no-data">ä»Šæ—¥æš«ç„¡éŠ·å”®è³‡æ–™</td></tr>';
      } else {
        sortedItems.forEach(([name, count], index) => {
          html += `<tr>
            <td>${index + 1}</td>
            <td>${name}</td>
            <td>${count}</td>
            <td>$${itemRevenue[name] || 0}</td>
          </tr>`;
        });
      }
      
      html += '</table>';
      document.getElementById('hotItemsChart').innerHTML = html;
    }

    // æ›´æ–°è¨‚å–®æ˜ç´°
    function updateOrderDetails() {
      let html = '<table class="order-table">';
      html += '<tr><th>æ™‚é–“</th><th>è¨‚å–®ç·¨è™Ÿ</th><th>ç”¨é¤æ–¹å¼</th><th>æ¡Œè™Ÿ/å–é¤è™Ÿ</th><th>é‡‘é¡</th></tr>';
      
      if (currentDateOrders.length === 0) {
        html += '<tr><td colspan="5" class="no-data">ä»Šæ—¥æš«ç„¡è¨‚å–®</td></tr>';
      } else {
        currentDateOrders.forEach(order => {
          const time = order.timestamp.toLocaleTimeString('zh-TW', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          const tableInfo = order.dineType === 'å¤–å¸¶' ? 
            (order.takeoutNumber || '001') : 
            (order.tableNumber || '-');
          
          html += `<tr>
            <td>${time}</td>
            <td>${order.orderId || order.id}</td>
            <td>${order.dineType || '-'}</td>
            <td>${tableInfo}</td>
            <td>$${order.totalAmount || 0}</td>
          </tr>`;
        });
        
        const totalAmount = currentDateOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
        html += `<tr class="summary-row">
          <td colspan="4">ç¸½è¨ˆ</td>
          <td>$${totalAmount}</td>
        </tr>`;
      }
      
      html += '</table>';
      document.getElementById('orderDetails').innerHTML = html;
    }

    // æ›´æ–°æ”¶å…¥çµ±è¨ˆ
    function updateRevenueBreakdown() {
      const hourlyRevenue = {};
      
      currentDateOrders.forEach(order => {
        const hour = order.timestamp.getHours();
        const hourKey = `${hour}:00-${hour + 1}:00`;
        hourlyRevenue[hourKey] = (hourlyRevenue[hourKey] || 0) + (order.totalAmount || 0);
      });

      let html = '<table class="order-table">';
      html += '<tr><th>æ™‚æ®µ</th><th>ç‡Ÿæ”¶é‡‘é¡</th><th>è¨‚å–®æ•¸é‡</th></tr>';
      
      const sortedHours = Object.entries(hourlyRevenue).sort((a, b) => {
        const hourA = parseInt(a[0].split(':')[0]);
        const hourB = parseInt(b[0].split(':')[0]);
        return hourA - hourB;
      });

      if (sortedHours.length === 0) {
        html += '<tr><td colspan="3" class="no-data">ä»Šæ—¥æš«ç„¡ç‡Ÿæ”¶è³‡æ–™</td></tr>';
      } else {
        sortedHours.forEach(([timeRange, revenue]) => {
          const hour = parseInt(timeRange.split(':')[0]);
          const orderCount = currentDateOrders.filter(order => 
            order.timestamp.getHours() === hour
          ).length;
          
          html += `<tr>
            <td>${timeRange}</td>
            <td>$${revenue}</td>
            <td>${orderCount}</td>
          </tr>`;
        });
      }
      
      html += '</table>';
      document.getElementById('revenueBreakdown').innerHTML = html;
    }

    // åˆ—å°å ±è¡¨
    function printReport() {
      window.print();
    }

    // ç†±æ„Ÿæ‡‰å‡ºå–®æ©Ÿåˆ—å°
    function printThermalReport() {
      const selectedDate = document.getElementById('selectedDate').value;
      const dateDisplay = new Date(selectedDate).toLocaleDateString('zh-TW');
      
      let totalRevenue = 0;
      let dineInRevenue = 0;
      let takeOutRevenue = 0;
      let dineInCount = 0;
      let takeOutCount = 0;

      currentDateOrders.forEach(order => {
        const amount = order.totalAmount || 0;
        totalRevenue += amount;
        if (order.dineType === 'å…§ç”¨') {
          dineInRevenue += amount;
          dineInCount++;
        } else if (order.dineType === 'å¤–å¸¶') {
          takeOutRevenue += amount;
          takeOutCount++;
        }
      });

      // ç†±éŠ·å•†å“çµ±è¨ˆ
      const itemCounts = {};
      currentDateOrders.forEach(order => {
        if (order.items) {
          order.items.forEach(item => {
            itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;
          });
        }
      });
      const topItems = Object.entries(itemCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      // ç”Ÿæˆ80mmç†±æ„Ÿæ‡‰å‡ºå–®æ©Ÿæ ¼å¼ï¼ˆå¯¦éš›å¯¬åº¦ç´„302pxï¼‰
      let thermalContent = '<div style="width:302px;margin:0 auto;padding:8px;font-family:monospace;font-size:11px;line-height:1.2;background:#fff;">';
      thermalContent += '<div style="text-align:center;font-size:16px;font-weight:bold;margin-bottom:12px;">GèŒ¶é¤é…’é¤¨</div>';
      thermalContent += '<div style="text-align:center;font-size:13px;margin-bottom:12px;">æ—¥çµå¸³å ±è¡¨</div>';
      thermalContent += '<div style="text-align:center;font-size:12px;margin-bottom:16px;">' + dateDisplay + '</div>';
      thermalContent += '<div style="border-bottom:1px solid #000;padding-bottom:8px;margin-bottom:8px;">';
      thermalContent += '<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>ç¸½ç‡Ÿæ¥­é¡:</span><span style="font-weight:bold;font-size:14px;">$' + totalRevenue + '</span></div>';
      thermalContent += '<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>è¨‚å–®æ•¸é‡:</span><span>' + currentDateOrders.length + 'ç­†</span></div>';
      thermalContent += '<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>å…§ç”¨ç‡Ÿæ”¶:</span><span>$' + dineInRevenue + '(' + dineInCount + 'ç­†)</span></div>';
      thermalContent += '<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>å¤–å¸¶ç‡Ÿæ”¶:</span><span>$' + takeOutRevenue + '(' + takeOutCount + 'ç­†)</span></div>';
      thermalContent += '</div>';
      
      if (topItems.length > 0) {
        thermalContent += '<div style="border-bottom:1px solid #000;padding-bottom:8px;margin-bottom:8px;">';
        thermalContent += '<div style="text-align:center;font-weight:bold;margin-bottom:8px;">ç†±éŠ·å•†å“TOP5</div>';
        topItems.forEach(([name, count], index) => {
          thermalContent += '<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>' + (index + 1) + '.' + name + '</span><span>' + count + 'ä»½</span></div>';
        });
        thermalContent += '</div>';
      }
      
      thermalContent += '<div style="border-bottom:1px solid #000;padding-bottom:8px;margin-bottom:8px;">';
      thermalContent += '<div style="text-align:center;font-weight:bold;margin-bottom:8px;">è¨‚å–®æ˜ç´°</div>';
      
      if (currentDateOrders.length > 0) {
        currentDateOrders.forEach(order => {
          const time = order.timestamp.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
          const tableInfo = order.dineType === 'å¤–å¸¶' ? 'å–é¤:' + (order.takeoutNumber || '001') : 'æ¡Œè™Ÿ:' + (order.tableNumber || '-');
          thermalContent += '<div style="margin-bottom:4px;font-size:10px;">';
          thermalContent += '<div style="display:flex;justify-content:space-between;"><span>' + time + ' ' + order.dineType + '</span><span style="font-weight:bold;">$' + (order.totalAmount || 0) + '</span></div>';
          thermalContent += '<div style="color:#666;font-size:9px;">' + tableInfo + ' | ' + (order.orderId || order.id) + '</div>';
          thermalContent += '</div>';
        });
      } else {
        thermalContent += '<div style="text-align:center;color:#666;">ä»Šæ—¥æš«ç„¡è¨‚å–®</div>';
      }
      
      thermalContent += '</div>';
      thermalContent += '<div style="border-top:2px solid #000;padding-top:8px;margin-top:12px;text-align:center;">';
      thermalContent += '<div style="font-size:18px;font-weight:bold;">ç¸½è¨ˆ: $' + totalRevenue + '</div>';
      thermalContent += '</div>';
      thermalContent += '<div style="text-align:center;margin-top:16px;font-size:9px;color:#666;">åˆ—å°æ™‚é–“: ' + new Date().toLocaleString('zh-TW') + '</div>';
      thermalContent += '</div>';

            // å‰µå»ºæ–°è¦–çª—é€²è¡Œé è¦½å’Œåˆ—å°
      const printWindow = window.open('', '_blank', 'width=500,height=800');
      const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>æ—¥çµå¸³å ±è¡¨é è¦½</title>
          <style>
            @media print {
              body { margin: 0; padding: 0; }
              @page { size: 80mm auto; margin: 0; }
              .print-controls { display: none !important; }
            }
            body { 
              font-family: monospace; 
              margin: 0; 
              padding: 10px; 
              background: #f5f5f5;
            }
            .print-controls {
              background: #2d2320;
              color: #e0b873;
              padding: 10px;
              text-align: center;
              margin-bottom: 10px;
              border-radius: 8px;
            }
            .print-controls button {
              background: #e0b873;
              color: #2d2320;
              border: none;
              padding: 8px 16px;
              margin: 0 5px;
              border-radius: 6px;
              cursor: pointer;
              font-weight: bold;
            }
            .print-controls button:hover {
              background: #d4a862;
            }
            .preview-container {
              background: white;
              border: 2px dashed #ccc;
              margin: 0 auto;
              max-width: 80mm;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
          </style>
        </head>
        <body>
          <div class="print-controls">
            <h3>ğŸ§¾ æ—¥çµå¸³å‡ºå–®æ©Ÿé è¦½ (80mm)</h3>
            <button onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
            <button onclick="window.close()">âŒ é—œé–‰</button>
          </div>
          <div class="preview-container">
            ${thermalContent}
          </div>
        </body>
        </html>
      `;
      printWindow.document.write(printHTML);
      printWindow.document.close();
    }

    // ç™»å‡º
    function logout() {
      signOut(auth);
    }

    // å…¨åŸŸå‡½æ•¸
    window.loadDailyReport = loadDailyReport;
    window.printReport = printReport;
    window.printThermalReport = printThermalReport;
    window.logout = logout;

    // Firebase Auth
    const authContainer = document.getElementById('authContainer');
    const mainContainer = document.getElementById('mainContainer');
    const authMsg = document.getElementById('authMsg');

    document.getElementById('authLoginBtn').onclick = async function() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      authMsg.innerText = '';
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        authMsg.innerText = 'ç™»å…¥å¤±æ•—ï¼š' + (e.message || 'è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
      }
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        authContainer.style.display = 'none';
        mainContainer.style.display = 'block';
        initializeDate();
        loadDailyReport();
      } else {
        mainContainer.style.display = 'none';
        authContainer.style.display = 'block';
      }
    });
  </script>
</body>
</html> 