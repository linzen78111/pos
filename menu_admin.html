<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>èœå–®ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: 'Noto Sans TC', 'Inter', Arial, sans-serif; background: #f7f3ef; }
    .container { max-width: 600px; margin: 40px auto; padding: 24px; background: #fff; border-radius: 14px; box-shadow: 0 2px 12px #3bb4c122; }
    h2 { color: #3bb4c1; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
    th, td { padding: 8px 4px; border-bottom: 1px solid #e0e0e0; text-align: left; }
    th { background: #e0f7fa; color: #22577a; }
    tr:last-child td { border-bottom: none; }
    input, select { font-size: 1em; padding: 4px 6px; border: 1px solid #b0dbe6; border-radius: 6px; }
    input[type=checkbox] { width: 18px; height: 18px; }
    .actions button { margin-right: 6px; padding: 4px 10px; border-radius: 6px; border: none; font-size: 1em; cursor: pointer; }
    .actions .edit { background: #3bb4c1; color: #fff; }
    .actions .delete { background: #b85c38; color: #fff; }
    .actions .save { background: #7be0ad; color: #22577a; }
    .actions .cancel { background: #e0f7fa; color: #b85c38; }
    .add-form { margin-bottom: 24px; background: #fdf6ee; padding: 12px 10px; border-radius: 8px; }
    .add-form input, .add-form select { margin-right: 8px; margin-bottom: 6px; }
    .msg { margin: 12px 0; color: #b85c38; font-weight: bold; }
    .hot-list {
      background: #e0f7fa;
      border-radius: 10px;
      padding: 16px 12px 10px 12px;
      margin-bottom: 24px;
      box-shadow: 0 1px 6px #3bb4c122;
    }
    .hot-list-title {
      color: #b85c38;
      font-size: 1.15em;
      font-weight: bold;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }
    .hot-list ul { list-style: none; padding: 0; margin: 0; }
    .hot-list li { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #b0dbe6; }
    .hot-list li:last-child { border-bottom: none; }
    .hot-list .hot-name { font-weight: bold; color: #22577a; }
    .hot-list .hot-count { color: #b85c38; font-size: 1em; }
    .recommend-setting {
      margin-bottom: 18px;
      background: #fdf6ee;
      padding: 10px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .recommend-setting label { color: #b85c38; font-weight: bold; margin-right: 6px; }
    .recommend-setting input { font-size: 1em; padding: 4px 8px; border: 1px solid #b0dbe6; border-radius: 6px; }
    .recommend-setting button { padding: 4px 14px; border-radius: 6px; border: none; background: #3bb4c1; color: #fff; font-weight: bold; cursor: pointer; }
    @media (max-width: 700px) { .container { max-width: 99vw; } }
    
    /* å½ˆå‡ºè¦–çª—æ¨£å¼ */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #000; }
    
    /* é…æ–¹è¨­å®šæ¨£å¼ */
    .recipe-item { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
    .recipe-item select, .recipe-item input { margin-right: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    .recipe-item button { background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .add-recipe-btn { background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-bottom: 15px; }
    .recipe-summary { background: #f0f0f0; padding: 15px; border-radius: 6px; margin-top: 15px; }
    .recipe-cost { font-weight: bold; color: #b85c38; font-size: 1.1em; }
  </style>
</head>
<body>
  <!-- ç™»å…¥è¡¨å–® -->
  <div class="container" id="authContainer" style="display:none;max-width:400px;">
    <h2>èœå–®ç®¡ç†ç™»å…¥</h2>
    <input type="email" id="authEmail" placeholder="Email" style="width:100%;font-size:1.1em;padding:8px;margin-bottom:12px;" />
    <input type="password" id="authPassword" placeholder="å¯†ç¢¼" style="width:100%;font-size:1.1em;padding:8px;margin-bottom:18px;" />
    <button id="authLoginBtn" style="width:100%;padding:12px 0;font-size:1.1em;background:#3bb4c1;color:#fff;border:none;border-radius:8px;cursor:pointer;">ç™»å…¥</button>
    <div id="authMsg" style="color:#b85c38;margin-top:12px;"></div>
  </div>

  <!-- èœå–®ç®¡ç†ä¸»å…§å®¹ -->
  <div class="container" id="mainContainer" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;background:#2d2320;color:#e0b873;padding:20px;border-radius:12px;">
      <h2 style="margin:0;font-size:1.8em;">ğŸ½ï¸ èœå–®ç®¡ç†</h2>
      <div style="display:flex;gap:10px;">
        <a href="kitchen_orders.html" style="background:#3bb4c1;color:white;text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:bold;">ğŸ³ å»šæˆ¿çœ‹æ¿</a>
        <a href="daily_report.html" style="background:#FF9800;color:white;text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:bold;">ğŸ“‹ æ—¥çµå¸³</a>
        <a href="inventory_management.html" style="background:#9C27B0;color:white;text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:bold;">ğŸ“¦ åº«å­˜ç®¡ç†</a>
        <a href="analytics.html" style="background:#2196F3;color:white;text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:bold;">ğŸ“Š æƒ…å ±åˆ†æ</a>
        <a href="system_settings.html" style="background:#795548;color:white;text-decoration:none;padding:8px 16px;border-radius:6px;font-weight:bold;">âš™ï¸ ç³»çµ±è¨­å®š</a>
        <button id="logoutBtn" style="background:#e0b873;color:#2d2320;padding:8px 18px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">ç™»å‡º</button>
      </div>
    </div>
    <div class="recommend-setting">
      <label for="recommendCategory">æ¨è–¦é¡åˆ¥ï¼š</label>
      <input type="text" id="recommendCategory" placeholder="å¦‚ï¼šæœ¬é€±æ¨è–¦" />
      <button onclick="saveRecommendCategory()">å„²å­˜</button>
      <span id="recommendMsg" style="margin-left:8px;color:#22577a;"></span>
    </div>
    <div class="hot-list" id="hotList">
      <div class="hot-list-title">ç†±é–€æ¨è–¦ï¼ˆå‰10åï¼‰</div>
      <div id="hotListContent">çµ±è¨ˆä¸­...</div>
    </div>
    <div class="add-form">
      <input type="text" id="addName" placeholder="åç¨±" required />
      <input type="number" id="addPrice" placeholder="é‡‘é¡" min="0" required />
      <input type="text" id="addImage" placeholder="åœ–ç‰‡ç¶²å€" />
      <input type="text" id="addCategory" placeholder="åˆ†é¡" />
      <input type="text" id="addNote" placeholder="å‚™è¨»/èªªæ˜" />
      <input type="number" id="addOrderLimit" placeholder="æ¯äººé™é»æ•¸é‡(0=ç„¡é™åˆ¶)" min="0" />
      <label><input type="checkbox" id="addEnabled" checked /> å•Ÿç”¨</label>
      <button onclick="addMenuItem()">æ–°å¢</button>
      <button onclick="openRecipeModal('add')" style="background:#9C27B0;color:#fff;margin-left:10px;">è¨­å®šé…æ–¹</button>
    </div>
    <div class="msg" id="msg"></div>
    <table id="menuTable">
      <thead>
        <tr>
          <th>åç¨±</th><th>é‡‘é¡</th><th>åœ–ç‰‡</th><th>åˆ†é¡</th><th>å‚™è¨»</th><th>æ¯äººé™é»</th><th>å•Ÿç”¨</th><th>é…æ–¹</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- é…æ–¹è¨­å®šå½ˆå‡ºè¦–çª— -->
  <div id="recipeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="recipeModalTitle">è¨­å®šå•†å“é…æ–¹</h3>
        <span class="close" onclick="closeRecipeModal()">&times;</span>
      </div>
      <div id="recipeModalContent">
        <div style="margin-bottom: 15px;">
          <strong>å•†å“åç¨±ï¼š</strong><span id="recipeItemName">-</span>
        </div>
        <button class="add-recipe-btn" onclick="addRecipeItem()">â• æ–°å¢åŸæ–™</button>
        <div id="recipeItemsList"></div>
        <div class="recipe-summary">
          <div class="recipe-cost">é ä¼°æˆæœ¬ï¼š$<span id="recipeTotalCost">0.00</span></div>
          <div style="margin-top: 8px; color: #666;">
            æ¯›åˆ©ç‡ï¼š<span id="recipeProfit">0%</span>
            ï¼ˆå”®åƒ¹ï¼š$<span id="recipePrice">0</span>ï¼‰
          </div>
        </div>
        <div style="text-align: right; margin-top: 20px;">
          <button onclick="closeRecipeModal()" style="background: #ccc; color: #333; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">å–æ¶ˆ</button>
          <button onclick="saveRecipe()" style="background: #3bb4c1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">å„²å­˜é…æ–¹</button>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSKEpN_xclOhuWOQA7HiMSjsz0lNIHRb4",
      authDomain: "gukediancan.firebaseapp.com",
      projectId: "gukediancan",
      storageBucket: "gukediancan.firebasestorage.app",
      messagingSenderId: "864103354539",
      appId: "1:864103354539:web:26aabd0cc698d7a032e7ee",
      measurementId: "G-EZYMQQ5FGQ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ç™»å…¥ç›¸é—œå…ƒç´ 
    const authContainer = document.getElementById('authContainer');
    const mainContainer = document.getElementById('mainContainer');
    const authMsg = document.getElementById('authMsg');

    // ç™»å…¥æŒ‰éˆ•äº‹ä»¶
    document.getElementById('authLoginBtn').onclick = async function() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      authMsg.innerText = '';
      
      if (!email || !password) {
        authMsg.innerText = 'è«‹è¼¸å…¥ Email å’Œå¯†ç¢¼';
        return;
      }
      
      try {
        console.log('å˜—è©¦ç™»å…¥:', email);
        await signInWithEmailAndPassword(auth, email, password);
        console.log('ç™»å…¥æˆåŠŸ');
              } catch (e) {
          console.error('ç™»å…¥éŒ¯èª¤:', e);
          let errorMsg = 'ç™»å…¥å¤±æ•—';
          if (e.code === 'auth/user-not-found') {
            errorMsg = 'å¸³è™Ÿä¸å­˜åœ¨ï¼Œè«‹å…ˆå»ºç«‹å¸³è™Ÿ';
          } else if (e.code === 'auth/wrong-password') {
            errorMsg = 'å¯†ç¢¼éŒ¯èª¤';
          } else if (e.code === 'auth/invalid-email') {
            errorMsg = 'Email æ ¼å¼éŒ¯èª¤';
          } else if (e.code === 'auth/invalid-login-credentials') {
            errorMsg = 'å¸³è™Ÿæˆ–å¯†ç¢¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥è¼¸å…¥';
          } else if (e.code === 'auth/too-many-requests') {
            errorMsg = 'ç™»å…¥æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦';
          } else {
            errorMsg = 'ç™»å…¥å¤±æ•—ï¼š' + (e.message || 'è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
          }
          authMsg.innerText = errorMsg;
        }
    };

    // ç™»å‡ºæŒ‰éˆ•äº‹ä»¶
    document.getElementById('logoutBtn').onclick = function() {
      signOut(auth);
    };

    // ç›£è½ç™»å…¥ç‹€æ…‹
    onAuthStateChanged(auth, user => {
      if (user) {
        // å·²ç™»å…¥ï¼Œé¡¯ç¤ºèœå–®ç®¡ç†å…§å®¹
        authContainer.style.display = 'none';
        mainContainer.style.display = '';
        loadMenu();
        loadHotList();
      } else {
        // æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥è¡¨å–®
        mainContainer.style.display = 'none';
        authContainer.style.display = '';
      }
    });

    let menuData = [];
    
    async function loadMenu() {
      const snapshot = await getDocs(collection(db, "menu"));
      
      menuData = [];
      snapshot.forEach(docu => {
        menuData.push({ ...docu.data(), id: docu.id });
      });
      renderMenu();
    }

    function renderMenu() {
      const tbody = document.querySelector('#menuTable tbody');
      tbody.innerHTML = '';
      menuData.forEach((item, idx) => {
        const tr = document.createElement('tr');
        if (item._edit) {
          tr.innerHTML = `
            <td><input value="${item.name}" id="editName${idx}" style="max-width:100px;width:100%;" /></td>
            <td><input type="number" value="${item.price}" id="editPrice${idx}" min="0" style="max-width:60px;width:100%;" /></td>
            <td><input value="${item.image || ''}" id="editImage${idx}" style="max-width:160px;width:100%;" /></td>
            <td><input value="${item.category || ''}" id="editCategory${idx}" style="max-width:80px;width:100%;" /></td>
            <td><input value="${item.note || ''}" id="editNote${idx}" style="max-width:180px;width:100%;" /></td>
            <td><input type="number" value="${item.orderLimit || 0}" id="editOrderLimit${idx}" min="0" style="max-width:80px;width:100%;" /></td>
            <td><input type="checkbox" id="editEnabled${idx}" ${item.enabled ? 'checked' : ''} /></td>
            <td>
              <button onclick="openRecipeModal('edit', ${idx})" style="background:#9C27B0;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:0.9em;">é…æ–¹</button>
            </td>
            <td class="actions">
              <button class="save" onclick="saveEdit(${idx})">å„²å­˜</button>
              <button class="cancel" onclick="cancelEdit(${idx})">å–æ¶ˆ</button>
            </td>
          `;
        } else {
          const orderLimit = item.orderLimit || 0;
          
          tr.innerHTML = `
            <td>${item.name}</td>
            <td>$${item.price}</td>
            <td>${item.image ? `<img src="${item.image}" style="width:36px;height:36px;object-fit:cover;border-radius:6px;">` : ''}</td>
            <td>${item.category || ''}</td>
            <td>${item.note || ''}</td>
            <td style="text-align:center;">${orderLimit === 0 ? 'ç„¡é™åˆ¶' : `${orderLimit} ä»½`}</td>
            <td><input type="checkbox" disabled ${item.enabled ? 'checked' : ''} /></td>
            <td>
              <button onclick="openRecipeModal('edit', ${idx})" style="background:#9C27B0;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:0.9em;">
                ${item.recipe && item.recipe.length > 0 ? 'âœ“é…æ–¹' : 'è¨­å®š'}
              </button>
            </td>
            <td class="actions">
              <button class="edit" onclick="editMenuItem(${idx})">ç·¨è¼¯</button>
              <button class="delete" onclick="deleteMenuItem('${item.id}')">åˆªé™¤</button>
            </td>
          `;
        }
        tbody.appendChild(tr);
      });
    }

    window.addMenuItem = async function() {
      const name = document.getElementById('addName').value.trim();
      const price = parseInt(document.getElementById('addPrice').value || '0', 10);
      const image = document.getElementById('addImage').value.trim();
      const category = document.getElementById('addCategory').value.trim();
      const note = document.getElementById('addNote').value.trim();
      const orderLimit = parseInt(document.getElementById('addOrderLimit').value || '0', 10);
      const enabled = document.getElementById('addEnabled').checked;
      if (!name) { showMsg('è«‹è¼¸å…¥åç¨±'); return; }
      await setDoc(doc(db, "menu", name), { name, price, image, category, note, orderLimit, enabled });
      showMsg('æ–°å¢æˆåŠŸï¼');
      clearAddForm();
      loadMenu();
    }
    function clearAddForm() {
      document.getElementById('addName').value = '';
      document.getElementById('addPrice').value = '';
      document.getElementById('addImage').value = '';
      document.getElementById('addCategory').value = '';
      document.getElementById('addNote').value = '';
      document.getElementById('addOrderLimit').value = '0';
      document.getElementById('addEnabled').checked = true;
    }
    window.editMenuItem = function(idx) {
      menuData[idx]._edit = true;
      renderMenu();
    }
    window.cancelEdit = function(idx) {
      menuData[idx]._edit = false;
      renderMenu();
    }
    window.saveEdit = async function(idx) {
      const item = menuData[idx];
      const name = document.getElementById('editName'+idx).value.trim();
      const price = parseInt(document.getElementById('editPrice'+idx).value || '0', 10);
      const image = document.getElementById('editImage'+idx).value.trim();
      const category = document.getElementById('editCategory'+idx).value.trim();
      const note = document.getElementById('editNote'+idx).value.trim();
      const orderLimit = parseInt(document.getElementById('editOrderLimit'+idx).value || '0', 10);
      const enabled = document.getElementById('editEnabled'+idx).checked;
      if (!name) { showMsg('è«‹è¼¸å…¥åç¨±'); return; }
      await setDoc(doc(db, "menu", name), { name, price, image, category, note, orderLimit, enabled });
      menuData[idx]._edit = false;
      showMsg('å„²å­˜æˆåŠŸï¼');
      loadMenu();
    }
    window.deleteMenuItem = async function(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å“é …å—ï¼Ÿ')) return;
      await deleteDoc(doc(db, "menu", id));
      showMsg('åˆªé™¤æˆåŠŸï¼');
      loadMenu();
    }
    function showMsg(msg) {
      document.getElementById('msg').innerText = msg;
      setTimeout(() => { document.getElementById('msg').innerText = ''; }, 1800);
    }

    async function loadHotList() {
      const hotDiv = document.getElementById('hotListContent');
      hotDiv.innerText = 'çµ±è¨ˆä¸­...';
      try {
        const ordersSnap = await getDocs(collection(db, "orders"));
        const countMap = {};
        ordersSnap.forEach(docu => {
          const order = docu.data();
          if (Array.isArray(order.items)) {
            order.items.forEach(item => {
              if (!item.name) return;
              countMap[item.name] = (countMap[item.name] || 0) + (item.quantity || 1);
            });
          }
        });
        // æ’åºå–å‰10
        const hotArr = Object.entries(countMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
        if (hotArr.length === 0) {
          hotDiv.innerHTML = '<span style="color:#888">æš«ç„¡è¨‚å–®è³‡æ–™</span>';
          return;
        }
        let html = '<ul>';
        hotArr.forEach(([name, count], idx) => {
          html += `<li><span class="hot-name">${idx+1}. ${name}</span><span class="hot-count">${count} æ¬¡</span></li>`;
        });
        html += '</ul>';
        hotDiv.innerHTML = html;
      } catch (e) {
        hotDiv.innerHTML = '<span style="color:red">è®€å–å¤±æ•—</span>';
      }
    }

    // æ¨è–¦é¡åˆ¥è¨­å®š
    function getRecommendCategory() {
      return localStorage.getItem('recommend_category') || '';
    }
    function setRecommendCategory(val) {
      localStorage.setItem('recommend_category', val);
    }
    window.saveRecommendCategory = function() {
      const val = document.getElementById('recommendCategory').value.trim();
      setRecommendCategory(val);
      document.getElementById('recommendMsg').innerText = 'å·²å„²å­˜';
      setTimeout(()=>{document.getElementById('recommendMsg').innerText='';}, 1200);
    }
    // åˆå§‹åŒ–æ¨è–¦é¡åˆ¥æ¬„ä½
    document.getElementById('recommendCategory').value = getRecommendCategory();

    // é…æ–¹ç®¡ç†åŠŸèƒ½
    let currentRecipeItem = null;
    let currentRecipeMode = 'add'; // 'add' or 'edit'
    let currentRecipeIndex = null;
    let inventoryData = [];
    let currentRecipe = [];

    // è¼‰å…¥åº«å­˜è³‡æ–™
    async function loadInventoryData() {
      try {
        const snapshot = await getDocs(collection(db, "inventory"));
        inventoryData = [];
        snapshot.forEach(doc => {
          inventoryData.push({
            id: doc.id,
            ...doc.data()
          });
        });
      } catch (error) {
        console.error('è¼‰å…¥åº«å­˜è³‡æ–™å¤±æ•—:', error);
        inventoryData = [];
      }
    }

    // æ‰“é–‹é…æ–¹è¨­å®šå½ˆå‡ºè¦–çª—
    window.openRecipeModal = async function(mode, index = null) {
      currentRecipeMode = mode;
      currentRecipeIndex = index;
      
      // è¼‰å…¥åº«å­˜è³‡æ–™
      await loadInventoryData();
      
      if (mode === 'add') {
        const name = document.getElementById('addName').value.trim();
        const price = parseInt(document.getElementById('addPrice').value || '0', 10);
        if (!name) {
          alert('è«‹å…ˆè¼¸å…¥å•†å“åç¨±');
          return;
        }
        currentRecipeItem = { name, price, recipe: [] };
        document.getElementById('recipeItemName').textContent = name;
        document.getElementById('recipePrice').textContent = price;
      } else {
        currentRecipeItem = menuData[index];
        document.getElementById('recipeItemName').textContent = currentRecipeItem.name;
        document.getElementById('recipePrice').textContent = currentRecipeItem.price;
      }
      
      currentRecipe = currentRecipeItem.recipe ? [...currentRecipeItem.recipe] : [];
      renderRecipeItems();
      updateRecipeCost();
      document.getElementById('recipeModal').style.display = 'block';
    };

    // é—œé–‰é…æ–¹è¨­å®šå½ˆå‡ºè¦–çª—
    window.closeRecipeModal = function() {
      document.getElementById('recipeModal').style.display = 'none';
      currentRecipeItem = null;
      currentRecipe = [];
    };

    // æ–°å¢é…æ–¹é …ç›®
    window.addRecipeItem = function() {
      currentRecipe.push({
        ingredientId: '',
        ingredientName: '',
        quantity: 0,
        unit: '',
        cost: 0
      });
      renderRecipeItems();
    };

    // ç§»é™¤é…æ–¹é …ç›®
    window.removeRecipeItem = function(index) {
      currentRecipe.splice(index, 1);
      renderRecipeItems();
      updateRecipeCost();
    };

    // æ¸²æŸ“é…æ–¹é …ç›®åˆ—è¡¨
    function renderRecipeItems() {
      const container = document.getElementById('recipeItemsList');
      
      if (currentRecipe.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">å°šæœªè¨­å®šé…æ–¹åŸæ–™</div>';
        return;
      }
      
      let html = '';
      currentRecipe.forEach((recipe, index) => {
        html += `
          <div class="recipe-item">
            <select onchange="updateRecipeIngredient(${index}, this.value)" style="min-width: 150px;">
              <option value="">é¸æ“‡åŸæ–™</option>
              ${inventoryData.map(item => 
                `<option value="${item.id}" ${recipe.ingredientId === item.id ? 'selected' : ''}>
                  ${item.name} (${item.unit})
                </option>`
              ).join('')}
            </select>
            <input type="number" placeholder="ç”¨é‡" value="${recipe.quantity}" 
                   onchange="updateRecipeQuantity(${index}, this.value)" 
                   style="width: 80px;" min="0" step="0.1" />
            <span style="margin-right: 10px;">${recipe.unit}</span>
            <span style="margin-right: 10px;">æˆæœ¬: $${recipe.cost.toFixed(2)}</span>
            <button onclick="removeRecipeItem(${index})">ç§»é™¤</button>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // æ›´æ–°é…æ–¹åŸæ–™
    window.updateRecipeIngredient = function(index, ingredientId) {
      const ingredient = inventoryData.find(item => item.id === ingredientId);
      if (ingredient) {
        currentRecipe[index].ingredientId = ingredientId;
        currentRecipe[index].ingredientName = ingredient.name;
        currentRecipe[index].unit = ingredient.unit;
        currentRecipe[index].cost = (currentRecipe[index].quantity || 0) * ingredient.price;
      } else {
        currentRecipe[index].ingredientId = '';
        currentRecipe[index].ingredientName = '';
        currentRecipe[index].unit = '';
        currentRecipe[index].cost = 0;
      }
      renderRecipeItems();
      updateRecipeCost();
    };

    // æ›´æ–°é…æ–¹ç”¨é‡
    window.updateRecipeQuantity = function(index, quantity) {
      const qty = parseFloat(quantity) || 0;
      currentRecipe[index].quantity = qty;
      
      const ingredient = inventoryData.find(item => item.id === currentRecipe[index].ingredientId);
      if (ingredient) {
        currentRecipe[index].cost = qty * ingredient.price;
      }
      
      renderRecipeItems();
      updateRecipeCost();
    };

    // æ›´æ–°é…æ–¹ç¸½æˆæœ¬
    function updateRecipeCost() {
      const totalCost = currentRecipe.reduce((sum, recipe) => sum + recipe.cost, 0);
      const price = currentRecipeItem.price || 0;
      const profit = price > 0 ? ((price - totalCost) / price * 100) : 0;
      
      document.getElementById('recipeTotalCost').textContent = totalCost.toFixed(2);
      document.getElementById('recipeProfit').textContent = profit.toFixed(1) + '%';
    }

    // å„²å­˜é…æ–¹
    window.saveRecipe = async function() {
      try {
        if (currentRecipeMode === 'add') {
          // æ–°å¢å•†å“æ™‚ï¼Œå…ˆå„²å­˜å•†å“å†æ›´æ–°é…æ–¹
          const name = currentRecipeItem.name;
          const price = currentRecipeItem.price;
          const image = document.getElementById('addImage').value.trim();
          const category = document.getElementById('addCategory').value.trim();
          const note = document.getElementById('addNote').value.trim();
          const orderLimit = parseInt(document.getElementById('addOrderLimit').value || '0', 10);
          const enabled = document.getElementById('addEnabled').checked;
          
          await setDoc(doc(db, "menu", name), { 
            name, price, image, category, note, orderLimit, enabled, 
            recipe: currentRecipe 
          });
          
          clearAddForm();
        } else {
          // ç·¨è¼¯ç¾æœ‰å•†å“
          const item = currentRecipeItem;
          await setDoc(doc(db, "menu", item.id), { 
            ...item, 
            recipe: currentRecipe 
          });
        }
        
        closeRecipeModal();
        showMsg('é…æ–¹å„²å­˜æˆåŠŸï¼');
        loadMenu();
      } catch (error) {
        console.error('å„²å­˜é…æ–¹å¤±æ•—:', error);
        alert('å„²å­˜é…æ–¹å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    };

    // é»æ“Šå¤–éƒ¨é—œé–‰å½ˆå‡ºè¦–çª—
    window.onclick = function(event) {
      const modal = document.getElementById('recipeModal');
      if (event.target === modal) {
        closeRecipeModal();
      }
    };
  </script>
</body>
</html> 