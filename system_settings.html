<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç³»çµ±è¨­å®š - GèŒ¶é¤é…’é¤¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    
    /* æ¨™é¡Œå€åŸŸ */
    .header { background: #2d2320; color: #e0b873; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 1.8em; }
    .nav-buttons { display: flex; gap: 10px; }
    .nav-btn { padding: 8px 16px; background: #e0b873; color: #2d2320; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-decoration: none; }
    .nav-btn:hover { background: #d4a862; }
    
    /* è¨­å®šå€å¡Š */
    .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .settings-section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .settings-section h3 { margin: 0 0 20px 0; color: #2d2320; border-bottom: 2px solid #e0b873; padding-bottom: 10px; }
    
    /* è¡¨å–®æ¨£å¼ */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2d2320; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
    .form-group textarea { height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 2px; }
    .btn-primary { background: #2196F3; color: white; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-warning { background: #FF9800; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn:hover { opacity: 0.8; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* è­¦å‘Šè¨Šæ¯ */
    .alert { padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    
    /* çµ±è¨ˆå¡ç‰‡ */
    .stats-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #e0b873; }
    .stats-title { font-weight: bold; margin-bottom: 5px; }
    .stats-value { font-size: 1.2em; color: #2d2320; }
    
    /* ç‡Ÿæ¥­æ™‚é–“è¨­å®š */
    .hours-grid { display: grid; grid-template-columns: 100px 1fr 1fr 80px; gap: 10px; align-items: center; margin-bottom: 10px; }
    .hours-grid label { margin: 0; }
    
    /* é–‹é—œæ¨£å¼ */
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4CAF50; }
    input:checked + .slider:before { transform: translateX(26px); }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .settings-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .hours-grid { grid-template-columns: 1fr; gap: 5px; }
      .header { flex-direction: column; gap: 15px; }
      .nav-buttons { flex-wrap: wrap; justify-content: center; }
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥å€åŸŸ -->
  <div class="container" id="authContainer" style="display:none;max-width:400px;margin:100px auto;">
    <div class="settings-section">
      <h2>ç³»çµ±è¨­å®šç™»å…¥</h2>
      <div class="form-group">
        <input type="email" id="authEmail" placeholder="Email" />
      </div>
      <div class="form-group">
        <input type="password" id="authPassword" placeholder="å¯†ç¢¼" />
      </div>
      <button id="authLoginBtn" class="btn btn-primary" style="width:100%;">ç™»å…¥</button>
      <div id="authMsg" style="color:#f44336;margin-top:15px;text-align:center;"></div>
    </div>
  </div>

  <!-- ä¸»è¦å…§å®¹ -->
  <div class="container" id="mainContainer" style="display:none;">
    <div class="header">
      <h1>âš™ï¸ ç³»çµ±è¨­å®š</h1>
      <div class="nav-buttons">
        <a href="kitchen_orders.html" class="nav-btn">ğŸ³ å»šæˆ¿çœ‹æ¿</a>
        <a href="daily_report.html" class="nav-btn">ğŸ“‹ æ—¥çµå¸³</a>
        <a href="inventory_management.html" class="nav-btn">ğŸ“¦ åº«å­˜ç®¡ç†</a>
        <a href="analytics.html" class="nav-btn">ğŸ“Š æƒ…å ±åˆ†æ</a>
        <button class="nav-btn" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <!-- ç³»çµ±ç‹€æ…‹ -->
    <div class="alert alert-info">
      <strong>ğŸ”§ ç³»çµ±ç‹€æ…‹ï¼š</strong>
      <span id="systemStatus">æ­£å¸¸é‹è¡Œ</span> | 
      <strong>ç‰ˆæœ¬ï¼š</strong>v1.0.0 | 
      <strong>æœ€å¾Œæ›´æ–°ï¼š</strong><span id="lastUpdate">-</span>
    </div>

    <div class="settings-grid">
      <!-- åº—å®¶åŸºæœ¬è³‡è¨Š -->
      <div class="settings-section">
        <h3>ğŸª åº—å®¶åŸºæœ¬è³‡è¨Š</h3>
        <form id="storeInfoForm">
          <div class="form-group">
            <label>åº—å®¶åç¨±ï¼š</label>
            <input type="text" id="storeName" value="GèŒ¶é¤é…’é¤¨" />
          </div>
          <div class="form-group">
            <label>åº—å®¶åœ°å€ï¼š</label>
            <textarea id="storeAddress" placeholder="è«‹è¼¸å…¥åº—å®¶åœ°å€"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>è¯çµ¡é›»è©±ï¼š</label>
              <input type="tel" id="storePhone" placeholder="02-1234-5678" />
            </div>
            <div class="form-group">
              <label>çµ±ä¸€ç·¨è™Ÿï¼š</label>
              <input type="text" id="storeTaxId" placeholder="12345678" />
            </div>
          </div>
          <div class="form-group">
            <label>åº—å®¶æè¿°ï¼š</label>
            <textarea id="storeDescription" placeholder="åº—å®¶ç°¡ä»‹æˆ–ç‰¹è‰²æè¿°"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜åº—å®¶è³‡è¨Š</button>
        </form>
      </div>

      <!-- ç‡Ÿæ¥­æ™‚é–“è¨­å®š -->
      <div class="settings-section">
        <h3>ğŸ• ç‡Ÿæ¥­æ™‚é–“è¨­å®š</h3>
        <div id="businessHours">
          <!-- ç‡Ÿæ¥­æ™‚é–“å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
        <button class="btn btn-success" onclick="saveBusinessHours()">ğŸ’¾ å„²å­˜ç‡Ÿæ¥­æ™‚é–“</button>
      </div>

      <!-- ç³»çµ±åƒæ•¸è¨­å®š -->
      <div class="settings-section">
        <h3>âš™ï¸ ç³»çµ±åƒæ•¸</h3>
        <div class="form-group">
          <label>è¨‚å–®è‡ªå‹•åˆ·æ–°é–“éš”ï¼ˆç§’ï¼‰ï¼š</label>
          <input type="number" id="refreshInterval" min="5" max="60" value="10" />
        </div>
        <div class="form-group">
          <label>å–é¤è™Ÿç¢¼ç¯„åœï¼š</label>
          <div class="form-row">
            <input type="number" id="takeoutMin" min="1" max="999" value="1" placeholder="æœ€å°å€¼" />
            <input type="number" id="takeoutMax" min="1" max="999" value="999" placeholder="æœ€å¤§å€¼" />
          </div>
        </div>
        <div class="form-group">
          <label>ä½åº«å­˜è­¦å‘Šé–¾å€¼ï¼ˆ%ï¼‰ï¼š</label>
          <input type="number" id="lowStockThreshold" min="1" max="50" value="20" />
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="enableSound" checked />
            å•Ÿç”¨éŸ³æ•ˆæé†’
          </label>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="enableAutoDeduction" checked />
            å•Ÿç”¨è‡ªå‹•åº«å­˜æ‰£æ¸›
          </label>
        </div>
        <button class="btn btn-primary" onclick="saveSystemParams()">ğŸ’¾ å„²å­˜ç³»çµ±åƒæ•¸</button>
      </div>

      <!-- åˆ—å°è¨­å®š -->
      <div class="settings-section">
        <h3>ğŸ–¨ï¸ åˆ—å°è¨­å®š</h3>
        <div class="form-group">
          <label>å‡ºå–®æ©Ÿç´™å¼µå¯¬åº¦ï¼š</label>
          <select id="printerWidth">
            <option value="58">58mm</option>
            <option value="80" selected>80mm</option>
          </select>
        </div>
        <div class="form-group">
          <label>åˆ—å°å­—é«”å¤§å°ï¼š</label>
          <select id="printFontSize">
            <option value="10">å° (10px)</option>
            <option value="12">ä¸­ (12px)</option>
            <option value="14" selected>å¤§ (14px)</option>
          </select>
        </div>
        <div class="form-group">
          <label>å­—ç¬¦ç·¨ç¢¼ï¼š</label>
          <select id="printerEncoding">
            <option value="ascii" selected>ASCII (è‹±æ–‡æ•¸å­—) - ç›¸å®¹æ€§æœ€ä½³</option>
            <option value="big5">Big5 (ç¹é«”ä¸­æ–‡) - å°ç£å‡ºå–®æ©Ÿ</option>
            <option value="gb2312">GB2312 (ç°¡é«”ä¸­æ–‡) - å¤§é™¸å‡ºå–®æ©Ÿ</option>
            <option value="utf8">UTF-8 (å®Œæ•´Unicode) - æ–°å‹å‡ºå–®æ©Ÿ</option>
          </select>
          <div style="font-size:0.9em;color:#666;margin-top:5px;">
            ğŸ’¡ å»ºè­°ï¼šå‚³çµ±å‡ºå–®æ©Ÿé¸æ“‡ ASCIIï¼Œç¢ºå®šæ”¯æ´ä¸­æ–‡å¯é¸ Big5
          </div>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="autoPrint" />
            æ–°è¨‚å–®è‡ªå‹•åˆ—å°
          </label>
        </div>
        <div class="form-group">
          <label>åˆ—å°ä»½æ•¸ï¼š</label>
          <input type="number" id="printCopies" min="1" max="5" value="1" />
        </div>
        <button class="btn btn-primary" onclick="savePrintSettings()">ğŸ’¾ å„²å­˜åˆ—å°è¨­å®š</button>
        <button class="btn btn-warning" onclick="testPrint()">ğŸ§ª æ¸¬è©¦åˆ—å°</button>
      </div>

      <!-- è³‡æ–™ç®¡ç† -->
      <div class="settings-section">
        <h3>ğŸ’¾ è³‡æ–™ç®¡ç†</h3>
        <div class="stats-card">
          <div class="stats-title">è³‡æ–™åº«çµ±è¨ˆ</div>
          <div class="stats-value" id="dbStats">è¼‰å…¥ä¸­...</div>
        </div>
        
        <div class="form-group">
          <label>è³‡æ–™ä¿ç•™æœŸé–“ï¼ˆå¤©ï¼‰ï¼š</label>
          <input type="number" id="dataRetention" min="30" max="1095" value="365" />
          <small style="color: #666;">è¶…éæœŸé™çš„è¨‚å–®è³‡æ–™å°‡è¢«è‡ªå‹•æ¸…ç†</small>
        </div>
        
        <div style="margin: 20px 0;">
          <h4>ğŸ“¤ è³‡æ–™å‚™ä»½</h4>
          <p>å®šæœŸå‚™ä»½æ‚¨çš„é‡è¦è³‡æ–™</p>
          <button class="btn btn-success" onclick="backupData()">ç«‹å³å‚™ä»½</button>
        </div>
        
        <div style="margin-top: 20px;">
          <h4>ğŸ“¥ è³‡æ–™é‚„åŸ</h4>
          <input type="file" id="restoreFile" accept=".json" style="margin-bottom: 10px;" />
          <button class="btn btn-danger" onclick="restoreData()">é‚„åŸè³‡æ–™</button>
          <small style="color: #f44336; display: block; margin-top: 5px;">
            âš ï¸ é‚„åŸè³‡æ–™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œè«‹è¬¹æ…æ“ä½œ
          </small>
        </div>
      </div>

      <!-- é€šçŸ¥è¨­å®š -->
      <div class="settings-section">
        <h3>ğŸ”” é€šçŸ¥è¨­å®š</h3>
        <div class="form-group">
          <label>
            <input type="checkbox" id="enableOrderNotify" checked />
            æ–°è¨‚å–®é€šçŸ¥
          </label>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="enableStockNotify" checked />
            ä½åº«å­˜é€šçŸ¥
          </label>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="enableDailyReport" checked />
            æ¯æ—¥å ±è¡¨é€šçŸ¥
          </label>
        </div>
        <div class="form-group">
          <label>é€šçŸ¥Emailï¼š</label>
          <input type="email" id="notifyEmail" placeholder="admin@example.com" />
        </div>
        <div class="form-group">
          <label>é€šçŸ¥æ™‚é–“ï¼š</label>
          <input type="time" id="notifyTime" value="22:00" />
        </div>
        <button class="btn btn-primary" onclick="saveNotificationSettings()">ğŸ’¾ å„²å­˜é€šçŸ¥è¨­å®š</button>
        <button class="btn btn-success" onclick="testNotification()">ğŸ§ª æ¸¬è©¦é€šçŸ¥</button>
      </div>
    </div>

    <!-- ç³»çµ±æ—¥èªŒ -->
    <div class="settings-section" style="margin-top: 20px;">
      <h3>ğŸ“‹ ç³»çµ±æ—¥èªŒ</h3>
      <div style="margin-bottom: 15px;">
        <button class="btn btn-primary" onclick="loadSystemLogs()">é‡æ–°æ•´ç†</button>
        <button class="btn btn-warning" onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
        <select id="logLevel" onchange="filterLogs()">
          <option value="all">å…¨éƒ¨</option>
          <option value="info">è³‡è¨Š</option>
          <option value="warning">è­¦å‘Š</option>
          <option value="error">éŒ¯èª¤</option>
        </select>
      </div>
      <div id="systemLogs" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px;">
        <div style="color: #666;">è¼‰å…¥ç³»çµ±æ—¥èªŒä¸­...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, setDoc, getDocs, deleteDoc, query, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import globalSettings from './global_settings.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDSKEpN_xclOhuWOQA7HiMSjsz0lNIHRb4",
      authDomain: "gukediancan.firebaseapp.com",
      projectId: "gukediancan",
      storageBucket: "gukediancan.firebasestorage.app",
      messagingSenderId: "864103354539",
      appId: "1:864103354539:web:26aabd0cc698d7a032e7ee",
      measurementId: "G-EZYMQQ5FGQ"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // åˆå§‹åŒ–è¨­å®š
    async function initializeSettings() {
      // åˆå§‹åŒ–å…¨å±€è¨­å®š
      await globalSettings.initialize(db);
      
      await loadStoreInfo();
      await loadSystemParams();
      await loadPrintSettings();
      await loadNotificationSettings();
      generateBusinessHours();
      updateDatabaseStats();
      loadSystemLogs();
    }

    // è¼‰å…¥åº—å®¶è³‡è¨Š
    async function loadStoreInfo() {
      try {
        const docRef = doc(db, "settings", "store_info");
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('storeName').value = data.name || '';
          document.getElementById('storeAddress').value = data.address || '';
          document.getElementById('storePhone').value = data.phone || '';
          document.getElementById('storeTaxId').value = data.taxId || '';
          document.getElementById('storeDescription').value = data.description || '';
        }
      } catch (error) {
        console.error('è¼‰å…¥åº—å®¶è³‡è¨Šå¤±æ•—:', error);
      }
    }

    // è¼‰å…¥ç³»çµ±åƒæ•¸
    async function loadSystemParams() {
      try {
        const docRef = doc(db, "settings", "system_params");
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('refreshInterval').value = data.refreshInterval || 10;
          document.getElementById('takeoutMin').value = data.takeoutMin || 1;
          document.getElementById('takeoutMax').value = data.takeoutMax || 999;
          document.getElementById('lowStockThreshold').value = data.lowStockThreshold || 20;
          document.getElementById('enableSound').checked = data.enableSound !== false;
          document.getElementById('enableAutoDeduction').checked = data.enableAutoDeduction !== false;
          document.getElementById('dataRetention').value = data.dataRetention || 365;
        }
      } catch (error) {
        console.error('è¼‰å…¥ç³»çµ±åƒæ•¸å¤±æ•—:', error);
      }
    }

    // è¼‰å…¥åˆ—å°è¨­å®š
    async function loadPrintSettings() {
      try {
        const docRef = doc(db, "settings", "print_settings");
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('printerWidth').value = data.printerWidth || 80;
          document.getElementById('printFontSize').value = data.printFontSize || 14;
          document.getElementById('printerEncoding').value = data.printerEncoding || 'ascii';
          document.getElementById('autoPrint').checked = data.autoPrint || false;
          document.getElementById('printCopies').value = data.printCopies || 1;
        }
      } catch (error) {
        console.error('è¼‰å…¥åˆ—å°è¨­å®šå¤±æ•—:', error);
      }
    }

    // è¼‰å…¥é€šçŸ¥è¨­å®š
    async function loadNotificationSettings() {
      try {
        const docRef = doc(db, "settings", "notification_settings");
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('enableOrderNotify').checked = data.enableOrderNotify !== false;
          document.getElementById('enableStockNotify').checked = data.enableStockNotify !== false;
          document.getElementById('enableDailyReport').checked = data.enableDailyReport !== false;
          document.getElementById('notifyEmail').value = data.notifyEmail || '';
          document.getElementById('notifyTime').value = data.notifyTime || '22:00';
        }
      } catch (error) {
        console.error('è¼‰å…¥é€šçŸ¥è¨­å®šå¤±æ•—:', error);
      }
    }

    // ç”Ÿæˆç‡Ÿæ¥­æ™‚é–“è¨­å®š
    function generateBusinessHours() {
      const container = document.getElementById('businessHours');
      const weekDays = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
      
      let html = '<div class="hours-grid" style="font-weight: bold; margin-bottom: 15px;"><div>æ˜ŸæœŸ</div><div>é–‹å§‹æ™‚é–“</div><div>çµæŸæ™‚é–“</div><div>ç‡Ÿæ¥­</div></div>';
      
      weekDays.forEach((day, index) => {
        html += '<div class="hours-grid">';
        html += '<label>' + day + '</label>';
        html += '<input type="time" id="open_' + index + '" value="10:00" />';
        html += '<input type="time" id="close_' + index + '" value="22:00" />';
        html += '<label class="switch">';
        html += '<input type="checkbox" id="enable_' + index + '" checked />';
        html += '<span class="slider"></span>';
        html += '</label>';
        html += '</div>';
      });
      
      container.innerHTML = html;
    }

    // å„²å­˜åº—å®¶è³‡è¨Š
    document.getElementById('storeInfoForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const storeInfo = {
          name: document.getElementById('storeName').value,
          address: document.getElementById('storeAddress').value,
          phone: document.getElementById('storePhone').value,
          taxId: document.getElementById('storeTaxId').value,
          description: document.getElementById('storeDescription').value,
          updatedAt: Timestamp.now()
        };
        
        await setDoc(doc(db, "settings", "store_info"), storeInfo);
        
        // é€šçŸ¥å…¨å±€è¨­å®šæ›´æ–°
        if (window.globalSettings) {
          window.globalSettings.updateSettings('store_info', storeInfo);
        }
        
        showMessage('åº—å®¶è³‡è¨Šå·²å„²å­˜', 'success');
        logAction('æ›´æ–°åº—å®¶è³‡è¨Š');
      } catch (error) {
        console.error('å„²å­˜åº—å®¶è³‡è¨Šå¤±æ•—:', error);
        showMessage('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
      }
    });

    // å„²å­˜ç‡Ÿæ¥­æ™‚é–“
    async function saveBusinessHours() {
      try {
        const businessHours = {};
        
        for (let i = 0; i < 7; i++) {
          businessHours[i] = {
            open: document.getElementById('open_' + i).value,
            close: document.getElementById('close_' + i).value,
            enabled: document.getElementById('enable_' + i).checked
          };
        }
        
        await setDoc(doc(db, "settings", "business_hours"), {
          hours: businessHours,
          updatedAt: Timestamp.now()
        });
        
        // é€šçŸ¥å…¨å±€è¨­å®šæ›´æ–°
        if (window.globalSettings) {
          window.globalSettings.updateSettings('business_hours', { hours: businessHours });
        }
        
        showMessage('ç‡Ÿæ¥­æ™‚é–“å·²å„²å­˜', 'success');
        logAction('æ›´æ–°ç‡Ÿæ¥­æ™‚é–“');
      } catch (error) {
        console.error('å„²å­˜ç‡Ÿæ¥­æ™‚é–“å¤±æ•—:', error);
        showMessage('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
      }
    }

    // å„²å­˜ç³»çµ±åƒæ•¸
    async function saveSystemParams() {
      try {
        const systemParams = {
          refreshInterval: parseInt(document.getElementById('refreshInterval').value),
          takeoutMin: parseInt(document.getElementById('takeoutMin').value),
          takeoutMax: parseInt(document.getElementById('takeoutMax').value),
          lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value),
          enableSound: document.getElementById('enableSound').checked,
          enableAutoDeduction: document.getElementById('enableAutoDeduction').checked,
          dataRetention: parseInt(document.getElementById('dataRetention').value),
          updatedAt: Timestamp.now()
        };
        
        await setDoc(doc(db, "settings", "system_params"), systemParams);
        
        // é€šçŸ¥å…¨å±€è¨­å®šæ›´æ–°
        if (window.globalSettings) {
          window.globalSettings.updateSettings('system_params', systemParams);
        }
        
        showMessage('ç³»çµ±åƒæ•¸å·²å„²å­˜', 'success');
        logAction('æ›´æ–°ç³»çµ±åƒæ•¸');
      } catch (error) {
        console.error('å„²å­˜ç³»çµ±åƒæ•¸å¤±æ•—:', error);
        showMessage('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
      }
    }

    // å„²å­˜åˆ—å°è¨­å®š
    async function savePrintSettings() {
      try {
        const printSettings = {
          printerWidth: parseInt(document.getElementById('printerWidth').value),
          printFontSize: parseInt(document.getElementById('printFontSize').value),
          printerEncoding: document.getElementById('printerEncoding').value,
          autoPrint: document.getElementById('autoPrint').checked,
          printCopies: parseInt(document.getElementById('printCopies').value),
          updatedAt: Timestamp.now()
        };
        
        await setDoc(doc(db, "settings", "print_settings"), printSettings);
        
        // é€šçŸ¥å…¨å±€è¨­å®šæ›´æ–°
        if (window.globalSettings) {
          window.globalSettings.updateSettings('print_settings', printSettings);
        }
        
        showMessage('åˆ—å°è¨­å®šå·²å„²å­˜', 'success');
        logAction('æ›´æ–°åˆ—å°è¨­å®š');
      } catch (error) {
        console.error('å„²å­˜åˆ—å°è¨­å®šå¤±æ•—:', error);
        showMessage('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
      }
    }

    // å„²å­˜é€šçŸ¥è¨­å®š
    async function saveNotificationSettings() {
      try {
        const notificationSettings = {
          enableOrderNotify: document.getElementById('enableOrderNotify').checked,
          enableStockNotify: document.getElementById('enableStockNotify').checked,
          enableDailyReport: document.getElementById('enableDailyReport').checked,
          notifyEmail: document.getElementById('notifyEmail').value,
          notifyTime: document.getElementById('notifyTime').value,
          updatedAt: Timestamp.now()
        };
        
        await setDoc(doc(db, "settings", "notification_settings"), notificationSettings);
        
        // é€šçŸ¥å…¨å±€è¨­å®šæ›´æ–°
        if (window.globalSettings) {
          window.globalSettings.updateSettings('notification_settings', notificationSettings);
        }
        
        showMessage('é€šçŸ¥è¨­å®šå·²å„²å­˜', 'success');
        logAction('æ›´æ–°é€šçŸ¥è¨­å®š');
      } catch (error) {
        console.error('å„²å­˜é€šçŸ¥è¨­å®šå¤±æ•—:', error);
        showMessage('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
      }
    }

    // æ¸¬è©¦åˆ—å°
    function testPrint() {
      const testContent = '================================\nGèŒ¶é¤é…’é¤¨ - æ¸¬è©¦åˆ—å°\n================================\næ™‚é–“: ' + new Date().toLocaleString('zh-TW') + '\n\né€™æ˜¯ä¸€å¼µæ¸¬è©¦å‡ºå–®\nç”¨ä¾†ç¢ºèªåˆ—å°è¨­å®šæ˜¯å¦æ­£ç¢º\n\nå¦‚æœæ‚¨çœ‹åˆ°é€™å¼µç´™ï¼Œ\nè¡¨ç¤ºåˆ—å°åŠŸèƒ½æ­£å¸¸é‹ä½œï¼\n\n================================';
      
      const printWindow = window.open('', '_blank');
             printWindow.document.write('<html><head><title>æ¸¬è©¦åˆ—å°</title><style>body { font-family: monospace; font-size: ' + document.getElementById('printFontSize').value + 'px; margin: 0; padding: 5mm; } @media print { body { margin: 0; } }</style></head><body><pre>' + testContent + '</pre><script>window.print(); window.close();<\/script></body></html>');
      
      logAction('åŸ·è¡Œæ¸¬è©¦åˆ—å°');
    }

    // æ›´æ–°è³‡æ–™åº«çµ±è¨ˆ
    async function updateDatabaseStats() {
      try {
        const collections = ['orders', 'menu', 'inventory', 'settings'];
        let stats = '';
        
        for (const collectionName of collections) {
          const snapshot = await getDocs(collection(db, collectionName));
          stats += collectionName + ': ' + snapshot.size + ' ç­†\n';
        }
        
        document.getElementById('dbStats').textContent = stats;
      } catch (error) {
        console.error('æ›´æ–°è³‡æ–™åº«çµ±è¨ˆå¤±æ•—:', error);
        document.getElementById('dbStats').textContent = 'è¼‰å…¥å¤±æ•—';
      }
    }

    // å‚™ä»½è³‡æ–™
    async function backupData() {
      try {
        showMessage('é–‹å§‹å‚™ä»½è³‡æ–™...', 'info');
        
        const collections = ['orders', 'menu', 'inventory', 'settings'];
        const backupData = {};
        
        for (const collectionName of collections) {
          const snapshot = await getDocs(collection(db, collectionName));
          backupData[collectionName] = [];
          
          snapshot.forEach(doc => {
            backupData[collectionName].push({
              id: doc.id,
              data: doc.data()
            });
          });
        }
        
        backupData.timestamp = new Date().toISOString();
        backupData.version = '1.0.0';
        
        const dataStr = JSON.stringify(backupData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'backup_' + new Date().toISOString().split('T')[0] + '.json';
        link.click();
        URL.revokeObjectURL(url);
        
        showMessage('å‚™ä»½å®Œæˆ', 'success');
        logAction('åŸ·è¡Œè³‡æ–™å‚™ä»½');
      } catch (error) {
        console.error('å‚™ä»½å¤±æ•—:', error);
        showMessage('å‚™ä»½å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
      }
    }

    // é‚„åŸè³‡æ–™
    async function restoreData() {
      const fileInput = document.getElementById('restoreFile');
      if (!fileInput.files.length) {
        showMessage('è«‹é¸æ“‡å‚™ä»½æª”æ¡ˆ', 'warning');
        return;
      }
      
      if (!confirm('é‚„åŸè³‡æ–™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
        return;
      }
      
      try {
        const file = fileInput.files[0];
        const text = await file.text();
        const backupData = JSON.parse(text);
        
        showMessage('é–‹å§‹é‚„åŸè³‡æ–™...', 'info');
        
        // é‚„åŸå„å€‹é›†åˆ
        for (const collectionName in backupData) {
          if (collectionName === 'timestamp' || collectionName === 'version') continue;
          
          const documents = backupData[collectionName];
          for (const docData of documents) {
            await setDoc(doc(db, collectionName, docData.id), docData.data);
          }
        }
        
        showMessage('è³‡æ–™é‚„åŸå®Œæˆ', 'success');
        logAction('åŸ·è¡Œè³‡æ–™é‚„åŸ');
        
        // é‡æ–°è¼‰å…¥è¨­å®š
        setTimeout(() => {
          location.reload();
        }, 2000);
        
      } catch (error) {
        console.error('é‚„åŸå¤±æ•—:', error);
        showMessage('é‚„åŸå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼', 'error');
      }
    }

    // è¼‰å…¥ç³»çµ±æ—¥èªŒ
    async function loadSystemLogs() {
      try {
        const q = query(
          collection(db, "system_logs"),
          orderBy("timestamp", "desc"),
          limit(100)
        );
        
        const snapshot = await getDocs(q);
        const logs = [];
        
        snapshot.forEach(doc => {
          logs.push(doc.data());
        });
        
        renderLogs(logs);
      } catch (error) {
        console.error('è¼‰å…¥ç³»çµ±æ—¥èªŒå¤±æ•—:', error);
        document.getElementById('systemLogs').innerHTML = '<div style="color: #f44336;">è¼‰å…¥æ—¥èªŒå¤±æ•—</div>';
      }
    }

    // æ¸²æŸ“æ—¥èªŒ
    function renderLogs(logs) {
      const container = document.getElementById('systemLogs');
      const level = document.getElementById('logLevel').value;
      
      const filteredLogs = level === 'all' ? logs : logs.filter(log => log.level === level);
      
      if (filteredLogs.length === 0) {
        container.innerHTML = '<div style="color: #666;">æš«ç„¡æ—¥èªŒè¨˜éŒ„</div>';
        return;
      }
      
      let html = '';
      filteredLogs.forEach(log => {
        const time = log.timestamp ? log.timestamp.toDate().toLocaleString('zh-TW') : '-';
        const levelColors = {
          info: '#2196F3',
          warning: '#FF9800',
          error: '#f44336'
        };
        const levelColor = levelColors[log.level] || '#666';
        
        html += '<div style="margin-bottom: 5px;">';
        html += '<span style="color: #666;">[' + time + ']</span> ';
        html += '<span style="color: ' + levelColor + '; font-weight: bold;">[' + (log.level || 'INFO').toUpperCase() + ']</span> ';
        html += '<span>' + log.message + '</span>';
        if (log.details) {
          html += '<br><span style="color: #666; margin-left: 20px;">' + log.details + '</span>';
        }
        html += '</div>';
      });
      
      container.innerHTML = html;
    }

    // è¨˜éŒ„æ“ä½œæ—¥èªŒ
    async function logAction(action, level = 'info', details = '') {
      try {
        await setDoc(doc(collection(db, "system_logs")), {
          timestamp: Timestamp.now(),
          level: level,
          message: action,
          details: details,
          user: auth.currentUser?.email || 'anonymous'
        });
      } catch (error) {
        console.error('è¨˜éŒ„æ—¥èªŒå¤±æ•—:', error);
      }
    }

    // é¡¯ç¤ºè¨Šæ¯
    function showMessage(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: bold; max-width: 300px;';
      
      const colors = {
        success: { bg: '#d4edda', border: '#c3e6cb', color: '#155724' },
        error: { bg: '#f8d7da', border: '#f5c6cb', color: '#721c24' },
        warning: { bg: '#fff3cd', border: '#ffeaa7', color: '#856404' },
        info: { bg: '#d1ecf1', border: '#bee5eb', color: '#0c5460' }
      };
      
      const color = colors[type] || colors.info;
      alertDiv.style.backgroundColor = color.bg;
      alertDiv.style.border = '1px solid ' + color.border;
      alertDiv.style.color = color.color;
      
      alertDiv.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center;"><span>' + message + '</span><span style="cursor: pointer; margin-left: 10px; font-size: 18px;" onclick="this.parentElement.parentElement.remove()">Ã—</span></div>';
      
      document.body.appendChild(alertDiv);
      
      // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
      setTimeout(() => {
        if (alertDiv.parentElement) {
          alertDiv.remove();
        }
      }, 3000);
    }

    // éæ¿¾æ—¥èªŒ
    function filterLogs() {
      loadSystemLogs();
    }

    // æ¸…é™¤æ—¥èªŒ
    async function clearLogs() {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç³»çµ±æ—¥èªŒå—ï¼Ÿ')) {
        return;
      }
      
      try {
        const snapshot = await getDocs(collection(db, "system_logs"));
        const deletePromises = [];
        
        snapshot.forEach(doc => {
          deletePromises.push(deleteDoc(doc.ref));
        });
        
        await Promise.all(deletePromises);
        showMessage('æ—¥èªŒå·²æ¸…é™¤', 'success');
        loadSystemLogs();
      } catch (error) {
        console.error('æ¸…é™¤æ—¥èªŒå¤±æ•—:', error);
        showMessage('æ¸…é™¤å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
      }
    }

    // æ¸¬è©¦é€šçŸ¥
    function testNotification() {
      showMessage('æ¸¬è©¦é€šçŸ¥åŠŸèƒ½ï¼ˆæ­¤ç‚ºæ¨¡æ“¬ï¼‰', 'info');
      logAction('åŸ·è¡Œæ¸¬è©¦é€šçŸ¥');
    }

    // å…¨åŸŸå‡½æ•¸
    window.saveBusinessHours = saveBusinessHours;
    window.saveSystemParams = saveSystemParams;
    window.savePrintSettings = savePrintSettings;
    window.saveNotificationSettings = saveNotificationSettings;
    window.testPrint = testPrint;
    window.backupData = backupData;
    window.restoreData = restoreData;
    window.loadSystemLogs = loadSystemLogs;
    window.filterLogs = filterLogs;
    window.clearLogs = clearLogs;
    window.testNotification = testNotification;
    window.logout = function() {
      signOut(auth);
    };

    // Firebase Auth
    const authContainer = document.getElementById('authContainer');
    const mainContainer = document.getElementById('mainContainer');
    const authMsg = document.getElementById('authMsg');

    document.getElementById('authLoginBtn').onclick = async function() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      authMsg.innerText = '';
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        authMsg.innerText = 'ç™»å…¥å¤±æ•—ï¼š' + (e.message || 'è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
      }
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        authContainer.style.display = 'none';
        mainContainer.style.display = 'block';
        initializeSettings();
        
        // æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
      } else {
        mainContainer.style.display = 'none';
        authContainer.style.display = 'block';
      }
    });
  </script>
</body>
</html> 