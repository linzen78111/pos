<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å»šæˆ¿æ¥å–®çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: 'Noto Sans TC', 'Inter', Arial, sans-serif; background: #f7f3ef; }
    .container { max-width: 700px; margin: 0 auto; padding: 18px; }
    h2 { color: #b85c38; margin-bottom: 18px; }
    .order-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #3bb4c122; margin-bottom: 18px; padding: 18px 16px; position: relative; }
    .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .order-id { color: #3bb4c1; font-weight: bold; font-size: 1.1em; }
    .order-type { color: #fff; background: #3bb4c1; border-radius: 6px; padding: 2px 10px; font-size: 0.98em; margin-left: 8px; }
    .order-type.takeout { background: #b85c38; }
    .order-table { color: #b85c38; font-weight: bold; font-size: 1.1em; }
    .order-items { margin: 10px 0 0 0; }
    .order-items th, .order-items td { padding: 4px 8px; }
    .order-items th { color: #22577a; font-size: 1em; }
    .order-items td { color: #3e2f28; font-size: 1em; }
    .order-status { position: absolute; top: 16px; right: 16px; color: #fff; background: #7be0ad; border-radius: 6px; padding: 2px 10px; font-size: 0.98em; }
    .order-status.done { background: #b0dbe6; }
    .print-btn { background: #3bb4c1; color: #fff; border: none; border-radius: 8px; padding: 8px 18px; font-size: 1em; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.2s; }
    .print-btn:hover { opacity: 0.9; }
    .print-btn:active { background: #b85c38; }
    .delete-btn { background: #f44336; }
    .delete-btn:hover { background: #d32f2f; }
    
    /* Modal æ¨£å¼ */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
    .modal-content { background-color: #3e2f28; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; color: #f5e9da; border: 2px solid #e0b873; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 15px 20px; border-bottom: 1px solid #e0b87333; }
    .modal-title { font-size: 1.3em; font-weight: bold; color: #e0b873; }
    .modal-body { padding: 20px; }
    .close { color: #e0b873; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; transition: color 0.2s; }
    .close:hover { color: #fff; }
    .modal-buttons { display: flex; gap: 12px; padding: 15px 20px 20px 20px; justify-content: flex-end; }
    .modal-btn { padding: 12px 24px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
    .btn-cancel { background: #666; color: #fff; }
    .btn-cancel:hover { background: #555; }
    .btn-danger { background: #f44336; color: #fff; }
    .btn-danger:hover { background: #d32f2f; }
    @media (max-width: 700px) { 
      .container { max-width: 99vw; } 
      .container > div:first-child { flex-direction: column; gap: 10px; }
      .container > div:first-child > div { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
      
      /* æ‰‹æ©Ÿç‰ˆ Modal æ¨£å¼ */
      .modal-content { width: 95% !important; margin: 10% auto !important; max-height: 80vh !important; }
      .modal-header { padding: 15px 15px 12px 15px !important; }
      .modal-title { font-size: 1.1em !important; }
      .modal-body { padding: 15px !important; }
      .modal-buttons { padding: 12px 15px 15px 15px !important; flex-direction: column !important; gap: 8px !important; }
      .modal-btn { width: 100% !important; padding: 14px !important; }
      .close { font-size: 24px !important; }
    }
    /* åˆ—å°æ¨£å¼ */
    @media print {
      body, html { background: #fff !important; }
      .container, .order-card, .print-btn, .status-btns, #ordersList, h2, div[style*='color:#888'] { display: none !important; }
      #printArea { display: block !important; max-width: 76mm !important; width: 100% !important; font-size: 14px !important; margin: 0 auto !important; padding: 0 !important; }
      #printArea * { color: #000 !important; background: #fff !important; box-shadow: none !important; border: none !important; }
      #printArea h2 { font-size: 1.15em !important; font-weight: bold !important; margin: 0 0 8px 0 !important; text-align: center !important; }
      #printArea table { width: 100% !important; border-collapse: collapse !important; }
      #printArea th, #printArea td { padding: 2px 0 !important; text-align: left !important; font-size: 1em !important; }
      #printArea th { font-weight: bold !important; border-bottom: 1px solid #000 !important; }
      #printArea td { font-weight: normal !important; }
      #printArea .total-row { font-weight: bold !important; font-size: 1.1em !important; text-align: right !important; }
      #printArea .order-id-row { font-size: 0.95em !important; color: #888 !important; text-align: right !important; }
    }
    #printArea { display: none; }
  </style>
</head>
<body>
  <div class="container" id="authContainer" style="display:none;max-width:340px;">
    <h2>å»šæˆ¿ç™»å…¥</h2>
    <input type="email" id="authEmail" placeholder="Email" style="width:100%;font-size:1.1em;padding:8px;margin-bottom:12px;" />
    <input type="password" id="authPassword" placeholder="å¯†ç¢¼" style="width:100%;font-size:1.1em;padding:8px;margin-bottom:18px;" />
    <button id="authLoginBtn" style="width:100%;padding:12px 0;font-size:1.1em;">ç™»å…¥</button>
    <div id="authMsg" style="color:#b85c38;margin-top:12px;"></div>
  </div>
  <div class="container" id="mainContainer" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>å»šæˆ¿æ¥å–®çœ‹æ¿</h2>
      <div>
        <button id="inventoryBtn" style="background:#9C27B0;color:#fff;padding:6px 12px;border-radius:8px;font-size:0.9em;font-weight:bold;border:none;margin-right:8px;" onclick="goToInventory()">åº«å­˜æ¥­å‹™</button>
        <button id="dailyReportBtn" style="background:#FF9800;color:#fff;padding:6px 12px;border-radius:8px;font-size:0.9em;font-weight:bold;border:none;margin-right:8px;" onclick="goToDailyReport()">æœƒè¨ˆæ¥­å‹™</button>
        <button id="analyticsBtn" style="background:#2196F3;color:#fff;padding:6px 12px;border-radius:8px;font-size:0.9em;font-weight:bold;border:none;margin-right:8px;" onclick="goToAnalytics()">æƒ…å ±åˆ†æ</button>
        <button id="settingsBtn" style="background:#795548;color:#fff;padding:6px 12px;border-radius:8px;font-size:0.9em;font-weight:bold;border:none;margin-right:8px;" onclick="goToSettings()">ç³»çµ±è¨­å®š</button>
        <button id="testSoundBtn" style="background:#4CAF50;color:#fff;padding:6px 12px;border-radius:8px;font-size:0.9em;font-weight:bold;border:none;margin-right:8px;" onclick="testSound()">æ¸¬è©¦éŸ³æ•ˆ</button>
        <button id="stopSoundBtn" style="background:#f44336;color:#fff;padding:6px 12px;border-radius:8px;font-size:0.9em;font-weight:bold;border:none;margin-right:8px;" onclick="stopNotificationSound()">åœæ­¢æé†’éŸ³</button>
        <button id="logoutBtn" style="background:#e0f7fa;color:#b85c38;padding:6px 18px;border-radius:8px;font-size:1em;font-weight:bold;border:none;">ç™»å‡º</button>
      </div>
    </div>
    <div id="ordersList">Onlineé€£ç·šä¸­...</div>
    <div style="color:#888;font-size:0.98em;margin-top:18px;">
      * é»æ“Šã€Œåˆ—å°ã€å¯ç›´æ¥ç”¨æ‰‹æ©Ÿ/å¹³æ¿é€£æ¥çš„å‡ºå–®æ©Ÿåˆ—å°è¨‚å–®<br>
      * é»æ“Šã€ŒğŸ—‘ï¸ åˆªé™¤ã€å¯ç§»é™¤å·²å®Œæˆæˆ–å–æ¶ˆçš„è¨‚å–®
    </div>
  </div>
  <div id="printArea" style="display:none"></div>
  
  <!-- åˆªé™¤ç¢ºèª Modal -->
  <div id="deleteModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:450px;">
      <div class="modal-header">
        <div class="modal-title">ğŸ—‘ï¸ ç¢ºèªåˆªé™¤è¨‚å–®</div>
        <span class="close" onclick="closeDeleteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div style="background:#fff3cd;border:1px solid #ffeaa7;padding:12px;border-radius:8px;margin-bottom:16px;">
          <div style="color:#856404;font-weight:bold;text-align:center;">âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼</div>
        </div>
        <div id="deleteOrderInfo" style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:16px;color:#333;">
          <!-- è¨‚å–®è³‡è¨Šå°‡åœ¨é€™è£¡å‹•æ…‹å¡«å…¥ -->
        </div>
        <div style="color:#666;font-size:0.9em;text-align:center;">
          ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿåˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ã€‚
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn btn-cancel" onclick="closeDeleteModal()">å–æ¶ˆ</button>
        <button class="modal-btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteOrder()">ğŸ—‘ï¸ ç¢ºèªåˆªé™¤</button>
      </div>
    </div>
  </div>
  
  <!-- éŸ³é »å…ƒç´  -->
  <audio id="notificationSound" preload="auto" loop>
    <source src="SystemMessage_warning2.wav" type="audio/wav">
    æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³é »æ’­æ”¾ã€‚
  </audio>
  
  <!-- å¼•å…¥ç†±æ„Ÿæ‡‰å‡ºå–®æ©Ÿå·¥å…·é¡ -->
  <script src="thermal_printer_utils.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import globalSettings from './global_settings.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDSKEpN_xclOhuWOQA7HiMSjsz0lNIHRb4",
      authDomain: "gukediancan.firebaseapp.com",
      projectId: "gukediancan",
      storageBucket: "gukediancan.firebasestorage.app",
      messagingSenderId: "864103354539",
      appId: "1:864103354539:web:26aabd0cc698d7a032e7ee",
      measurementId: "G-EZYMQQ5FGQ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ç›£è½è¨‚å–®
    function renderOrders(orders) {
      const list = document.getElementById('ordersList');
      if (!orders.length) {
        list.innerHTML = '<div style="color:#888">ç›®å‰æ²’æœ‰è¨‚å–®</div>';
        return;
      }
      list.innerHTML = '';
      orders.forEach(order => {
        // è¨ˆç®—ç¸½é‡‘é¡
        let total = 0;
        const itemsHtml = order.items.map(i => {
          const price = i.price || 0;
          const subtotal = price * i.quantity;
          total += subtotal;
          return `<tr><td>${i.name}</td><td style='text-align:right;'>${i.quantity}</td><td style='text-align:right;'>$${subtotal}</td></tr>`;
        }).join('');
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div style="font-size:1.2em;font-weight:bold;color:#b85c38;text-align:center;margin-bottom:10px;">è¨‚å–®ç¢ºèª</div>
          <div style="margin-bottom:8px;"><b>åº—å®¶ï¼š</b>GèŒ¶é¤é…’é¤¨</div>
          <div><b>ç”¨é¤æ–¹å¼ï¼š</b>${order.dineType || ''}</div>
          <div><b>${order.dineType === 'å¤–å¸¶' ? 'å–é¤è™Ÿç¢¼' : 'æ¡Œè™Ÿ'}ï¼š</b>${order.dineType === 'å¤–å¸¶' ? (order.takeoutNumber || '001') : order.tableNumber}</div>
          <div class='modal-list' style="margin:12px 0 18px 0;">
            <table style="width:100%;border-collapse:collapse;">
              <thead><tr><th style="color:#3bb4c1;text-align:left;">å“é …</th><th style="color:#3bb4c1;text-align:right;">æ•¸é‡</th><th style="color:#3bb4c1;text-align:right;">å°è¨ˆ</th></tr></thead>
              <tbody>${itemsHtml}</tbody>
            </table>
          </div>
          <div style="text-align:right;color:#b85c38;font-weight:bold;font-size:1.1em;">ç¸½é‡‘é¡ï¼š$${total}</div>
          <div style="margin-top:10px;">
            <button class="print-btn" onclick="printOrder('${order.id}')">åˆ—å°</button>
            <button class="print-btn" onclick="printThermalOrder('${order.id}')" style="background:#FF9800;margin-left:8px;">ğŸ§¾ å‡ºå–®æ©Ÿ</button>
            <button class="print-btn delete-btn" onclick="deleteOrder('${order.id}')" style="margin-left:8px;">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        `;
        list.appendChild(card);
      });
    }

    // è¨‚å–®è³‡æ–™
    let ordersData = [];
    let knownOrderIds = new Set(); // è¿½è¹¤å·²çŸ¥çš„è¨‚å–®ID
    let notificationAudio = null;
    
    let isFirstLoad = true; // è¿½è¹¤æ˜¯å¦ç‚ºé¦–æ¬¡è¼‰å…¥
    
    function listenOrders() {
      const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
      onSnapshot(q, snapshot => {
        const newOrdersData = [];
        const currentOrderIds = new Set();
        
        snapshot.forEach(docu => {
          const data = docu.data();
          const orderId = docu.id;
          newOrdersData.push({ ...data, id: orderId });
          currentOrderIds.add(orderId);
          
          // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°è¨‚å–®ï¼ˆé¦–æ¬¡è¼‰å…¥æ™‚ä¸æ’­æ”¾éŸ³é »ï¼‰
          if (!isFirstLoad && !knownOrderIds.has(orderId)) {
            console.log('ç™¼ç¾æ–°è¨‚å–®:', orderId);
            playNotificationSound();
          }
        });
        
        // é¦–æ¬¡è¼‰å…¥å¾Œè¨­ç‚ºfalse
        if (isFirstLoad) {
          isFirstLoad = false;
        }
        
        // æ›´æ–°å·²çŸ¥è¨‚å–®ID
        knownOrderIds = currentOrderIds;
        ordersData = newOrdersData;
        renderOrders(ordersData);
      });
    }
    
    // æ’­æ”¾æé†’éŸ³æ•ˆ
    function playNotificationSound() {
      // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨éŸ³æ•ˆ
      if (!globalSettings.isSoundEnabled()) {
        console.log('éŸ³æ•ˆå·²åœç”¨');
        return;
      }
      
      if (!notificationAudio) {
        notificationAudio = document.getElementById('notificationSound');
      }
      
      if (notificationAudio) {
        notificationAudio.currentTime = 0; // é‡ç½®æ’­æ”¾ä½ç½®
        
        // å…ˆå˜—è©¦æ’­æ”¾
        const playPromise = notificationAudio.play();
        
        if (playPromise !== undefined) {
          playPromise.then(() => {
            console.log('éŸ³é »æ’­æ”¾æˆåŠŸ');
          }).catch(e => {
            console.log('éŸ³é »æ’­æ”¾å¤±æ•—:', e);
            // å¦‚æœè‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œé¡¯ç¤ºæç¤º
            showAudioPermissionAlert();
          });
        }
      }
    }
    
    // é¡¯ç¤ºéŸ³é »æ¬Šé™æç¤º
    function showAudioPermissionAlert() {
      if (!document.getElementById('audioAlert')) {
        const alert = document.createElement('div');
        alert.id = 'audioAlert';
        alert.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: #f44336;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 9999;
          font-weight: bold;
          cursor: pointer;
        `;
        alert.innerHTML = 'ğŸ”Š é»æ“Šæ­¤è™•å•Ÿç”¨æ–°è¨‚å–®éŸ³é »æé†’';
        alert.onclick = function() {
          enableAudioAndPlay();
          alert.remove();
        };
        document.body.appendChild(alert);
      }
    }
    
    // å•Ÿç”¨éŸ³é »ä¸¦æ’­æ”¾
    function enableAudioAndPlay() {
      if (notificationAudio) {
        notificationAudio.play().then(() => {
          console.log('éŸ³é »æ¬Šé™å·²å•Ÿç”¨');
        }).catch(e => {
          console.log('éŸ³é »æ¬Šé™å•Ÿç”¨å¤±æ•—:', e);
        });
      }
    }
    
    // åœæ­¢æé†’éŸ³æ•ˆ
    function stopNotificationSound() {
      if (notificationAudio) {
        notificationAudio.pause();
        notificationAudio.currentTime = 0;
      }
    }
    // Firebase Auth åˆå§‹åŒ–
    const auth = getAuth(app);
    const authContainer = document.getElementById('authContainer');
    const mainContainer = document.getElementById('mainContainer');
    const authMsg = document.getElementById('authMsg');
    document.getElementById('authLoginBtn').onclick = async function() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      authMsg.innerText = '';
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        authMsg.innerText = 'ç™»å…¥å¤±æ•—ï¼š' + (e.message || 'è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
      }
    };
    document.getElementById('logoutBtn').onclick = function() {
      signOut(auth);
    };
    onAuthStateChanged(auth, user => {
      if (user) {
        authContainer.style.display = 'none';
        mainContainer.style.display = '';
        
        // åˆå§‹åŒ–å…¨å±€è¨­å®š
        globalSettings.initialize(db).then(() => {
          console.log('å…¨å±€è¨­å®šåˆå§‹åŒ–å®Œæˆ');
          updateUIWithSettings();
          listenOrders();
          
          // åˆå§‹åŒ–éŸ³é »ä¸¦é¡¯ç¤ºæç¤º
          setTimeout(() => {
            initializeAudio();
          }, 1000);
        });
      } else {
        mainContainer.style.display = 'none';
        authContainer.style.display = '';
      }
    });
    
    // æ ¹æ“šå…¨å±€è¨­å®šæ›´æ–°UI
    function updateUIWithSettings() {
      // æ›´æ–°é é¢æ¨™é¡Œä¸­çš„åº—å
      const storeName = globalSettings.getStoreName();
      document.querySelector('h2').textContent = `${storeName} - å»šæˆ¿æ¥å–®çœ‹æ¿`;
      
      // æ ¹æ“šéŸ³æ•ˆè¨­å®šé¡¯ç¤º/éš±è—éŸ³æ•ˆæŒ‰éˆ•
      const soundEnabled = globalSettings.isSoundEnabled();
      const testSoundBtn = document.getElementById('testSoundBtn');
      const stopSoundBtn = document.getElementById('stopSoundBtn');
      
      if (!soundEnabled) {
        testSoundBtn.style.display = 'none';
        stopSoundBtn.style.display = 'none';
      }
      
      // è¨­å®šåˆ·æ–°é–“éš”
      const refreshInterval = globalSettings.getRefreshInterval();
      if (refreshInterval && refreshInterval !== 10) {
        console.log(`ä½¿ç”¨è‡ªè¨‚åˆ·æ–°é–“éš”: ${refreshInterval}ç§’`);
      }
    }

    // åˆå§‹åŒ–éŸ³é »
    function initializeAudio() {
      if (!notificationAudio) {
        notificationAudio = document.getElementById('notificationSound');
      }
      
      // åªæœ‰å•Ÿç”¨éŸ³æ•ˆæ™‚æ‰é¡¯ç¤ºæç¤º
      if (globalSettings.isSoundEnabled()) {
        // é¡¯ç¤ºéŸ³é »æ¬Šé™æç¤º
        const audioTip = document.createElement('div');
        audioTip.style.cssText = `
          background: #2196F3;
          color: white;
          padding: 10px;
          border-radius: 8px;
          margin-bottom: 15px;
          text-align: center;
          font-size: 0.9em;
        `;
        audioTip.innerHTML = 'ğŸ’¡ æé†’ï¼šè«‹é»æ“Šã€Œæ¸¬è©¦éŸ³æ•ˆã€æŒ‰éˆ•ç¢ºä¿æ–°è¨‚å–®æé†’éŸ³æ­£å¸¸å·¥ä½œ';
        
        const ordersList = document.getElementById('ordersList');
        ordersList.parentNode.insertBefore(audioTip, ordersList);
        
        // 8ç§’å¾Œè‡ªå‹•éš±è—æç¤º
        setTimeout(() => {
          audioTip.remove();
        }, 8000);
      }
    }

    // æ¸¬è©¦éŸ³æ•ˆåŠŸèƒ½
    function testSound() {
      if (!notificationAudio) {
        notificationAudio = document.getElementById('notificationSound');
      }
      
      if (notificationAudio) {
        notificationAudio.currentTime = 0;
        notificationAudio.play().then(() => {
          console.log('æ¸¬è©¦éŸ³æ•ˆæ’­æ”¾æˆåŠŸ');
          // 3ç§’å¾Œè‡ªå‹•åœæ­¢æ¸¬è©¦éŸ³æ•ˆ
          setTimeout(() => {
            notificationAudio.pause();
            notificationAudio.currentTime = 0;
          }, 3000);
        }).catch(e => {
          console.log('æ¸¬è©¦éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e);
          alert('éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ï¼š\n1. éŸ³é »æª”æ¡ˆæ˜¯å¦å­˜åœ¨\n2. ç€è¦½å™¨æ˜¯å¦å…è¨±éŸ³é »æ’­æ”¾\n3. éŸ³é‡æ˜¯å¦é–‹å•Ÿ');
        });
      }
    }
    
    // è·³è½‰åˆ°åº«å­˜ç®¡ç†é é¢
    function goToInventory() {
      window.open('inventory_management.html', '_blank');
    }

    // è·³è½‰åˆ°æ—¥çµå¸³é é¢
    function goToDailyReport() {
      window.open('daily_report.html', '_blank');
    }

    // è·³è½‰åˆ°æƒ…å ±åˆ†æé é¢
    function goToAnalytics() {
      window.open('analytics.html', '_blank');
    }

    // è·³è½‰åˆ°ç³»çµ±è¨­å®šé é¢
    function goToSettings() {
      window.open('system_settings.html', '_blank');
    }

    // è¦åˆªé™¤çš„è¨‚å–® ID
    let orderToDelete = null;

    // åˆªé™¤è¨‚å–®åŠŸèƒ½ - é¡¯ç¤ºç¢ºèª modal
    window.deleteOrder = function(orderId) {
      // åœæ­¢éŸ³é »æ’­æ”¾
      stopNotificationSound();
      
      const order = ordersData.find(o => o.id === orderId);
      if (!order) {
        alert('æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™');
        return;
      }

      // å„²å­˜è¦åˆªé™¤çš„è¨‚å–® ID
      orderToDelete = orderId;
      
      // æº–å‚™è¨‚å–®è³‡è¨Š
      const orderInfo = order.dineType === 'å¤–å¸¶' ? 
        `å–é¤è™Ÿç¢¼: ${order.takeoutNumber || '001'}` : 
        `æ¡Œè™Ÿ: ${order.tableNumber}`;
      
      // è¨ˆç®—ç¸½é‡‘é¡
      let totalAmount = 0;
      order.items?.forEach(item => {
        totalAmount += (item.price || 0) * item.quantity;
      });

      // å¡«å…¥è¨‚å–®è³‡è¨Šåˆ° modal
      const deleteOrderInfo = document.getElementById('deleteOrderInfo');
      deleteOrderInfo.innerHTML = `
        <div style="margin-bottom:12px;">
          <strong style="color:#b85c38;font-size:1.1em;">${orderInfo}</strong>
        </div>
        <div style="margin-bottom:8px;">
          <span style="color:#666;">è¨‚å–®ç·¨è™Ÿï¼š</span>
          <span style="color:#333;">${order.orderId || order.id}</span>
        </div>
        <div style="margin-bottom:12px;">
          <span style="color:#666;">ç¸½é‡‘é¡ï¼š</span>
          <span style="color:#b85c38;font-weight:bold;font-size:1.1em;">$${totalAmount}</span>
        </div>
        <div style="margin-bottom:8px;color:#666;font-size:0.9em;">é¤é»æ˜ç´°ï¼š</div>
        <div style="max-height:120px;overflow-y:auto;">
          ${order.items?.map(item => 
            `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #ddd;">
              <span style="color:#333;">${item.name}</span>
              <span style="color:#b85c38;">${item.quantity} Ã— $${item.price || 0}</span>
            </div>`
          ).join('') || '<div style="color:#999;">ç„¡é¤é»è³‡æ–™</div>'}
        </div>
      `;
      
      // é‡ç½®ç¢ºèªæŒ‰éˆ•ç‹€æ…‹
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = 'ğŸ—‘ï¸ ç¢ºèªåˆªé™¤';
      
      // é¡¯ç¤º modal
      document.getElementById('deleteModal').style.display = 'block';
    };

    // é—œé–‰åˆªé™¤ç¢ºèª modal
    window.closeDeleteModal = function() {
      document.getElementById('deleteModal').style.display = 'none';
      orderToDelete = null;
    };

    // é»æ“Š modal èƒŒæ™¯é—œé–‰
    document.getElementById('deleteModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDeleteModal();
      }
    });

    // ESC éµé—œé–‰ modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('deleteModal').style.display === 'block') {
        closeDeleteModal();
      }
    });

    // ç¢ºèªåˆªé™¤è¨‚å–®
    window.confirmDeleteOrder = async function() {
      if (!orderToDelete) return;
      
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      confirmBtn.disabled = true;
      confirmBtn.innerHTML = 'åˆªé™¤ä¸­...';
      
      try {
        const order = ordersData.find(o => o.id === orderToDelete);
        const orderInfo = order.dineType === 'å¤–å¸¶' ? 
          `å–é¤è™Ÿç¢¼: ${order.takeoutNumber || '001'}` : 
          `æ¡Œè™Ÿ: ${order.tableNumber}`;
        
        // å¾ Firebase åˆªé™¤è¨‚å–®
        await deleteDoc(doc(db, "orders", orderToDelete));
        
        // é—œé–‰ modal
        closeDeleteModal();
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        showDeleteSuccessMessage(orderInfo);
        
        console.log('è¨‚å–®å·²åˆªé™¤:', orderToDelete);
      } catch (error) {
        console.error('åˆªé™¤è¨‚å–®å¤±æ•—:', error);
        alert('åˆªé™¤è¨‚å–®å¤±æ•—ï¼Œè«‹é‡è©¦');
        
        // é‡ç½®æŒ‰éˆ•
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = 'ğŸ—‘ï¸ ç¢ºèªåˆªé™¤';
      }
    };

    // é¡¯ç¤ºåˆªé™¤æˆåŠŸè¨Šæ¯
    function showDeleteSuccessMessage(orderInfo) {
      const message = document.createElement('div');
      message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 9999;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-size: 1em;
      `;
      message.innerHTML = `âœ… è¨‚å–®å·²åˆªé™¤<br><small>${orderInfo}</small>`;
      document.body.appendChild(message);
      
      // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
      setTimeout(() => {
        if (message.parentElement) {
          message.remove();
        }
      }, 3000);
    }

    // å…¨åŸŸå‡½æ•¸
    window.stopNotificationSound = stopNotificationSound;
    window.testSound = testSound;
    window.goToInventory = goToInventory;
    window.goToDailyReport = goToDailyReport;
    window.goToAnalytics = goToAnalytics;
    window.goToSettings = goToSettings;
    
    // åˆ—å°åŠŸèƒ½
    window.printOrder = function(orderId) {
      // åœæ­¢éŸ³é »æ’­æ”¾
      stopNotificationSound();
      
      const order = ordersData.find(o => o.id === orderId);
      if (!order) {
        alert('æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™');
        return;
      }

      // è¨ˆç®—ç¸½é‡‘é¡
      let total = 0;
      const itemsHtml = order.items.map(i => {
        const price = i.price || 0;
        const subtotal = price * i.quantity;
        total += subtotal;
        return `<tr><td>${i.name}</td><td style='text-align:right;'>${i.quantity}</td><td style='text-align:right;'>$${subtotal}</td></tr>`;
      }).join('');

      // ç”¢ç”Ÿåˆ—å°å…§å®¹
      const printContent = `
        <h2>GèŒ¶é¤é…’é¤¨</h2>
        <div style="margin-bottom:8px;"><b>ç”¨é¤æ–¹å¼ï¼š</b>${order.dineType || ''}</div>
        <div style="margin-bottom:8px;"><b>${order.dineType === 'å¤–å¸¶' ? 'å–é¤è™Ÿç¢¼' : 'æ¡Œè™Ÿ'}ï¼š</b>${order.dineType === 'å¤–å¸¶' ? (order.takeoutNumber || '001') : order.tableNumber}</div>
        <table style="width:100%;border-collapse:collapse;margin:8px 0;">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:1px solid #000;">å“é …</th>
              <th style="text-align:right;border-bottom:1px solid #000;">æ•¸é‡</th>
              <th style="text-align:right;border-bottom:1px solid #000;">å°è¨ˆ</th>
            </tr>
          </thead>
          <tbody>${itemsHtml}</tbody>
        </table>
        <div class="total-row">ç¸½é‡‘é¡ï¼š$${total}</div>
        <div class="order-id-row">è¨‚å–®ç·¨è™Ÿï¼š${order.orderId || order.id}</div>
      `;

      // è¨­å®šåˆ—å°å€åŸŸ
      const printArea = document.getElementById('printArea');
      printArea.innerHTML = printContent;

      // åˆ—å°
      window.print();
    };

    // ç†±æ„Ÿæ‡‰å‡ºå–®æ©Ÿåˆ—å°åŠŸèƒ½
    window.printThermalOrder = function(orderId) {
      // åœæ­¢éŸ³é »æ’­æ”¾
      stopNotificationSound();
      
      const order = ordersData.find(o => o.id === orderId);
      if (!order) {
        alert('æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™');
        return;
      }

      // ç²å–åˆ—å°è¨­å®š
      const printSettings = globalSettings.getPrintSettings();
      const storeName = globalSettings.getStoreName();
      
      // æª¢æŸ¥æ˜¯å¦æœ‰å·¥å…·é¡
      if (typeof ThermalPrinterUtils === 'undefined') {
        console.error('ThermalPrinterUtils æœªè¼‰å…¥ï¼Œä½¿ç”¨é è¨­æ ¼å¼');
        // å›é€€åˆ°åŸæœ‰é‚è¼¯
        printThermalOrderFallback(order, printSettings, storeName);
        return;
      }

      // ä½¿ç”¨æ–°çš„å·¥å…·é¡è™•ç†å­—ç¬¦ç·¨ç¢¼
      const printerEncoding = printSettings.printerEncoding || 'ascii';
      
      // ç”Ÿæˆç·¨ç¢¼è½‰æ›å¾Œçš„HTMLå…§å®¹
      const finalThermalContent = ThermalPrinterUtils.generateHTMLPreview(order, {
        printerWidth: printSettings.printerWidth || 80,
        fontSize: printSettings.printFontSize || 14,
        storeName: storeName,
        encoding: printerEncoding
      });

      // å‰µå»ºé è¦½è¦–çª—
      const printerWidth = printSettings.printerWidth || 80;
      const printWindow = window.open('', '_blank', 'width=500,height=800');
      const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>è¨‚å–®åˆ—å°é è¦½ - ${printerEncoding.toUpperCase()}ç·¨ç¢¼</title>
          <style>
            @media print {
              body { margin: 0; padding: 0; }
              @page { size: ${printerWidth}mm auto; margin: 0; }
              .print-controls { display: none !important; }
            }
            body { 
              font-family: monospace; 
              margin: 0; 
              padding: 10px; 
              background: #f5f5f5;
            }
            .print-controls {
              background: #3bb4c1;
              color: white;
              padding: 10px;
              text-align: center;
              margin-bottom: 10px;
              border-radius: 8px;
            }
            .print-controls button {
              background: white;
              color: #3bb4c1;
              border: none;
              padding: 8px 16px;
              margin: 0 5px;
              border-radius: 6px;
              cursor: pointer;
              font-weight: bold;
            }
            .print-controls button:hover {
              background: #f0f0f0;
            }
            .preview-container {
              background: white;
              border: 2px dashed #ccc;
              margin: 0 auto;
              max-width: ${printerWidth}mm;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .encoding-info {
              background: #fff3cd;
              border: 1px solid #ffeaa7;
              padding: 8px;
              margin-bottom: 10px;
              border-radius: 6px;
              font-size: 0.9em;
              text-align: center;
              color: #856404;
            }
          </style>
        </head>
        <body>
          <div class="print-controls">
            <h3>ğŸ§¾ è¨‚å–®å‡ºå–®æ©Ÿé è¦½ (${printerWidth}mm)</h3>
            <div class="encoding-info">å­—ç¬¦ç·¨ç¢¼: ${printerEncoding.toUpperCase()}</div>
            <button onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
            <button onclick="window.close()">âŒ é—œé–‰</button>
          </div>
          <div class="preview-container">
            ${finalThermalContent}
          </div>
        </body>
        </html>
      `;
      printWindow.document.write(printHTML);
      printWindow.document.close();
    };

    // å›é€€å‡½æ•¸ï¼ˆç•¶å·¥å…·é¡æœªè¼‰å…¥æ™‚ä½¿ç”¨ï¼‰
    function printThermalOrderFallback(order, printSettings, storeName) {
      console.warn('ä½¿ç”¨å›é€€åˆ—å°æ¨¡å¼');
      // é€™è£¡å¯ä»¥ä¿ç•™åŸæœ‰çš„åˆ—å°é‚è¼¯ä½œç‚ºå‚™ç”¨
      alert('åˆ—å°åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹æª¢æŸ¥ç³»çµ±è¨­å®š');
    }
  </script>
</body>
</html> 